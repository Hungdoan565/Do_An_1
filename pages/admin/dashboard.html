<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản trị Admin - Món Ngon Việt Nam</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      body {
        background: #ede7f6;
        font-family: "Be Vietnam Pro", sans-serif;
      }
      .sidebar {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        min-height: 90vh;
        padding: 2rem 1rem 2rem 1.5rem;
      }
      .sidebar .nav-link {
        color: #333;
        font-weight: 500;
        border-radius: 8px;
        margin-bottom: 8px;
        transition: background 0.2s;
      }
      .sidebar .nav-link.active,
      .sidebar .nav-link:hover {
        background: #d61c4e;
        color: #fff;
      }
      .sidebar .nav-link i {
        width: 22px;
        text-align: center;
      }
      .sidebar .nav-link {
        cursor: pointer;
      }
      .sidebar .nav-link.disabled {
        pointer-events: none;
        opacity: 0.6;
      }
      .admin-header {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        padding: 1.5rem 2rem;
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .admin-header .admin-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      .admin-header .avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #d61c4e;
      }
      .stat-card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        padding: 1.5rem 1.2rem;
        text-align: center;
        margin-bottom: 1.5rem;
      }
      .stat-card .stat-title {
        font-size: 1rem;
        color: #888;
      }
      .stat-card .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #d61c4e;
      }
      .admin-section {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        padding: 2rem;
        margin-top: 2rem;
      }
      .table-actions button {
        margin-right: 6px;
      }
      .tab-section {
        display: none;
      }
      .tab-section.active {
        display: block;
        animation: fadeIn 0.4s;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: none;
        }
      }
      @media (max-width: 991px) {
        .sidebar {
          min-height: unset;
          margin-bottom: 1.5rem;
        }
      }
      @media (max-width: 767px) {
        .admin-header {
          flex-direction: column;
          gap: 1rem;
          padding: 1rem;
        }
        .stat-card {
          padding: 1rem 0.5rem;
        }
        .admin-section {
          padding: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div
          class="col-lg-2 col-md-3 sidebar d-flex flex-column align-items-start"
        >
          <h4 class="fw-bold mb-4">
            <i class="fas fa-cogs me-2"></i>Admin Panel
          </h4>
          <nav class="nav flex-column w-100">
            <a class="nav-link active" data-tab="dashboard"
              ><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a
            >
            <a class="nav-link" data-tab="users"
              ><i class="fas fa-users me-2"></i>Người dùng</a
            >
            <a class="nav-link" data-tab="duyet-bai"
              ><i class="fas fa-file-alt me-2"></i>Duyệt Blog</a
            >
            <a class="nav-link" data-tab="duyet-cong-thuc"
              ><i class="fas fa-utensils me-2"></i>Duyệt Công Thức</a
            >
            <a class="nav-link" data-tab="stats"
              ><i class="fas fa-chart-bar me-2"></i>Thống kê</a
            >
            <a class="nav-link" data-tab="settings"
              ><i class="fas fa-cog me-2"></i>Cài đặt</a
            >
          </nav>
        </div>
        <!-- Main Content -->
        <div class="col-lg-10 col-md-9 px-4">
          <div class="admin-header mb-4">
            <div class="admin-info">
              <div class="avatar"><i class="fas fa-user-circle"></i></div>
              <div>
                <div class="fw-bold" id="adminName">Admin</div>
                <div class="text-muted" style="font-size: 0.95rem">
                  Quản trị viên
                </div>
              </div>
            </div>
            <button class="btn btn-outline-danger" id="logoutBtn">
              <i class="fas fa-sign-out-alt"></i> Đăng xuất
            </button>
          </div>
          <!-- Dashboard Tab -->
          <div class="tab-section active" id="tab-dashboard">
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="stat-card">
                  <div class="stat-title">Người dùng</div>
                  <div class="stat-value" id="statUsers">0</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card">
                  <div class="stat-title">Bài viết đã duyệt</div>
                  <div class="stat-value" id="statBlogs">0</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card">
                  <div class="stat-title">Bài chờ duyệt</div>
                  <div class="stat-value" id="statPending">0</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card">
                  <div class="stat-title">Thống kê khác</div>
                  <div class="stat-value">-</div>
                </div>
              </div>
            </div>
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="stat-card">
                  <div class="stat-title">Công thức đã duyệt</div>
                  <div class="stat-value" id="statRecipeApproved">0</div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card">
                  <div class="stat-title">Công thức chờ duyệt</div>
                  <div class="stat-value" id="statRecipePending">0</div>
                </div>
              </div>
            </div>
          </div>
          <!-- Người dùng Tab -->
          <div class="tab-section" id="tab-users">
            <div class="admin-section">
              <h4 class="mb-4">Quản lý Người dùng</h4>
              <div
                class="mb-3 d-flex justify-content-between align-items-center"
              >
                <input
                  type="text"
                  class="form-control w-50"
                  id="userSearch"
                  placeholder="Tìm kiếm tên người dùng..."
                />
                <span id="userCount" class="text-muted"></span>
              </div>
              <div class="table-responsive">
                <table class="table table-bordered table-striped align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>#</th>
                      <th>Tên đăng nhập</th>
                      <th>Email</th>
                      <th>Vai trò</th>
                      <th>Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="userTable"></tbody>
                </table>
              </div>
            </div>
          </div>
          <!-- Duyệt bài Tab -->
          <div class="tab-section" id="tab-duyet-bai">
            <div class="admin-section mb-5">
              <h4 class="mb-4">Bài Blog Chờ Duyệt</h4>
              <div class="table-responsive">
                <table class="table table-bordered table-striped align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>#</th>
                      <th>Tiêu đề</th>
                      <th>Tác giả</th>
                      <th>Ngày đăng</th>
                      <th>Trạng thái</th>
                      <th>Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="pendingBlogTable"></tbody>
                </table>
              </div>
            </div>
            <div class="admin-section">
              <h4 class="mb-4">Bài Blog Đã Duyệt</h4>
              <div class="table-responsive">
                <table class="table table-bordered table-striped align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>#</th>
                      <th>Tiêu đề</th>
                      <th>Tác giả</th>
                      <th>Ngày đăng</th>
                      <th>Trạng thái</th>
                      <th>Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="approvedBlogTable"></tbody>
                </table>
              </div>
            </div>
          </div>
          <!-- Duyệt Công Thức Tab -->
          <div class="tab-section" id="tab-duyet-cong-thuc">
            <div class="admin-section mb-5">
              <h4 class="mb-4">Công Thức Chờ Duyệt</h4>
              <div class="table-responsive">
                <table class="table table-bordered table-striped align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>#</th>
                      <th>Tên món</th>
                      <th>Tác giả</th>
                      <th>Ngày đăng</th>
                      <th>Trạng thái</th>
                      <th>Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="pendingRecipeTable"></tbody>
                </table>
              </div>
            </div>
            <div class="admin-section">
              <h4 class="mb-4">Công Thức Đã Duyệt</h4>
              <div class="table-responsive">
                <table class="table table-bordered table-striped align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>#</th>
                      <th>Tên món</th>
                      <th>Tác giả</th>
                      <th>Ngày đăng</th>
                      <th>Trạng thái</th>
                      <th>Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="approvedRecipeTable"></tbody>
                </table>
              </div>
            </div>
          </div>
          <!-- Thống kê Tab -->
          <div class="tab-section" id="tab-stats">
            <div class="admin-section">
              <h4 class="mb-4">Thống kê hệ thống</h4>
              <div class="row">
                <div class="col-md-6 mb-4">
                  <canvas id="blogStatusChart" height="220"></canvas>
                </div>
                <div class="col-md-6 mb-4">
                  <canvas id="userMonthChart" height="220"></canvas>
                </div>
              </div>
            </div>
          </div>
          <!-- Cài đặt Tab -->
          <div class="tab-section" id="tab-settings">
            <div class="admin-section">
               <ul class="nav nav-pills mb-4" id="settingsSubTabs">
                <li class="nav-item">
                  <a class="nav-link active" data-subtab="notification" href="#"
                    >Thông báo</a
                  >
                </li>
                <li class="nav-item">
                  <a class="nav-link" data-subtab="config" href="#">Cấu hình</a>
                </li>
                 <li class="nav-item">
                  <a class="nav-link" data-subtab="categories" href="#"
                    >Danh mục & Tags</a
                  >
                </li>
              </ul>
              <div
                class="settings-subtab-section"
                id="settings-subtab-notification"
              >
                <h5 class="mb-3">Quản lý thông báo hệ thống</h5>
                <form id="addNotificationForm" class="mb-4">
                  <div class="mb-3">
                    <label class="form-label">Nội dung thông báo</label>
                    <input
                      type="text"
                      class="form-control"
                      id="notificationContent"
                      required
                      maxlength="200"
                      placeholder="Nhập nội dung thông báo..."
                    />
                  </div>
                  <button type="submit" class="btn btn-primary">
                    Thêm thông báo
                  </button>
                </form>
                <h6 class="mb-3">Danh sách thông báo</h6>
                <div id="notificationList"></div>
              </div>
              <div
                class="settings-subtab-section"
                id="settings-subtab-config"
                style="display: none"
              >
                <h5 class="mb-3">Cấu hình hệ thống</h5>
                <form id="systemConfigForm" class="mb-4">
                  <div class="mb-3">
                    <label class="form-label">Số lượng blog/trang</label>
                    <input
                      type="number"
                      class="form-control"
                      id="configBlogPerPage"
                      min="1"
                      max="50"
                      value="10"
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Số lượng công thức/trang</label>
                    <input
                      type="number"
                      class="form-control"
                      id="configRecipePerPage"
                      min="1"
                      max="50"
                      value="12"
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Cho phép đăng blog</label>
                    <select class="form-select" id="configAllowBlog">
                      <option value="true">Bật</option>
                      <option value="false">Tắt</option>
                    </select>
                  </div>
                  <button type="submit" class="btn btn-success">
                    Lưu cấu hình
                  </button>
                  <span id="systemConfigStatus" class="ms-3"></span>
                </form>
              </div>
              <div
                class="settings-subtab-section"
                id="settings-subtab-categories"
                style="display: none"
              >
                <h5 class="mb-3">Quản lý Danh mục & Tags</h5>
                <div class="row g-4">
                  <div class="col-md-6">
                    <div class="card shadow-sm rounded">
                      <div class="card-body">
                        <h6 class="fw-bold mb-3">Danh mục món ăn</h6>
                        <div id="categoryList"></div>
                        <form id="addCategoryForm" class="d-flex mt-2">
                          <input
                            type="text"
                            class="form-control me-2"
                            id="newCategoryInput"
                            placeholder="Thêm danh mục..."
                            required
                          />
                          <button type="submit" class="btn btn-primary">
                            Thêm
                          </button>
                        </form>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="card shadow-sm rounded">
                      <div class="card-body">
                        <h6 class="fw-bold mb-3">Tags Blog</h6>
                        <div id="tagList"></div>
                        <form id="addTagForm" class="d-flex mt-2">
                          <input
                            type="text"
                            class="form-control me-2"
                            id="newTagInput"
                            placeholder="Thêm tag blog..."
                            required
                          />
                          <button type="submit" class="btn btn-primary">
                            Thêm
                          </button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="/assets/js/auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="/assets/js/firebase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Sidebar tab switching
      document.querySelectorAll(".sidebar .nav-link").forEach(function (link) {
        link.addEventListener("click", function () {
          document
            .querySelectorAll(".sidebar .nav-link")
            .forEach((l) => l.classList.remove("active"));
          this.classList.add("active");
          const tab = this.getAttribute("data-tab");
          document
            .querySelectorAll(".tab-section")
            .forEach((sec) => sec.classList.remove("active"));
          document.getElementById("tab-" + tab).classList.add("active");
          if (tab === "duyet-cong-thuc") {
            renderRecipeApproval();
          }
          // Thêm dòng này để load thông báo khi vào tab Cài đặt
          if (tab === "settings") {
            renderNotifications();
          }
        });
      });
      // Kiểm tra quyền admin
      const user = window.getCurrentUser && window.getCurrentUser();
      if (!user || user.role !== "admin") {
        window.location.href =
          "/pages/auth/login.html?redirect=/pages/admin/dashboard.html";
      } else {
        document.getElementById("adminName").textContent = user.username;
      }
      document.getElementById("logoutBtn").onclick = function () {
        window.logoutUser && window.logoutUser();
        window.location.href = "/index.html";
      };
      // Thống kê và duyệt bài
      function renderStatsAndPendingBlogs() {
        var db = firebase.database();
        // Thống kê blog
        db.ref("blogs")
          .once("value")
          .then(function (snapshot) {
            const blogs = snapshot.val() || {};
            const all = Object.values(blogs);
            const approved = all.filter((b) => b.status === "đã duyệt");
            const pending = all.filter((b) => b.status === "chờ duyệt");
            document.getElementById("statBlogs").textContent = approved.length;
            document.getElementById("statPending").textContent = pending.length;
            // Render bảng bài chờ duyệt
            const tbody = document.getElementById("pendingBlogTable");
            tbody.innerHTML = pending.length
              ? pending
                  .map(
                    (b, i) => `
            <tr>
              <td>${i + 1}</td>
              <td>${b.title}</td>
              <td>${b.author}</td>
              <td>${b.date}</td>
              <td><span class="badge bg-warning text-dark">Chờ duyệt</span></td>
              <td class="table-actions">
                <button class="btn btn-success btn-sm" onclick="approveBlog('${
                  b.id
                }')"><i class="fas fa-check"></i> Duyệt</button>
                <button class="btn btn-danger btn-sm" onclick="rejectBlog('${
                  b.id
                }')"><i class="fas fa-times"></i> Từ chối</button>
                <a class="btn btn-info btn-sm" href='/pages/blog-detail.html?id=${
                  b.id
                }' target='_blank'><i class="fas fa-eye"></i> Xem</a>
              </td>
            </tr>
          `
                  )
                  .join("")
              : '<tr><td colspan="6" class="text-center">Không có bài chờ duyệt</td></tr>';
            // Render bảng bài đã duyệt
            const tbody2 = document.getElementById("approvedBlogTable");
            tbody2.innerHTML = approved.length
              ? approved
                  .map(
                    (b, i) => `
            <tr>
              <td>${i + 1}</td>
              <td>${b.title}</td>
              <td>${b.author}</td>
              <td>${b.date}</td>
              <td><span class="badge bg-success">Đã duyệt</span></td>
              <td class="table-actions">
                <button class="btn btn-danger btn-sm" onclick="deleteApprovedBlog('${
                  b.id
                }')"><i class="fas fa-trash"></i> Xóa</button>
                <a class="btn btn-info btn-sm" href='/pages/blog-detail.html?id=${
                  b.id
                }' target='_blank'><i class="fas fa-eye"></i> Xem</a>
              </td>
            </tr>
          `
                  )
                  .join("")
              : '<tr><td colspan="6" class="text-center">Không có bài đã duyệt</td></tr>';
            // Thống kê công thức
            db.ref("recipes")
              .once("value")
              .then(function (snapshot2) {
                const recipes = snapshot2.val() || {};
                const allRecipes = Object.values(recipes);
                const approvedRecipes = allRecipes.filter(
                  (r) => r.pending === false
                );
                const pendingRecipes = allRecipes.filter(
                  (r) => r.pending !== false
                );
                document.getElementById("statRecipeApproved").textContent =
                  approvedRecipes.length;
                document.getElementById("statRecipePending").textContent =
                  pendingRecipes.length;
                // Cập nhật biểu đồ trạng thái blog + công thức
                updateBlogAndRecipeStatusChart(
                  approved.length,
                  pending.length,
                  approvedRecipes.length,
                  pendingRecipes.length
                );
              });
          });
        // Thống kê user
        let users = JSON.parse(localStorage.getItem("users") || "[]");
        document.getElementById("statUsers").textContent = users.length;
        renderUserTable(users);
        updateUserMonthChart(users);
      }
      // Duyệt bài
      window.approveBlog = function (id) {
        var db = firebase.database();
        db.ref("blogs/" + id)
          .update({ status: "đã duyệt" })
          .then(function () {
            alert("Duyệt bài thành công!");
            renderStatsAndPendingBlogs();
          });
      };
      // Từ chối bài
      window.rejectBlog = function (id) {
        if (!confirm("Bạn chắc chắn muốn từ chối/xóa bài này?")) return;
        var db = firebase.database();
        db.ref("blogs/" + id)
          .remove()
          .then(renderStatsAndPendingBlogs);
      };
      // Xóa bài đã duyệt
      window.deleteApprovedBlog = function (id) {
        if (!confirm("Bạn chắc chắn muốn xóa bài đã duyệt này?")) return;
        var db = firebase.database();
        db.ref("blogs/" + id)
          .remove()
          .then(renderStatsAndPendingBlogs);
      };
      // Quản lý user
      function renderUserTable(users) {
        const search = document
          .getElementById("userSearch")
          .value.trim()
          .toLowerCase();
        const filtered = users.filter((u) =>
          u.username.toLowerCase().includes(search)
        );
        document.getElementById(
          "userCount"
        ).textContent = `Tổng: ${filtered.length}`;
        document.getElementById("userTable").innerHTML = filtered.length
          ? filtered
              .map(
                (u, i) => `
          <tr>
            <td>${i + 1}</td>
            <td>${u.username}</td>
            <td>${u.email || "-"}</td>
            <td><span class="badge ${
              u.role === "admin" ? "bg-danger" : "bg-secondary"
            }">${u.role}</span></td>
            <td>
              ${
                u.role !== "admin"
                  ? `<button class="btn btn-danger btn-sm" onclick="deleteUser('${u.username}')"><i class="fas fa-trash"></i> Xóa</button>`
                  : '<span class="text-muted">-</span>'
              }
            </td>
          </tr>
        `
              )
              .join("")
          : '<tr><td colspan="5" class="text-center">Không có người dùng</td></tr>';
      }
      document
        .getElementById("userSearch")
        .addEventListener("input", function () {
          let users = JSON.parse(localStorage.getItem("users") || "[]");
          renderUserTable(users);
        });
      window.deleteUser = function (username) {
        if (!confirm("Bạn chắc chắn muốn xóa user này?")) return;
        let users = JSON.parse(localStorage.getItem("users") || "[]");
        users = users.filter((u) => u.username !== username);
        localStorage.setItem("users", JSON.stringify(users));
        renderUserTable(users);
        renderStatsAndPendingBlogs();
      };
      // Biểu đồ thống kê
      let blogStatusChart, userMonthChart;
      function updateBlogStatusChart(approved, pending, rejected) {
        const ctx = document.getElementById("blogStatusChart").getContext("2d");
        if (blogStatusChart) blogStatusChart.destroy();
        blogStatusChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["Đã duyệt", "Chờ duyệt", "Khác"],
            datasets: [
              {
                data: [approved, pending, rejected],
                backgroundColor: ["#d61c4e", "#ffc107", "#8884d8"],
              },
            ],
          },
          options: {
            plugins: { legend: { position: "bottom" } },
            cutout: "65%",
            responsive: true,
          },
        });
      }
      function updateBlogAndRecipeStatusChart(
        blogApproved,
        blogPending,
        recipeApproved,
        recipePending
      ) {
        const ctx = document.getElementById("blogStatusChart").getContext("2d");
        if (blogStatusChart) blogStatusChart.destroy();
        blogStatusChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: [
              "Blog đã duyệt",
              "Blog chờ duyệt",
              "Công thức đã duyệt",
              "Công thức chờ duyệt",
            ],
            datasets: [
              {
                data: [
                  blogApproved,
                  blogPending,
                  recipeApproved,
                  recipePending,
                ],
                backgroundColor: ["#d61c4e", "#ffc107", "#8884d8", "#4bc0c0"],
              },
            ],
          },
          options: {
            plugins: { legend: { position: "bottom" } },
            cutout: "65%",
            responsive: true,
          },
        });
      }
      function updateUserMonthChart(users) {
        // Loại bỏ admin
        const filteredUsers = users.filter((u) => u.role !== "admin");
        const months = [
          "01",
          "02",
          "03",
          "04",
          "05",
          "06",
          "07",
          "08",
          "09",
          "10",
          "11",
          "12",
        ];
        const now = new Date();
        const year = now.getFullYear();
        // Đếm user mới theo từng tháng
        const data = months.map(
          (m) =>
            filteredUsers.filter((u) => {
              let dateStr = "";
              if (typeof u.createdAt === "number") {
                const d = new Date(u.createdAt);
                dateStr = `${d.getFullYear()}-${String(
                  d.getMonth() + 1
                ).padStart(2, "0")}`;
              } else if (typeof u.createdAt === "string") {
                dateStr = u.createdAt;
              }
              return dateStr.startsWith(`${year}-${m}`);
            }).length
        );
        const ctx = document.getElementById("userMonthChart").getContext("2d");
        if (userMonthChart) userMonthChart.destroy();
        userMonthChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: months.map((m) => `${year}-${m}`),
            datasets: [
              {
                label: "User mới",
                data: data,
                backgroundColor: months.map((m) => "#d61c4e"),
              },
            ],
          },
          options: {
            plugins: { legend: { position: "bottom" } },
            responsive: true,
            scales: {
              x: { title: { display: true, text: "Tháng" } },
              y: {
                title: { display: true, text: "Số user mới" },
                beginAtZero: true,
                precision: 0,
              },
            },
          },
        });
      }
      renderStatsAndPendingBlogs();
      renderRecipeApproval();
      // Thêm tab Duyệt Công Thức vào sidebar
      const sidebarNav = document.querySelector(".sidebar nav");
      if (
        sidebarNav &&
        !document.querySelector('[data-tab="duyet-cong-thuc"]')
      ) {
        const recipeTab = document.createElement("a");
        recipeTab.className = "nav-link";
        recipeTab.setAttribute("data-tab", "duyet-cong-thuc");
        recipeTab.innerHTML =
          '<i class="fas fa-utensils me-2"></i>Duyệt Công Thức';
        sidebarNav.insertBefore(recipeTab, sidebarNav.children[3]); // sau Duyệt bài
      }
      // Tab switching cho tab mới
      document.querySelectorAll(".sidebar .nav-link").forEach(function (link) {
        link.addEventListener("click", function () {
          document
            .querySelectorAll(".sidebar .nav-link")
            .forEach((l) => l.classList.remove("active"));
          this.classList.add("active");
          const tab = this.getAttribute("data-tab");
          document
            .querySelectorAll(".tab-section")
            .forEach((sec) => sec.classList.remove("active"));
          document.getElementById("tab-" + tab).classList.add("active");
          if (tab === "duyet-cong-thuc") {
            renderRecipeApproval();
          }
        });
      });
      // Render công thức chờ duyệt/đã duyệt
      function renderRecipeApproval() {
        if (typeof firebase === "undefined" || !firebase.database) {
          console.error("Firebase chưa được khởi tạo hoặc không tồn tại!");
          return;
        }
        var db = firebase.database();
        db.ref("recipes")
          .once("value")
          .then(function (snapshot) {
            const recipesObj = snapshot.val() || {};
            const recipes = Object.entries(recipesObj).map(([id, r]) => ({
              id,
              ...r,
            }));
            const pending = recipes.filter((r) => r.pending !== false);
            const approved = recipes.filter((r) => r.pending === false);
            // Bảng chờ duyệt
            const tbody = document.getElementById("pendingRecipeTable");
            const thead = tbody.parentElement.querySelector("thead");
            if (thead && !thead.innerHTML.trim()) {
              thead.innerHTML = `<tr><th>#</th><th>Tên món</th><th>Tác giả</th><th>Ngày đăng</th><th>Trạng thái</th><th>Hành động</th></tr>`;
            }
            tbody.innerHTML = pending.length
              ? pending
                  .map(
                    (r, i) => `
<tr>
  <td>${i + 1}</td>
  <td>${r.title}</td>
  <td>${
    typeof r.author === "object" && r.author !== null
      ? r.author.username || r.author.name || JSON.stringify(r.author)
      : r.author || "-"
  }</td>
  <td>${r.createdAt ? new Date(r.createdAt).toLocaleDateString() : "-"}</td>
  <td><span class="badge bg-warning text-dark">Chờ duyệt</span></td>
  <td class="table-actions">
    <button class="btn btn-success btn-sm" onclick="approveRecipe('${
      r.id
    }')"><i class="fas fa-check"></i> Duyệt</button>
    <button class="btn btn-danger btn-sm" onclick="deleteRecipe('${
      r.id
    }')"><i class="fas fa-trash"></i> Xóa</button>
    <button class="btn btn-info btn-sm" onclick="viewRecipeDetail('${
      r.id
    }')"><i class="fas fa-eye"></i> Xem</button>
  </td>
</tr>
`
                  )
                  .join("")
              : '<tr><td colspan="6" class="text-center">Không có công thức chờ duyệt</td></tr>';
            // Bảng đã duyệt
            const tbody2 = document.getElementById("approvedRecipeTable");
            const thead2 = tbody2.parentElement.querySelector("thead");
            if (thead2 && !thead2.innerHTML.trim()) {
              thead2.innerHTML = `<tr><th>#</th><th>Tên món</th><th>Tác giả</th><th>Ngày đăng</th><th>Trạng thái</th><th>Hành động</th></tr>`;
            }
            tbody2.innerHTML = approved.length
              ? approved
                  .map(
                    (r, i) => `
<tr>
  <td>${i + 1}</td>
  <td>${r.title}</td>
  <td>${
    typeof r.author === "object" && r.author !== null
      ? r.author.username || r.author.name || JSON.stringify(r.author)
      : r.author || "-"
  }</td>
  <td>${r.createdAt ? new Date(r.createdAt).toLocaleDateString() : "-"}</td>
  <td><span class="badge bg-success">Đã duyệt</span></td>
  <td class="table-actions">
    <button class="btn btn-danger btn-sm" onclick="deleteRecipe('${
      r.id
    }')"><i class="fas fa-trash"></i> Xóa</button>
    <button class="btn btn-info btn-sm" onclick="viewRecipeDetail('${
      r.id
    }')"><i class="fas fa-eye"></i> Xem</button>
  </td>
</tr>
`
                  )
                  .join("")
              : '<tr><td colspan="6" class="text-center">Không có công thức đã duyệt</td></tr>';
          })
          .catch(function (err) {
            console.error("Lỗi lấy dữ liệu công thức:", err);
          });
      }
      // Duyệt công thức
      window.approveRecipe = function (id) {
        var db = firebase.database();
        db.ref("recipes/" + id)
          .update({ pending: false })
          .then(function () {
            alert("Duyệt công thức thành công!");
            renderRecipeApproval();
          });
      };
      // Xóa công thức
      window.deleteRecipe = function (id) {
        if (!confirm("Bạn chắc chắn muốn xóa công thức này?")) return;
        var db = firebase.database();
        db.ref("recipes/" + id)
          .remove()
          .then(renderRecipeApproval);
      };
      // Xem chi tiết công thức (modal đơn giản)
      window.viewRecipeDetail = function (id) {
        var db = firebase.database();
        db.ref("recipes/" + id)
          .once("value")
          .then(function (snapshot) {
            const r = snapshot.val();
            if (!r) {
              alert("Không tìm thấy dữ liệu công thức!");
              return;
            }
            // Lấy tên người đăng
            let author = "-";
            if (typeof r.author === "object" && r.author !== null) {
              author =
                r.author.username || r.author.name || JSON.stringify(r.author);
            } else if (typeof r.author === "string") {
              author = r.author;
            }
            // Hiển thị nguyên liệu
            let ingredientsHtml = "-";
            if (Array.isArray(r.ingredients) && r.ingredients.length) {
              ingredientsHtml = r.ingredients
                .map((i) => {
                  if (typeof i === "object" && i !== null) {
                    // Ưu tiên name + amount
                    if (i.name && i.amount)
                      return `<li>${i.name} (${i.amount})</li>`;
                    if (i.name) return `<li>${i.name}</li>`;
                    return `<li>${Object.values(i).join(" - ")}</li>`;
                  }
                  return `<li>${i}</li>`;
                })
                .join("");
            } else if (typeof r.ingredients === "string") {
              ingredientsHtml = r.ingredients;
            }
            // Hiển thị bước làm
            let stepsHtml = "-";
            if (Array.isArray(r.steps) && r.steps.length) {
              stepsHtml = r.steps
                .map((s, i) => {
                  if (typeof s === "object" && s !== null) {
                    // Ưu tiên desc hoặc content
                    if (s.desc) return `<li>Bước ${i + 1}: ${s.desc}</li>`;
                    if (s.content)
                      return `<li>Bước ${i + 1}: ${s.content}</li>`;
                    return `<li>Bước ${i + 1}: ${Object.values(s).join(
                      " - "
                    )}</li>`;
                  }
                  return `<li>Bước ${i + 1}: ${s}</li>`;
                })
                .join("");
            } else if (typeof r.steps === "string") {
              stepsHtml = r.steps;
            }
            // Render nội dung modal
            let html = `
              <h5 class="modal-title">${r.title || "Chi tiết công thức"}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            `;
            document.querySelector(
              "#recipeDetailModal .modal-header"
            ).innerHTML = html;
            let bodyHtml = `
              <div><b>Tên món:</b> ${r.title || "-"}</div>
              <div><b>Người đăng:</b> ${author}</div>
              <div><b>Ngày đăng:</b> ${
                r.createdAt ? new Date(r.createdAt).toLocaleDateString() : "-"
              }</div>
              <div><b>Trạng thái:</b> <span class="badge ${
                r.pending === false ? "bg-success" : "bg-warning text-dark"
              }">${r.pending === false ? "Đã duyệt" : "Chờ duyệt"}</span></div>
              <div class="mt-2"><b>Mô tả:</b> <div>${
                r.description || "-"
              }</div></div>
              <div class="mt-2"><b>Nguyên liệu:</b> <ul>${ingredientsHtml}</ul></div>
              <div class="mt-2"><b>Cách làm:</b> <ol>${stepsHtml}</ol></div>
              ${
                r.imageUrl
                  ? `<div class='mt-2'><img src='${r.imageUrl}' alt='${
                      r.title || ""
                    }' style='max-width:100%;border-radius:8px;'/></div>`
                  : r.image
                  ? `<div class='mt-2'><img src='${r.image}' alt='${
                      r.title || ""
                    }' style='max-width:100%;border-radius:8px;'/></div>`
                  : ""
              }
            `;
            document.querySelector("#recipeDetailModal .modal-body").innerHTML =
              bodyHtml;
            // Show modal bằng Bootstrap 5
            var modal = new bootstrap.Modal(
              document.getElementById("recipeDetailModal")
            );
            modal.show();
          })
          .catch(function (err) {
            alert("Lỗi lấy dữ liệu công thức: " + err.message);
          });
      };
       // Thêm thông báo
      document.getElementById("addNotificationForm").onsubmit = function (e) {
        e.preventDefault();
        const content = document
          .getElementById("notificationContent")
          .value.trim();
        if (!content) return;
        var db = firebase.database();
        var newRef = db.ref("system_notifications").push();
        newRef.set(
          { content, createdAt: Date.now(), isActive: true },
          function () {
            document.getElementById("notificationContent").value = "";
            renderNotifications();
          }
        );
      };
      // Quản lý thông báo hệ thống
      function renderNotifications() {
        var db = firebase.database();
        db.ref("system_notifications")
          .once("value")
          .then(function (snapshot) {
            const notifs = snapshot.val() || {};
            const notifArr = Object.entries(notifs).map(([id, n]) => ({
              id,
              ...n,
            }));
            const listDiv = document.getElementById("notificationList");
            if (!notifArr.length) {
              listDiv.innerHTML =
                '<div class="text-muted">Chưa có thông báo nào.</div>';
              return;
            }
            listDiv.innerHTML = `<ul class='list-group'>${notifArr
              .map(
                (n) => `
                  <li class='list-group-item d-flex justify-content-between align-items-center'>
                    <span>${n.content}</span>
                    <div>
                      <button class='btn btn-sm btn-outline-secondary me-2' onclick='editNotification("${
                        n.id
                      }", "${encodeURIComponent(n.content)}")'>Sửa</button>
                      <button class='btn btn-sm btn-outline-danger' onclick='deleteNotification("${
                        n.id
                      }")'>Xóa</button>
                    </div>
                  </li>`
              )
              .join("")}</ul>`;
          });
      }
      // Sửa thông báo
      window.editNotification = function (id, oldContent) {
        // Hiển thị modal nhập nội dung mới
        let modal = document.getElementById("editNotificationModal");
        if (!modal) {
          modal = document.createElement("div");
          modal.id = "editNotificationModal";
          modal.className = "modal fade";
          modal.tabIndex = -1;
          modal.innerHTML = `
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Sửa thông báo</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                  <input type="text" class="form-control" id="editNotificationInput" maxlength="200" />
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" id="saveEditNotificationBtn">Lưu</button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                </div>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        }
        setTimeout(function () {
          document.getElementById("editNotificationInput").value =
            decodeURIComponent(oldContent);
          var bsModal = new bootstrap.Modal(modal);
          bsModal.show();
          document.getElementById("saveEditNotificationBtn").onclick =
            function () {
              const newContent = document
                .getElementById("editNotificationInput")
                .value.trim();
              if (!newContent) return alert("Nội dung không được để trống!");
              var db = firebase.database();
              db.ref("system_notifications/" + id).update(
                { content: newContent, createdAt: Date.now() },
                function () {
                  bsModal.hide();
                  renderNotifications();
                }
              );
            };
        }, 100);
      };
      // Xóa thông báo
      window.deleteNotification = function (id) {
        if (!confirm("Bạn có chắc chắn muốn xóa thông báo này?")) return;
        var db = firebase.database();
        db.ref("system_notifications/" + id).remove(function () {
          renderNotifications();
        });
      };
      // Tab con cho Cài đặt
      const settingsSubTabs = document.querySelectorAll(
        "#settingsSubTabs .nav-link"
      );
      const subTabSections = document.querySelectorAll(
        ".settings-subtab-section"
      );
      settingsSubTabs.forEach(function (tab) {
        tab.addEventListener("click", function (e) {
          e.preventDefault();
          settingsSubTabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          const subtab = tab.getAttribute("data-subtab");
          subTabSections.forEach((sec) => (sec.style.display = "none"));
          document.getElementById("settings-subtab-" + subtab).style.display =
            "block";
          if (subtab === "notification") renderNotifications();
          if (subtab === "config") loadSystemConfig();
        });
      });
      // Hàm load cấu hình hệ thống
      function loadSystemConfig() {
        var db = firebase.database();
        db.ref("blog_config")
          .once("value")
          .then(function (snapshot) {
            const config = snapshot.val() || {};
            document.getElementById("configBlogPerPage").value =
              config.blogPerPage || 10;
            document.getElementById("configRecipePerPage").value =
              config.recipePerPage || 12;
            document.getElementById("configAllowBlog").value = String(
              config.allowBlog !== false
            );
          });
      }
      // Lưu cấu hình hệ thống
      document.getElementById("systemConfigForm").onsubmit = function (e) {
        e.preventDefault();
        var db = firebase.database();
        const blogPerPage =
          parseInt(document.getElementById("configBlogPerPage").value) || 10;
        const recipePerPage =
          parseInt(document.getElementById("configRecipePerPage").value) || 12;
        const allowBlog =
          document.getElementById("configAllowBlog").value === "true";
        db.ref("blog_config").set(
          { blogPerPage, recipePerPage, allowBlog },
          function (err) {
            const statusDiv = document.getElementById("systemConfigStatus");
            if (err) {
              statusDiv.textContent = "Lưu cấu hình thất bại!";
              statusDiv.className = "text-danger";
            } else {
              statusDiv.textContent = "Đã lưu cấu hình!";
              statusDiv.className = "text-success";
            }
            setTimeout(function () {
              statusDiv.textContent = "";
            }, 2500);
          }
        );
      };

       // --- ĐỒNG BỘ DANH MỤC & TAGS ---
      function renderCategoryList() {
        var db = firebase.database();
        db.ref("categories")
          .once("value")
          .then(function (snapshot) {
            const categories = snapshot.val() || {};
            const categoryListDiv = document.getElementById("categoryList");
            categoryListDiv.innerHTML = "";
            if (!Object.keys(categories).length) {
              categoryListDiv.innerHTML =
                '<div class="text-muted">Chưa có danh mục nào.</div>';
              return;
            }
            Object.entries(categories).forEach(([id, cat]) => {
              const isActive = cat.active !== false;
              const div = document.createElement("div");
              div.className =
                "d-flex justify-content-between align-items-center mb-2";
              div.innerHTML = `
                <div><strong class="${isActive ? "" : "text-muted"}">${
                cat.name
              }${!isActive ? " (Đã ẩn)" : ""}</strong></div>
                <div>
                  <button class="btn btn-sm btn-${
                    isActive ? "warning" : "success"
                  }" onclick="toggleCategoryActive('${id}', ${!isActive})">
                    ${
                      isActive
                        ? "<i class='fas fa-eye-slash'></i> Ẩn"
                        : "<i class='fas fa-eye'></i> Hiện"
                    }
                  </button>
                </div>
              `;
              categoryListDiv.appendChild(div);
            });
          });
      }
      window.toggleCategoryActive = function (id, active) {
        var db = firebase.database();
        db.ref("categories/" + id)
          .update({ active: active })
          .then(renderCategoryList);
      };
      document.getElementById("addCategoryForm").onsubmit = function (e) {
        e.preventDefault();
        const newCategory = document
          .getElementById("newCategoryInput")
          .value.trim();
        if (!newCategory) return;
        var db = firebase.database();
        var newCategoryRef = db.ref("categories").push();
        newCategoryRef.set(
          { name: newCategory, active: true, createdAt: Date.now() },
          function () {
            document.getElementById("newCategoryInput").value = "";
            renderCategoryList();
          }
        );
      };
      function renderTagList() {
        var db = firebase.database();
        db.ref("tags_blog")
          .once("value")
          .then(function (snapshot) {
            const tags = snapshot.val() || {};
            const tagListDiv = document.getElementById("tagList");
            tagListDiv.innerHTML = "";
            if (!Object.keys(tags).length) {
              tagListDiv.innerHTML =
                '<div class="text-muted">Chưa có tag nào.</div>';
              return;
            }
            Object.entries(tags).forEach(([id, tag]) => {
              const div = document.createElement("div");
              div.className =
                "d-flex justify-content-between align-items-center mb-2";
              div.innerHTML = `
                <div><strong>${tag.name}</strong></div>
                <div><button class="btn btn-sm btn-danger" onclick="deleteTag('${id}')"><i class="fas fa-trash"></i> Xóa</button></div>
              `;
              tagListDiv.appendChild(div);
            });
          });
      }
      window.deleteTag = function (id) {
        if (!confirm("Bạn có chắc chắn muốn xóa tag này?")) return;
        var db = firebase.database();
        db.ref("tags_blog/" + id)
          .remove()
          .then(renderTagList);
      };
      document.getElementById("addTagForm").onsubmit = function (e) {
        e.preventDefault();
        const newTag = document.getElementById("newTagInput").value.trim();
        if (!newTag) return;
        var db = firebase.database();
        var newTagRef = db.ref("tags_blog").push();
        newTagRef.set({ name: newTag, createdAt: Date.now() }, function () {
          document.getElementById("newTagInput").value = "";
          renderTagList();
        });
      };
    
      // Khi vào tab, tự động load danh sách
      function loadCategoriesAndTags() {
        renderCategoryList();
        renderTagList();
      }
      document
        .querySelector('[data-subtab="categories"]')
        .addEventListener("click", loadCategoriesAndTags);
    </script>
    <!-- Modal xem chi tiết công thức -->
    <div
      class="modal fade"
      id="recipeDetailModal"
      tabindex="-1"
      aria-labelledby="recipeDetailModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <!-- Tiêu đề modal sẽ được render bằng JS -->
          </div>
          <div class="modal-body">
            <!-- Nội dung chi tiết công thức sẽ được render bằng JS -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Bootstrap JS cho modal -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
