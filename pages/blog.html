<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blog - Món Ngon Việt Nam</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/assets/css/pages/blog.css" />
    <link rel="stylesheet" href="/assets/css/pages/list.css" />
    <style>
      @media (max-width: 600px) {
        .search-box {
          max-width: 100% !important;
          padding-left: 12px !important;
          padding-right: 12px !important;
        }
        .search-input-custom {
          min-width: 0 !important;
          font-size: 1rem !important;
        }
        .search-box form {
          gap: 8px !important;
        }
      }
    </style>
  </head>

  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top">
      <div class="container">
        <a class="navbar-brand" href="/index.html"> Món Ngon Việt Nam </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item">
              <a class="nav-link" href="../index.html">Trang chủ</a>
            </li>
            <!-- Dropdown Công thức -->
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarRecipeDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Công thức
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarRecipeDropdown">
                <li>
                  <a class="dropdown-item" href="../recipes/list.html">
                    <i class="fas fa-list-ul"></i> Danh sách công thức
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="/pages/user/add-recipe.html">
                    <i class="fas fa-plus-circle"></i> Thêm công thức mới
                  </a>
                </li>
              </ul>
            </li>
            <!-- Dropdown Blog -->
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarBlogDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Blog
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarBlogDropdown">
                <li>
                  <a class="dropdown-item" href="../blog.html">
                    <i class="fas fa-book-open"></i> Danh sách blog
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="/pages/add-blog.html">
                    <i class="fas fa-pen-nib"></i> Thêm blog mới
                  </a>
                </li>
              </ul>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/pages/about.html">Về chúng tôi</a>
            </li>
            <li class="nav-item ms-3">
              <a
                class="btn btn-outline-primary px-4 py-2 ms-2"
                href="/pages/auth/login.html"
                id="loginBtn"
              >
                Đăng nhập
              </a>
              <a
                class="btn btn-primary px-4 py-2 ms-2"
                href="/pages/auth/register.html"
                id="registerBtn"
              >
                Đăng ký
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Banner thông báo hệ thống chuyên nghiệp (import dùng chung) -->
    <div
      id="systemNotificationBar"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 9999;
        text-align: center;
        padding: 12px 0;
        background: rgba(255, 85, 85, 0.7);
        color: #fff;
        font-weight: 600;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: transform 0.5s, opacity 0.5s;
      "
    >
      <span id="systemNotificationText" style="font-size: 1.1em"></span>
      <button
        id="closeNotificationBar"
        style="
          position: absolute;
          right: 18px;
          top: 8px;
          background: none;
          border: none;
          color: #fff;
          font-size: 1.3em;
          cursor: pointer;
        "
      >
        &times;
      </button>
    </div>
    <!-- Import notification-bar.js dùng chung cho banner thông báo -->
    <script src="/assets/js/notification-bar.js"></script>

    <!-- Page Header (Hero) -->
    <header
      class="page-header position-relative"
      style="background: none; padding: 0; margin-top: 76px"
    >
      <div class="d-flex justify-content-center w-100" style="background: none">
        <div
          class="blog-hero-img-wrapper d-flex flex-column justify-content-center align-items-center position-relative"
          style="
            max-width: 1295px;
            width: 100%;
            min-height: 320px;
            height: 340px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 32px rgba(0, 0, 0, 0.08);
          "
        >
          <!-- Carousel Hero Images -->
          <div
            id="blogHeroCarousel"
            class="carousel slide w-100 h-100 position-absolute top-0 start-0"
            data-bs-ride="carousel"
            data-bs-interval="2700"
            style="z-index: 1"
          >
            <div class="carousel-inner w-100 h-100">
              <div class="carousel-item active w-100 h-100">
                <img
                  src="/assets/images/blog/nau-pho.jpg"
                  class="d-block w-100 h-100 blog-hero-img"
                  alt="Blog Hero 1"
                  style="object-fit: cover; filter: brightness(0.7)"
                />
              </div>
              <div class="carousel-item w-100 h-100">
                <img
                  src="/assets/images/blog/top5.jpg"
                  class="d-block w-100 h-100 blog-hero-img"
                  alt="Blog Hero 2"
                  style="object-fit: cover; filter: brightness(0.7)"
                />
              </div>
              <div class="carousel-item w-100 h-100">
                <img
                  src="/assets/images/blog/banh-trung-thu.jpg"
                  class="d-block w-100 h-100 blog-hero-img"
                  alt="Blog Hero 3"
                  style="object-fit: cover; filter: brightness(0.7)"
                />
              </div>
            </div>
          </div>
          <div
            class="blog-hero-overlay position-absolute top-0 start-0 w-100 h-100"
            style="
              background: linear-gradient(
                120deg,
                rgba(218, 94, 127, 0.55),
                rgba(247, 126, 33, 0.45)
              );
              z-index: 2;
            "
          ></div>
          <div
            class="container position-relative text-center d-flex flex-column justify-content-center align-items-center"
            style="z-index: 3"
          >
            <h1
              class="display-4 fw-bold mb-3 text-white"
              style="text-shadow: 0 2px 16px rgba(0, 0, 0, 0.25)"
            >
              Blog Ẩm Thực
            </h1>
            <p
              class="lead mb-4 text-white"
              style="
                font-size: 1.2rem;
                text-shadow: 0 2px 8px rgba(0, 0, 0, 0.18);
              "
            >
              <i
                class="fas fa-book-open me-2 text-white"
                style="font-size: 1.5em"
              ></i
              >Khám phá văn hóa ẩm thực Việt Nam qua những câu chuyện thú vị, bí
              quyết bếp núc và trải nghiệm cá nhân từ cộng đồng yêu bếp.
            </p>
            <div class="d-flex flex-wrap justify-content-center gap-3 mb-4">
              <a
                href="/pages/add-blog.html"
                class="btn btn-outline-light px-4 py-2 fw-semibold shadow-sm"
              >
                <i class="fas fa-pen-nib me-2 text-dark"></i>Đăng bài blog
              </a>
              <a
                href="#popularPosts"
                class="btn btn-outline-light px-4 py-2 fw-semibold shadow-sm"
              >
                <i class="fas fa-star me-2 text-warning"></i>Xem bài nổi bật
              </a>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="container">
      <div class="row">
        <!-- Blog Posts -->
        <div class="col-lg-8">
          <!-- Search Box (Redesigned) -->
          <div
            class="search-box mb-4 w-100"
            style="max-width: 580px; margin: 0 auto 1.5rem auto"
          >
            <form
              class="d-flex flex-column flex-md-row align-items-stretch gap-2"
              onsubmit="event.preventDefault(); filterAndSearchPosts();"
            >
              <div class="position-relative flex-grow-1" style="min-width: 0">
                <input
                  type="text"
                  class="form-control search-input-custom"
                  placeholder="Tìm kiếm bài viết..."
                  id="searchInput"
                  autocomplete="off"
                  style="
                    padding-left: 44px;
                    height: 48px;
                    border-radius: 14px;
                    background: #fff;
                    border: 1.5px solid #e9647a;
                    font-size: 1.08rem;
                    box-shadow: 0 2px 12px rgba(233, 100, 122, 0.06);
                    min-width: 360px;
                    width: 100%;
                  "
                />
                <span
                  class="search-icon position-absolute top-50 start-0 translate-middle-y ps-3"
                  style="color: #e9647a; font-size: 1.2em; pointer-events: none"
                >
                  <i class="fas fa-search"></i>
                </span>
                <!-- Autocomplete dropdown -->
                <div
                  id="searchAutocomplete"
                  class="autocomplete-dropdown bg-white border rounded shadow-sm"
                  style="
                    position: absolute;
                    z-index: 1000;
                    top: 100%;
                    left: 0;
                    width: 100%;
                    display: none;
                  "
                ></div>
              </div>
              <button
                type="submit"
                class="btn search-btn-custom d-flex align-items-center justify-content-center fw-bold"
                style="
                  height: 48px;
                  min-width: 100px;
                  border-radius: 14px;
                  background: var(--primary-color);
                  color: #fff;
                  font-size: 1.08rem;
                  border: none;
                  box-shadow: 0 2px 12px 0 rgba(233, 100, 122, 0.1);
                  transition: background 0.18s;
                "
              >
                <i class="fas fa-search me-2"></i>Tìm kiếm
              </button>
            </form>
          </div>
          <div
            id="tagCheckboxGroup"
            class="d-flex flex-wrap align-items-center gap-2 mb-3"
            style="margin-left: 2px"
          ></div>
          <div
            class="mb-3 d-flex align-items-center gap-2"
            id="authorFilterRow"
          >
            <label for="authorFilter" class="mb-0 fw-semibold">Tác giả:</label>
            <select
              id="authorFilter"
              class="form-select w-auto rounded-3 text-center"
              style="min-width: 160px"
            >
              <option value="">Tất cả tác giả</option>
            </select>
          </div>
          <!-- Sort Dropdown -->
          <div
            class="sort-section d-flex justify-content-end align-items-center my-3"
          >
            <label for="sortSelect" class="me-2 fw-semibold"
              >Sắp xếp theo:</label
            >
            <select
              id="sortSelect"
              class="form-select w-auto rounded-3 text-center"
              style="
                min-width: 140px;
                height: 44px;
                background: #fff;
                border: 1px solid #e0e0e0;
                font-size: 1rem;
              "
            >
              <option value="">Mặc định</option>
              <option value="newest">Mới nhất</option>
              <option value="views">Lượt xem nhiều nhất</option>
            </select>
          </div>

          <!-- Blog Posts Grid -->
          <div class="row" id="blogPosts">
            <!-- Blog posts will be inserted here by JavaScript -->
          </div>

          <!-- Pagination -->
          <nav
            aria-label="Page navigation"
            class="d-flex justify-content-center mt-4 mb-5"
          >
            <ul class="pagination">
              <li class="page-item">
                <a class="page-link" href="#" aria-label="Previous">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
              <li class="page-item active">
                <a class="page-link" href="#">1</a>
              </li>
              <li class="page-item"><a class="page-link" href="#">2</a></li>
              <li class="page-item"><a class="page-link" href="#">3</a></li>
              <li class="page-item">
                <a class="page-link" href="#" aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
            </ul>
          </nav>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
          <div class="sidebar">
            <!-- Categories -->
            <div class="sidebar-card">
              <h4 class="sidebar-title">Danh Mục</h4>
              <div class="category-list">
                <a
                  href="/pages/recipes/list.html?category=mon-chinh"
                  class="category-item"
                >
                  <span>Món Chính</span>
                  <span class="badge bg-primary">24</span>
                </a>
                <a
                  href="/pages/recipes/list.html?category=mon-trang-mieng"
                  class="category-item"
                >
                  <span>Món Tráng Miệng</span>
                  <span class="badge bg-primary">18</span>
                </a>
                <a
                  href="/pages/recipes/list.html?category=do-uong"
                  class="category-item"
                >
                  <span>Đồ Uống</span>
                  <span class="badge bg-primary">12</span>
                </a>
                <a
                  href="/pages/recipes/list.html?category=mon-chay"
                  class="category-item"
                >
                  <span>Món Chay</span>
                  <span class="badge bg-primary">15</span>
                </a>
                <a
                  href="/pages/recipes/list.html?category=khai-vi"
                  class="category-item"
                >
                  <span>Món Khai Vị</span>
                  <span class="badge bg-primary">30</span>
                </a>
              </div>
            </div>

            <!-- Popular Posts -->
            <div class="sidebar-card">
              <h4 class="sidebar-title">
                <i class="fas fa-fire text-danger me-2"></i>Bài Viết Nổi Bật
              </h4>
              <div id="popularPosts">
                <!-- Popular posts will be inserted here by JavaScript -->
              </div>
            </div>

            <!-- Đăng Bài Blog Button -->
            <div class="sidebar-card">
              <a
                href="/pages/add-blog.html"
                class="btn btn-success w-100 mb-3 fw-bold"
              >
                <i class="fas fa-pen-nib me-2"></i>Đăng bài blog
              </a>
            </div>
          </div>
        </div>
      </div>
      <!-- Sidebar Toggle Button & Overlay for mobile -->
      <button
        class="sidebar-toggle-btn"
        id="sidebarToggleBtn"
        aria-label="Mở danh mục"
        style="display: none"
      >
        <i class="fas fa-bars"></i>
      </button>
      <div class="sidebar-overlay" id="sidebarOverlay"></div>
    </div>

    <!-- Footer -->
    <footer
      class="footer mt-5 py-5"
      style="
        background: linear-gradient(
          45deg,
          var(--primary-color),
          var(--secondary-color)
        );
      "
    >
      <div class="container">
        <div class="row g-4">
          <div class="col-lg-4">
            <h5 class="mb-3 fw-bold text-white">Về Chúng Tôi</h5>
            <p class="mb-4 text-white">
              Món Ngon Việt Nam là cộng đồng chia sẻ công thức nấu ăn lớn nhất
              Việt Nam, nơi kết nối những người đam mê ẩm thực.
            </p>
            <div class="social-links d-flex gap-3">
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-facebook-f"></i
              ></a>
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-instagram"></i
              ></a>
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-youtube"></i
              ></a>
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-tiktok"></i
              ></a>
            </div>
          </div>
          <div class="col-lg-2">
            <h5 class="mb-3 fw-bold text-white">Khám Phá</h5>
            <ul class="list-unstyled">
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html"
                  class="text-white text-decoration-none"
                  >Công thức</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/blog.html"
                  class="text-white text-decoration-none"
                  >Blog</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/about.html"
                  class="text-white text-decoration-none"
                  >Về chúng tôi</a
                >
              </li>
              <li class="mb-2">
                <a href="#" class="text-white text-decoration-none">Liên hệ</a>
              </li>
            </ul>
          </div>
          <div class="col-lg-3">
            <h5 class="mb-3 fw-bold text-white">Danh Mục</h5>
            <ul class="list-unstyled">
              <li class="mb-2">
                <a
                  href="recipes/list.html?category=mon-chinh"
                  class="text-white text-decoration-none"
                  >Món chính</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="recipes/list.html?category=trang-mieng"
                  class="text-white text-decoration-none"
                  >Món tráng miệng</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="recipes/list.html?category=thuc-uong"
                  class="text-white text-decoration-none"
                  >Đồ uống</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="recipes/list.html?category=mon-chay"
                  class="text-white text-decoration-none"
                  >Món chay</a
                >
              </li>
            </ul>
          </div>
          <div class="col-lg-3">
            <h5 class="mb-3 fw-bold text-white">Liên Hệ</h5>
            <ul class="list-unstyled text-white">
              <li class="mb-2">
                <i class="fas fa-envelope me-2"></i> lienhe@monngon.vn
              </li>
              <li class="mb-2">
                <i class="fas fa-phone me-2"></i> 0123.456.789
              </li>
              <li class="mb-2">
                <i class="fas fa-map-marker-alt me-2"></i> Hà Nội, Việt Nam
              </li>
            </ul>
          </div>
        </div>
        <hr class="my-4 bg-white" />
        <div class="text-center text-white">
          <p class="mb-0">© 2024 Món Ngon Việt Nam. Đã đăng ký bản quyền.</p>
        </div>
      </div>
    </footer>

    <!-- Modal thông báo chặn đăng blog -->
    <div
      class="modal fade"
      id="addBlogBlockedModal"
      tabindex="-1"
      aria-labelledby="addBlogBlockedLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addBlogBlockedLabel">
              Không thể đăng blog
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Đóng"
            ></button>
          </div>
          <div class="modal-body">
            <div class="text-danger fw-bold">
              Admin đã tắt chức năng đăng blog. Vui lòng thử lại sau!
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="/assets/js/firebase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/navbar-user.js"></script>
    <script src="/assets/data/recipes_MonChinh.js"></script>
    <script src="/assets/data/recipes_TrangMieng.js"></script>
    <script src="/assets/data/recipes_ThucUong.js"></script>
    <script src="/assets/data/recipes_AnChay.js"></script>
    <script src="/assets/data/recipes_AnVat.js"></script>
    <script src="/assets/data/recipes_KhaiVi.js"></script>
    <script>
      // Initialize AOS
      AOS.init({
        duration: 800,
        once: true,
      });

      let BLOG_PAGE_SIZE = 4; // Khai báo duy nhất ở đầu file
      fetchData("blog_config", function (config) {
        BLOG_PAGE_SIZE =
          config && config.blogPerPage ? parseInt(config.blogPerPage) : 4;
        // Nếu đã có danh sách blog, render lại theo page size mới
        if (allApprovedPosts && allApprovedPosts.length) {
          renderBlogPosts(allApprovedPosts, blogCurrentPage);
          renderBlogPagination(allApprovedPosts.length, blogCurrentPage);
        }
      });

      let blogCurrentPage = 1;
      let blogFilteredPosts = [];
      let currentSort = "newest"; // Mặc định sort mới nhất

      // Lấy dữ liệu blog động từ file JSON
      let allApprovedPosts = [];
      function renderBlogPosts(posts, page = 1) {
        blogFilteredPosts = posts;
        const start = (page - 1) * BLOG_PAGE_SIZE;
        const end = start + BLOG_PAGE_SIZE;
        const pagePosts = posts.slice(start, end);
        document.getElementById("blogPosts").innerHTML = pagePosts
          .map(
            (post) => `
  <div class="col-md-6 mb-4" data-aos="fade-up">
    <a href="/pages/blog-detail.html?id=${
      post.id
    }" class="blog-card d-block" data-id="${post.id}">
      <img src="${post.image}" class="blog-image w-100" alt="${
              post.title
            }" loading="lazy" />
      <div class="blog-content">
        <h3 class="blog-title" style="font-weight:700; transition:color 0.18s;">${
          post.title
        }</h3>
        <div class="blog-meta">
          <span><i class="fas fa-user"></i> ${post.author}</span>
          <span><i class="far fa-calendar"></i> ${post.date}</span>
          <span><i class="far fa-clock"></i> ${post.readTime}</span>
          <span><i class="fas fa-eye"></i> ${post.views || 0}</span>
        </div>
        <p class="blog-excerpt">${post.excerpt}</p>
        <div class="blog-tags">
          ${(post.tags || [])
            .map((tag) => `<span class="blog-tag">${tag}</span>`)
            .join("")}
        </div>
      </div>
    </a>
  </div>
`
          )
          .join("");
        renderBlogPagination(posts.length, page);
      }

      function renderBlogPagination(totalPosts, currentPage) {
        const totalPages = Math.ceil(totalPosts / BLOG_PAGE_SIZE);
        const pagination = document.querySelector(".pagination");
        if (!pagination) return;
        let html = "";
        const maxPagesToShow = 5;
        if (totalPages <= 7) {
          for (let i = 1; i <= totalPages; i++) {
            html += `<li class="page-item${
              i === currentPage ? " active" : ""
            }"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
          }
        } else {
          html += `<li class="page-item${
            currentPage === 1 ? " active" : ""
          }"><a class="page-link" href="#" data-page="1">1</a></li>`;
          if (currentPage > maxPagesToShow) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
          }
          let start = Math.max(2, currentPage - 2);
          let end = Math.min(totalPages - 1, currentPage + 2);
          if (currentPage <= maxPagesToShow) {
            end = Math.max(end, maxPagesToShow);
          }
          if (currentPage >= totalPages - maxPagesToShow + 1) {
            start = Math.min(start, totalPages - maxPagesToShow);
          }
          for (let i = start; i <= end; i++) {
            html += `<li class="page-item${
              i === currentPage ? " active" : ""
            }"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
          }
          if (currentPage < totalPages - maxPagesToShow + 1) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
          }
          html += `<li class="page-item${
            currentPage === totalPages ? " active" : ""
          }"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
        }
        pagination.innerHTML = html;
        pagination.querySelectorAll("a.page-link").forEach((link) => {
          link.onclick = function (e) {
            e.preventDefault();
            const page = this.getAttribute("data-page");
            if (!isNaN(Number(page))) {
              blogCurrentPage = Number(page);
              renderBlogPosts(blogFilteredPosts, blogCurrentPage);
            }
          };
        });
      }

      // Render popular posts (bài viết nổi bật)
      function renderPopularPosts(posts) {
        // Sắp xếp theo lượt xem (nếu có), nếu không thì lấy mới nhất
        let sorted = posts.slice();
        if (sorted.length && sorted[0].hasOwnProperty("views")) {
          sorted.sort((a, b) => (b.views || 0) - (a.views || 0));
        } else {
          sorted.sort((a, b) => new Date(b.date) - new Date(a.date));
        }
        const topPosts = sorted.slice(0, 4);
        const html = topPosts
          .map(
            (post) => `
      <a href="/pages/blog-detail.html?id=${
        post.id
      }" class="popular-post-card d-flex align-items-center mb-3 p-2 rounded shadow-sm bg-white text-decoration-none" style="transition:box-shadow .2s;">
        <img src="${post.image}" alt="${
              post.title
            }" class="rounded me-3" style="width:64px;height:64px;object-fit:cover;">
        <div class="flex-grow-1">
          <div class="fw-semibold text-dark popular-title" style="font-size:1rem;line-height:1.2;">${
            post.title
          }</div>
          <div class="text-muted small mt-1">
            <i class="far fa-calendar me-1"></i>${
              post.date
            } &nbsp; <i class="far fa-clock me-1"></i>${post.readTime || ""}
          </div>
        </div>
      </a>
    `
          )
          .join("");
        const container = document.getElementById("popularPosts");
        if (container) container.innerHTML = html;
      }

      fetchData("blogs", function (blogPostsObj) {
        const blogPosts = blogPostsObj ? Object.values(blogPostsObj) : [];
        // Chỉ lấy bài đã duyệt
        allApprovedPosts = blogPosts.filter(
          (post) => post.status === "đã duyệt"
        );
        // --- Lấy tất cả tag thực tế từ các bài blog đã duyệt ---
        let allTags = [];
        let allAuthors = [];
        allApprovedPosts.forEach((post) => {
          if (Array.isArray(post.tags)) allTags = allTags.concat(post.tags);
          if (post.author) allAuthors.push(post.author);
        });
        // Chuẩn hóa tag
        function normalizeTag(tag) {
          tag = tag.trim();
          if (!tag) return "";
          return tag.charAt(0).toUpperCase() + tag.slice(1).toLowerCase();
        }
        let tagSet = new Map();
        allTags.forEach((tag) => {
          const norm = normalizeTag(tag);
          if (norm && !tagSet.has(norm.toLowerCase()))
            tagSet.set(norm.toLowerCase(), norm);
        });
        const uniqueTags = Array.from(tagSet.values());
        uniqueTags.sort((a, b) => a.localeCompare(b, "vi"));
        // Render lại checkbox tag
        const tagGroup = document.getElementById("tagCheckboxGroup");
        if (tagGroup) {
          tagGroup.innerHTML = uniqueTags
            .map(
              (tag, i) =>
                `<label class='form-check-label me-2 mb-1'><input type='checkbox' class='form-check-input tag-checkbox' value='${tag}'> ${tag}</label>`
            )
            .join("");
        }
        // Render dropdown tác giả
        const authorFilter = document.getElementById("authorFilter");
        if (authorFilter) {
          const uniqueAuthors = Array.from(new Set(allAuthors.filter(Boolean)));
          uniqueAuthors.sort((a, b) => a.localeCompare(b, "vi"));
          let html = '<option value="">Tất cả tác giả</option>';
          uniqueAuthors.forEach((author) => {
            html += `<option value="${author}">${author}</option>`;
          });
          authorFilter.innerHTML = html;
        }
        renderBlogPosts(allApprovedPosts, blogCurrentPage);
        renderPopularPosts(allApprovedPosts);
      });

      // Hàm lấy timestamp chuẩn cho bài blog
      function getPostTime(post) {
        if (post.createdAt && !isNaN(Number(post.createdAt)))
          return Number(post.createdAt);
        if (post.date) {
          // Hỗ trợ cả dạng dd/MM/yyyy và yyyy-MM-dd
          if (/^\d{2}\/\d{2}\/\d{4}$/.test(post.date)) {
            const [day, month, year] = post.date.split("/").map(Number);
            return new Date(year, month - 1, day).getTime();
          } else if (/^\d{4}-\d{2}-\d{2}/.test(post.date)) {
            return new Date(post.date).getTime();
          } else {
            // Thử parse bình thường
            const t = Date.parse(post.date);
            if (!isNaN(t)) return t;
          }
        }
        return 0;
      }

      // Xử lý tìm kiếm và lọc
      function filterAndSearchPosts() {
        const keyword = document
          .getElementById("searchInput")
          .value.trim()
          .toLowerCase();
        // Lấy các tag đã chọn
        const checkedTags = Array.from(
          document.querySelectorAll(".tag-checkbox:checked")
        ).map((el) => el.value.trim().toLowerCase());
        // Lấy tác giả đã chọn
        const author = document.getElementById("authorFilter")?.value.trim();
        let filtered = allApprovedPosts;
        if (keyword) {
          filtered = filtered.filter(
            (post) => post.title && post.title.toLowerCase().includes(keyword)
          );
        }
        if (checkedTags.length > 0) {
          filtered = filtered.filter(
            (post) =>
              post.tags &&
              post.tags.some((tag) =>
                checkedTags.includes(tag.trim().toLowerCase())
              )
          );
        }
        if (author) {
          filtered = filtered.filter((post) => post.author === author);
        }
        // Sắp xếp theo currentSort
        if (currentSort === "views") {
          filtered.sort((a, b) => (b.views || 0) - (a.views || 0));
        } else if (currentSort === "rating") {
          filtered.sort((a, b) => (b.rating || 0) - (a.rating || 0));
        } else if (currentSort === "time") {
          filtered.sort((a, b) => (a.readTime || 9999) - (b.readTime || 9999));
        } else {
          // Mặc định: sort theo ngày mới nhất
          filtered.sort((a, b) => getPostTime(b) - getPostTime(a));
        }
        blogCurrentPage = 1;
        // Hiển thị trạng thái loading khi tìm kiếm (phần 6)
        document.getElementById("blogPosts").innerHTML =
          '<div class="w-100 text-center py-5"><div class="spinner-border text-danger" role="status"><span class="visually-hidden">Đang tải...</span></div></div>';
        setTimeout(function () {
          if (filtered.length === 0) {
            document.getElementById("blogPosts").innerHTML =
              '<div class="w-100 text-center py-5"><i class="fas fa-search fa-2x text-secondary mb-3"></i><div class="fw-semibold text-muted">Không tìm thấy bài viết phù hợp</div></div>';
            renderBlogPagination(0, 1);
          } else {
            renderBlogPosts(filtered, blogCurrentPage);
          }
        }, 350); // Giả lập loading 350ms
      }

      document
        .getElementById("sortSelect")
        .addEventListener("change", function () {
          currentSort = this.value || "newest";
          filterAndSearchPosts();
        });
      // Đảm bảo nút tìm kiếm đúng selector
      const searchBtn = document.querySelector(".search-btn-custom");
      if (searchBtn) {
        searchBtn.addEventListener("click", filterAndSearchPosts);
      }
      document
        .getElementById("searchInput")
        .addEventListener("keyup", function (e) {
          if (e.key === "Enter") filterAndSearchPosts();
        });
      // Lắng nghe thay đổi checkbox tag, author (bỏ lắng nghe dateFrom/dateTo)
      document.addEventListener("change", function (e) {
        if (
          e.target.classList.contains("tag-checkbox") ||
          e.target.id === "authorFilter"
        ) {
          filterAndSearchPosts();
        }
      });

      // --- Đếm số lượng công thức theo category giống index.html ---
      function tagToSlug(tag) {
        const t = tag.trim().toLowerCase();
        if (t.includes("chính")) return "mon-chinh";
        if (t.includes("tráng miệng")) return "trang-mieng";
        if (
          t.includes("đồ uống") ||
          t.includes("thức uống") ||
          t.includes("uống")
        )
          return "do-uong";
        if (t.includes("chay")) return "mon-chay";
        if (t.includes("ăn vặt")) return "an-vat";
        if (t.includes("khai vị") || t.includes("khai-vi"))
          return "mon-khai-vi";
        return "";
      }
      // Gộp tất cả công thức từ các file dữ liệu
      const allRecipes = [
        ...(typeof recipesMonChinh !== "undefined" ? recipesMonChinh : []),
        ...(typeof recipesTrangMieng !== "undefined" ? recipesTrangMieng : []),
        ...(typeof recipesThucUong !== "undefined" ? recipesThucUong : []),
        ...(typeof recipesAnChay !== "undefined" ? recipesAnChay : []),
        ...(typeof recipesAnVat !== "undefined" ? recipesAnVat : []),
        ...(typeof recipesKhaiVi !== "undefined" ? recipesKhaiVi : []),
      ];
      // Đếm số lượng công thức theo category
      const counts = {
        "mon-chinh": 0,
        "trang-mieng": 0,
        "do-uong": 0,
        "mon-chay": 0,
        "an-vat": 0,
        "mon-khai-vi": 0,
      };
      allRecipes.forEach((recipe) => {
        if (Array.isArray(recipe.tags)) {
          recipe.tags.forEach((tag) => {
            const slug = tagToSlug(tag);
            if (counts.hasOwnProperty(slug)) counts[slug]++;
          });
        }
      });
      // Render lại số lượng ở sidebar
      function renderSidebarCategories() {
        const categoryMap = [
          { key: "mon-chinh", label: "Món Chính" },
          { key: "trang-mieng", label: "Món Tráng Miệng" },
          { key: "do-uong", label: "Đồ Uống" },
          { key: "mon-chay", label: "Món Chay" },
          { key: "an-vat", label: "Ăn Vặt" },
          { key: "mon-khai-vi", label: "Món Khai Vị" },
        ];
        const html = categoryMap
          .map(
            (cat) =>
              `<a href="/pages/recipes/list.html?category=${
                cat.key
              }" class="category-item">
              <span>${cat.label}</span>
              <span class="badge bg-primary">${counts[cat.key] || 0}</span>
            </a>`
          )
          .join("");
        const sidebar = document.querySelector(".category-list");
        if (sidebar) sidebar.innerHTML = html;
      }
      renderSidebarCategories();

      // --- Sắp xếp theo dropdown giống list.html ---
      document
        .getElementById("sortSelect")
        .addEventListener("change", function () {
          currentSort = this.value || "newest";
          filterAndSearchPosts();
        });

      // --- AUTOCOMPLETE TÌM KIẾM BLOG ---
      const searchInput = document.getElementById("searchInput");
      const autocompleteBox = document.getElementById("searchAutocomplete");
      let autocompleteItems = [];
      function updateAutocompleteList() {
        const val = searchInput.value.trim().toLowerCase();
        if (!val) {
          autocompleteBox.style.display = "none";
          return;
        }
        // Lấy gợi ý từ tiêu đề và tag
        let suggestions = [];
        const titleSet = new Set();
        allApprovedPosts.forEach((post) => {
          if (post.title && post.title.toLowerCase().includes(val)) {
            titleSet.add(post.title);
          }
          if (Array.isArray(post.tags)) {
            post.tags.forEach((tag) => {
              if (tag.toLowerCase().includes(val)) titleSet.add(tag);
            });
          }
        });
        suggestions = Array.from(titleSet).slice(0, 8); // Tối đa 8 gợi ý
        if (suggestions.length === 0) {
          autocompleteBox.style.display = "none";
          return;
        }
        autocompleteBox.innerHTML = suggestions
          .map(
            (s) =>
              `<div class='autocomplete-item px-3 py-2' style='cursor:pointer;'>${s.replace(
                new RegExp(val, "gi"),
                (m) => `<b>${m}</b>`
              )}</div>`
          )
          .join("");
        autocompleteBox.style.display = "block";
        autocompleteItems = suggestions;
      }
      searchInput.addEventListener("input", updateAutocompleteList);
      // Ẩn dropdown khi blur
      searchInput.addEventListener("blur", function () {
        setTimeout(() => (autocompleteBox.style.display = "none"), 150);
      });
      // Xử lý click chọn gợi ý
      autocompleteBox.addEventListener("mousedown", function (e) {
        if (e.target.classList.contains("autocomplete-item")) {
          const text = e.target.textContent;
          searchInput.value = text;
          autocompleteBox.style.display = "none";
          filterAndSearchPosts();
        }
      });

      // Sidebar toggle for mobile
      const sidebar = document.querySelector(".sidebar");
      const sidebarToggleBtn = document.getElementById("sidebarToggleBtn");
      const sidebarOverlay = document.getElementById("sidebarOverlay");
      function updateSidebarToggleBtn() {
        if (window.innerWidth < 992) {
          sidebarToggleBtn.style.display = "block";
        } else {
          sidebarToggleBtn.style.display = "none";
          sidebar.classList.remove("show");
          sidebarOverlay.classList.remove("active");
        }
      }
      window.addEventListener("resize", updateSidebarToggleBtn);
      document.addEventListener("DOMContentLoaded", updateSidebarToggleBtn);
      sidebarToggleBtn.addEventListener("click", function () {
        sidebar.classList.toggle("show");
        sidebarOverlay.classList.toggle("active");
      });
      sidebarOverlay.addEventListener("click", function () {
        sidebar.classList.remove("show");
        sidebarOverlay.classList.remove("active");
      });

      document.addEventListener("DOMContentLoaded", function () {
        // Chặn nút đăng blog ở header
        const headerBtn = document.querySelector(
          'a[href="/pages/add-blog.html"].btn-outline-light'
        );
        if (headerBtn) {
          headerBtn.addEventListener("click", function (e) {
            fetchData("blog_config", function (config) {
              if (!config || config.allowBlog === false) {
                e.preventDefault();
                var modal = new bootstrap.Modal(
                  document.getElementById("addBlogBlockedModal")
                );
                modal.show();
              }
            });
          });
        }
        // Chặn nút đăng blog ở sidebar
        const sidebarBtn = document.querySelector(
          '.sidebar-card a.btn-success[href="/pages/add-blog.html"]'
        );
        if (sidebarBtn) {
          sidebarBtn.addEventListener("click", function (e) {
            fetchData("blog_config", function (config) {
              if (!config || config.allowBlog === false) {
                e.preventDefault();
                var modal = new bootstrap.Modal(
                  document.getElementById("addBlogBlockedModal")
                );
                modal.show();
              }
            });
          });
        }
        // Hiển thị modal nếu bị chuyển hướng từ trang đăng blog
        if (window.location.search.includes("blocked=1")) {
          var modal = new bootstrap.Modal(
            document.getElementById("addBlogBlockedModal")
          );
          modal.show();
        }
      });
    </script>
  </body>
</html>
