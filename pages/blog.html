<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blog - Món Ngon Việt Nam</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/assets/css/pages/blog.css" />
    <!-- <link rel="stylesheet" href="/assets/css/pages/index.css" /> -->
    <style>
      /* ...existing code... */
      .search-input-group select {
        border: 1px solid #e0e0e0 !important;
        background: #fff !important;
        border-radius: 2rem !important;
        font-size: 1rem;
        height: 40px !important;
        padding-left: 1rem !important;
        padding-right: 2rem !important;
        color: #333;
        min-width: 120px;
        box-shadow: 0 1px 4px 0 rgba(0, 0, 0, 0.04);
        margin-left: 0.5rem;
        appearance: auto;
      }
      .search-input-group select:focus {
        border: 1.5px solid #d72660 !important;
        outline: none !important;
        box-shadow: 0 2px 8px 0 rgba(215, 38, 96, 0.1);
      }
      .search-input-group input {
        font-size: 1rem;
        background: transparent;
        border: none;
        height: 44px;
        padding-left: 0;
        color: #333;
      }
      .search-input-group {
        background: #f6f6fa;
        border-radius: 2rem;
        border: 1px solid #e0e0e0;
        min-height: 48px;
        height: 48px;
        padding-right: 0.5rem;
      }
      .search-box {
        gap: 12px !important;
      }
      .search-input-group {
        flex: 1 1 0%;
        min-width: 0;
      }
      .form-select#categoryFilter {
        max-width: 180px;
      }
      @media (max-width: 767px) {
        .search-box {
          flex-direction: column;
          align-items: stretch;
          gap: 0.75rem;
        }
        .search-btn {
          width: 100%;
        }
        .search-input-group {
          width: 100%;
        }
        .form-select#categoryFilter {
          width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top">
      <div class="container">
        <a class="navbar-brand" href="/index.html">
          
          Món Ngon Việt Nam
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item">
              <a class="nav-link" href="../index.html">Trang chủ</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="recipes/list.html">Công thức</a>
            </li>

            <li class="nav-item">
              <a class="nav-link active" href="blog.html">Blog</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="about.html">Về chúng tôi</a>
            </li>
            <li class="nav-item ms-3">
              <a
                class="btn btn-outline-primary px-4 py-2 ms-2"
                href="/pages/auth/login.html"
                id="loginBtn"
              >
                Đăng nhập
              </a>
              <a
                class="btn btn-primary px-4 py-2 ms-2"
                href="/pages/auth/register.html"
                id="registerBtn"
              >
                Đăng ký
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page Header -->
    <header class="page-header">
      <div class="container">
        <h1 class="display-4 fw-bold mb-4">Blog Ẩm Thực</h1>
        <p class="lead">
          Khám phá văn hóa ẩm thực Việt Nam qua những câu chuyện thú vị
        </p>
      </div>
    </header>

    <!-- Main Content -->
    <div class="container">
      <div class="row">
        <!-- Blog Posts -->
        <div class="col-lg-8">
          <!-- Search Box -->
          <div
            class="search-box mb-5 d-flex align-items-center gap-3 flex-nowrap"
          >
            <select
              class="form-select rounded-pill text-center"
              id="categoryFilter"
              style="
                min-width: 140px;
                height: 44px;
                background: #fff;
                border: 1px solid #e0e0e0;
                font-size: 1rem;
              "
            >
              <option value="">Tất cả tag</option>
              <option value="Ẩm thực">Ẩm thực</option>
              <option value="Món Việt">Món Việt</option>
              <option value="Ăn chay">Ăn chay</option>
              <option value="Ăn vặt">Ăn vặt</option>
              <option value="Healthy">Healthy</option>
              <option value="Khai vị">Khai vị</option>
              <option value="Truyền thống">Truyền thống</option>
              <option value="Đồ uống">Đồ uống</option>
            </select>
            <div
              class="search-input-group d-flex align-items-center flex-grow-1 bg-light rounded-pill px-3"
              style="height: 48px"
            >
              <span class="search-icon me-2 text-secondary"
                ><i class="fas fa-search"></i
              ></span>
              <input
                type="text"
                class="search-input border-0 bg-transparent flex-grow-1"
                placeholder="Tìm kiếm bài viết..."
                id="searchInput"
                style="
                  outline: none;
                  box-shadow: none;
                  height: 44px;
                  min-width: 120px;
                "
              />
            </div>
            <button
              class="search-btn btn btn-primary rounded-pill px-4 fw-bold d-flex align-items-center me-0"
              style="height: 48px; white-space: nowrap"
            >
              <i class="fas fa-search me-2"></i>Tìm kiếm
            </button>
          </div>

          <!-- Blog Posts Grid -->
          <div class="row" id="blogPosts">
            <!-- Blog posts will be inserted here by JavaScript -->
          </div>

          <!-- Pagination -->
          <nav
            aria-label="Page navigation"
            class="d-flex justify-content-center mt-5"
          >
            <ul class="pagination">
              <li class="page-item">
                <a class="page-link" href="#" aria-label="Previous">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
              <li class="page-item active">
                <a class="page-link" href="#">1</a>
              </li>
              <li class="page-item"><a class="page-link" href="#">2</a></li>
              <li class="page-item"><a class="page-link" href="#">3</a></li>
              <li class="page-item">
                <a class="page-link" href="#" aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
            </ul>
          </nav>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
          <div class="sidebar">
            <!-- Categories -->
            <div class="sidebar-card">
              <h4 class="sidebar-title">Danh Mục</h4>
              <div class="category-list">
                <a
                  href="/pages/recipes/list.html?category=mon-chinh"
                  class="category-item"
                >
                  <span>Món Chính</span>
                  <span class="badge bg-primary">24</span>
                </a>
                <a
                  href="/pages/recipes/list.html?category=mon-trang-mieng"
                  class="category-item"
                >
                  <span>Món Tráng Miệng</span>
                  <span class="badge bg-primary">18</span>
                </a>
                <a
                  href="/pages/recipes/list.html?category=do-uong"
                  class="category-item"
                >
                  <span>Đồ Uống</span>
                  <span class="badge bg-primary">12</span>
                </a>
                <a
                  href="/pages/recipes/list.html?category=mon-chay"
                  class="category-item"
                >
                  <span>Món Chay</span>
                  <span class="badge bg-primary">15</span>
                </a>
                <a
                  href="/pages/recipes/list.html?category=khai-vi"
                  class="category-item"
                >
                  <span>Món Khai Vị</span>
                  <span class="badge bg-primary">30</span>
                </a>
              </div>
            </div>

            <!-- Popular Posts -->
            <div class="sidebar-card">
              <h4 class="sidebar-title">Bài Viết Nổi Bật</h4>
              <div id="popularPosts">
                <!-- Popular posts will be inserted here by JavaScript -->
              </div>
            </div>

            <!-- Đăng Bài Blog Button -->
            <div class="sidebar-card">
              <a
                href="/pages/add-blog.html"
                class="btn btn-success w-100 mb-3 fw-bold"
              >
                <i class="fas fa-pen-nib me-2"></i>Đăng bài blog
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer
      class="footer mt-5 py-5"
      style="
        background: linear-gradient(
          45deg,
          var(--primary-color),
          var(--secondary-color)
        );
      "
    >
      <div class="container">
        <div class="row g-4">
          <div class="col-lg-4">
            <h5 class="mb-3 fw-bold text-white">Về Chúng Tôi</h5>
            <p class="mb-4 text-white">
              Món Ngon Việt Nam là cộng đồng chia sẻ công thức nấu ăn lớn nhất
              Việt Nam, nơi kết nối những người đam mê ẩm thực.
            </p>
            <div class="social-links d-flex gap-3">
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-facebook-f"></i
              ></a>
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-instagram"></i
              ></a>
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-youtube"></i
              ></a>
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-tiktok"></i
              ></a>
            </div>
          </div>
          <div class="col-lg-2">
            <h5 class="mb-3 fw-bold text-white">Khám Phá</h5>
            <ul class="list-unstyled">
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html"
                  class="text-white text-decoration-none"
                  >Công thức</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/blog.html"
                  class="text-white text-decoration-none"
                  >Blog</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/about.html"
                  class="text-white text-decoration-none"
                  >Về chúng tôi</a
                >
              </li>
              <li class="mb-2">
                <a href="#" class="text-white text-decoration-none">Liên hệ</a>
              </li>
            </ul>
          </div>
          <div class="col-lg-3">
            <h5 class="mb-3 fw-bold text-white">Danh Mục</h5>
            <ul class="list-unstyled">
              <li class="mb-2">
                <a
                  href="recipes/list.html?category=mon-chinh"
                  class="text-white text-decoration-none"
                  >Món chính</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="recipes/list.html?category=trang-mieng"
                  class="text-white text-decoration-none"
                  >Món tráng miệng</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="recipes/list.html?category=thuc-uong"
                  class="text-white text-decoration-none"
                  >Đồ uống</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="recipes/list.html?category=mon-chay"
                  class="text-white text-decoration-none"
                  >Món chay</a
                >
              </li>
            </ul>
          </div>
          <div class="col-lg-3">
            <h5 class="mb-3 fw-bold text-white">Liên Hệ</h5>
            <ul class="list-unstyled text-white">
              <li class="mb-2">
                <i class="fas fa-envelope me-2"></i> lienhe@monngon.vn
              </li>
              <li class="mb-2">
                <i class="fas fa-phone me-2"></i> 0123.456.789
              </li>
              <li class="mb-2">
                <i class="fas fa-map-marker-alt me-2"></i> Hà Nội, Việt Nam
              </li>
            </ul>
          </div>
        </div>
        <hr class="my-4 bg-white" />
        <div class="text-center text-white">
          <p class="mb-0">© 2024 Món Ngon Việt Nam. Đã đăng ký bản quyền.</p>
        </div>
      </div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="/assets/js/firebase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/navbar-user.js"></script>
    <script src="/assets/data/recipes_MonChinh.js"></script>
    <script src="/assets/data/recipes_TrangMieng.js"></script>
    <script src="/assets/data/recipes_ThucUong.js"></script>
    <script src="/assets/data/recipes_AnChay.js"></script>
    <script src="/assets/data/recipes_AnVat.js"></script>
    <script src="/assets/data/recipes_KhaiVi.js"></script>
    <script>
      // Initialize AOS
      AOS.init({
        duration: 800,
        once: true,
      });

      const BLOG_PAGE_SIZE = 4;
      let blogCurrentPage = 1;
      let blogFilteredPosts = [];

      // Lấy dữ liệu blog động từ file JSON
      let allApprovedPosts = [];
      function renderBlogPosts(posts, page = 1) {
        blogFilteredPosts = posts;
        const start = (page - 1) * BLOG_PAGE_SIZE;
        const end = start + BLOG_PAGE_SIZE;
        const pagePosts = posts.slice(start, end);
        document.getElementById("blogPosts").innerHTML = pagePosts
          .map(
            (post) => `
      <div class="col-md-6 mb-4" data-aos="fade-up">
        <a href="/pages/blog-detail.html?id=${
          post.id
        }" class="blog-card d-block" data-id="${post.id}">
          <img src="${post.image}" class="blog-image w-100" alt="${post.title}">
          <div class="blog-content">
            <h3 class="blog-title">${post.title}</h3>
            <div class="blog-meta">
              <span><i class="fas fa-user"></i> ${post.author}</span>
              <span><i class="far fa-calendar"></i> ${post.date}</span>
              <span><i class="far fa-clock"></i> ${post.readTime}</span>
            </div>
            <p class="blog-excerpt">${post.excerpt}</p>
            <div class="blog-tags">
              ${(post.tags || [])
                .map((tag) => `<span class="blog-tag">${tag}</span>`)
                .join("")}
            </div>
          </div>
        </a>
      </div>
    `
          )
          .join("");
        renderBlogPagination(posts.length, page);
      }

      function renderBlogPagination(totalPosts, currentPage) {
        const totalPages = Math.ceil(totalPosts / BLOG_PAGE_SIZE);
        const pagination = document.querySelector(".pagination");
        if (!pagination) return;
        let html = "";
        const maxPagesToShow = 5;
        if (totalPages <= 7) {
          for (let i = 1; i <= totalPages; i++) {
            html += `<li class="page-item${
              i === currentPage ? " active" : ""
            }"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
          }
        } else {
          html += `<li class="page-item${
            currentPage === 1 ? " active" : ""
          }"><a class="page-link" href="#" data-page="1">1</a></li>`;
          if (currentPage > maxPagesToShow) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
          }
          let start = Math.max(2, currentPage - 2);
          let end = Math.min(totalPages - 1, currentPage + 2);
          if (currentPage <= maxPagesToShow) {
            end = Math.max(end, maxPagesToShow);
          }
          if (currentPage >= totalPages - maxPagesToShow + 1) {
            start = Math.min(start, totalPages - maxPagesToShow);
          }
          for (let i = start; i <= end; i++) {
            html += `<li class="page-item${
              i === currentPage ? " active" : ""
            }"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
          }
          if (currentPage < totalPages - maxPagesToShow + 1) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
          }
          html += `<li class="page-item${
            currentPage === totalPages ? " active" : ""
          }"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
        }
        pagination.innerHTML = html;
        pagination.querySelectorAll("a.page-link").forEach((link) => {
          link.onclick = function (e) {
            e.preventDefault();
            const page = this.getAttribute("data-page");
            if (!isNaN(Number(page))) {
              blogCurrentPage = Number(page);
              renderBlogPosts(blogFilteredPosts, blogCurrentPage);
            }
          };
        });
      }

      fetchData("blogs", function (blogPostsObj) {
        const blogPosts = blogPostsObj ? Object.values(blogPostsObj) : [];
        // Chỉ lấy bài đã duyệt
        allApprovedPosts = blogPosts.filter(
          (post) => post.status === "đã duyệt"
        );
        // --- Lấy tất cả tag thực tế từ các bài blog đã duyệt ---
        let allTags = [];
        allApprovedPosts.forEach((post) => {
          if (Array.isArray(post.tags)) allTags = allTags.concat(post.tags);
        });
        // Chuẩn hóa: Viết hoa chữ cái đầu, các chữ còn lại thường, loại trùng (không phân biệt hoa thường)
        function normalizeTag(tag) {
          tag = tag.trim();
          if (!tag) return "";
          return tag.charAt(0).toUpperCase() + tag.slice(1).toLowerCase();
        }
        let tagSet = new Map();
        allTags.forEach((tag) => {
          const norm = normalizeTag(tag);
          if (norm && !tagSet.has(norm.toLowerCase()))
            tagSet.set(norm.toLowerCase(), norm);
        });
        const uniqueTags = Array.from(tagSet.values());
        uniqueTags.sort((a, b) => a.localeCompare(b, "vi"));
        // Render lại dropdown tag
        const catFilter = document.getElementById("categoryFilter");
        if (catFilter) {
          let html = '<option value="">Tất cả tag</option>';
          uniqueTags.forEach((tag) => {
            html += `<option value="${tag}">${tag}</option>`;
          });
          catFilter.innerHTML = html;
        }
        renderBlogPosts(allApprovedPosts, blogCurrentPage);
      });

      // Xử lý tìm kiếm và lọc
      function filterAndSearchPosts() {
        const keyword = document
          .getElementById("searchInput")
          .value.trim()
          .toLowerCase();
        const category = document
          .getElementById("categoryFilter")
          .value.trim()
          .toLowerCase();
        let filtered = allApprovedPosts.filter((post) => {
          // Lọc theo tag nếu có, không phân biệt hoa thường, so sánh từng tag
          let matchCategory =
            !category ||
            (post.tags &&
              post.tags.some((tag) => tag.trim().toLowerCase() === category));
          // Lọc theo từ khóa
          let matchKeyword =
            !keyword ||
            (post.title && post.title.toLowerCase().includes(keyword)) ||
            (post.excerpt && post.excerpt.toLowerCase().includes(keyword)) ||
            (post.tags &&
              post.tags.some((tag) => tag.toLowerCase().includes(keyword)));
          return matchCategory && matchKeyword;
        });
        blogCurrentPage = 1;
        renderBlogPosts(filtered, blogCurrentPage);
      }

      document
        .querySelector(".search-btn")
        .addEventListener("click", filterAndSearchPosts);
      document
        .getElementById("searchInput")
        .addEventListener("keyup", function (e) {
          if (e.key === "Enter") filterAndSearchPosts();
        });
      document
        .getElementById("categoryFilter")
        .addEventListener("change", filterAndSearchPosts);

      // --- Đếm số lượng công thức theo category giống index.html ---
      function tagToSlug(tag) {
        const t = tag.trim().toLowerCase();
        if (t.includes("chính")) return "mon-chinh";
        if (t.includes("tráng miệng")) return "trang-mieng";
        if (
          t.includes("đồ uống") ||
          t.includes("thức uống") ||
          t.includes("uống")
        )
          return "do-uong";
        if (t.includes("chay")) return "mon-chay";
        if (t.includes("ăn vặt")) return "an-vat";
        if (t.includes("khai vị") || t.includes("khai-vi"))
          return "mon-khai-vi";
        return "";
      }
      // Gộp tất cả công thức từ các file dữ liệu
      const allRecipes = [
        ...(typeof recipesMonChinh !== "undefined" ? recipesMonChinh : []),
        ...(typeof recipesTrangMieng !== "undefined" ? recipesTrangMieng : []),
        ...(typeof recipesThucUong !== "undefined" ? recipesThucUong : []),
        ...(typeof recipesAnChay !== "undefined" ? recipesAnChay : []),
        ...(typeof recipesAnVat !== "undefined" ? recipesAnVat : []),
        ...(typeof recipesKhaiVi !== "undefined" ? recipesKhaiVi : []),
      ];
      // Đếm số lượng công thức theo category
      const counts = {
        "mon-chinh": 0,
        "trang-mieng": 0,
        "do-uong": 0,
        "mon-chay": 0,
        "an-vat": 0,
        "mon-khai-vi": 0,
      };
      allRecipes.forEach((recipe) => {
        if (Array.isArray(recipe.tags)) {
          recipe.tags.forEach((tag) => {
            const slug = tagToSlug(tag);
            if (counts.hasOwnProperty(slug)) counts[slug]++;
          });
        }
      });
      // Render lại số lượng ở sidebar
      function renderSidebarCategories() {
        const categoryMap = [
          { key: "mon-chinh", label: "Món Chính" },
          { key: "trang-mieng", label: "Món Tráng Miệng" },
          { key: "do-uong", label: "Đồ Uống" },
          { key: "mon-chay", label: "Món Chay" },
          { key: "an-vat", label: "Ăn Vặt" },
          { key: "mon-khai-vi", label: "Món Khai Vị" },
        ];
        const html = categoryMap
          .map(
            (cat) =>
              `<a href="/pages/recipes/list.html?category=${
                cat.key
              }" class="category-item">
              <span>${cat.label}</span>
              <span class="badge bg-primary">${counts[cat.key] || 0}</span>
            </a>`
          )
          .join("");
        const sidebar = document.querySelector(".category-list");
        if (sidebar) sidebar.innerHTML = html;
      }
      renderSidebarCategories();
    </script>
  </body>
</html>
