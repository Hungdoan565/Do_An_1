<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Công Thức Nấu Ăn - Món Ngon Việt Nam</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/assets/css/pages/list.css" />
    <!-- <link rel="stylesheet" href="/assets/css/pages/index.css" /> -->
    <style></style>
  </head>

  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top">
      <div class="container">
        <a class="navbar-brand" href="/index.html"> Món Ngon Việt Nam </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item">
              <a class="nav-link" href="/index.html">Trang chủ</a>
            </li>
            <!-- Dropdown Công thức -->
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarRecipeDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Công thức
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarRecipeDropdown">
                <li>
                  <a class="dropdown-item" href="../recipes/list.html">
                    <i class="fas fa-list-ul"></i> Danh sách công thức
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="/pages/user/add-recipe.html">
                    <i class="fas fa-plus-circle"></i> Thêm công thức mới
                  </a>
                </li>
              </ul>
            </li>
            <!-- Dropdown Blog -->
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarBlogDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Blog
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarBlogDropdown">
                <li>
                  <a class="dropdown-item" href="../blog.html">
                    <i class="fas fa-book-open"></i> Danh sách blog
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="/pages/add-blog.html">
                    <i class="fas fa-pen-nib"></i> Thêm blog mới
                  </a>
                </li>
              </ul>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/pages/about.html">Về chúng tôi</a>
            </li>
            <li class="nav-item ms-3">
              <a
                class="btn btn-outline-primary px-4 py-2 ms-2"
                href="/pages/auth/login.html"
                id="loginBtn"
              >
                Đăng nhập
              </a>
              <a
                class="btn btn-primary px-4 py-2 ms-2"
                href="/pages/auth/register.html"
                id="registerBtn"
              >
                Đăng ký
              </a>
            </li>
            <li
              class="nav-item ms-2"
              id="addRecipeNavBtn"
              style="display: none"
            >
              <a
                class="btn btn-primary px-4 py-2"
                href="/pages/user/add-recipe.html"
              >
                <i class="fas fa-plus-circle me-2"></i>Chia sẻ công thức
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page Header -->
    <header class="page-header">
      <div class="container">
        <div class="row align-items-center flex-column flex-md-row">
          <div class="col-md-6 text-center text-md-start mb-4 mb-md-0">
            <h1 class="display-4 fw-bold mb-3">Khám Phá Công Thức</h1>
            <p class="lead mb-4">
              <i class="fas fa-utensils me-2"></i>Hàng ngàn công thức nấu ăn từ
              cộng đồng yêu bếp Việt Nam
            </p>
            <div
              class="d-flex justify-content-center justify-content-md-start gap-3"
            >
              <a
                href="/pages/user/add-recipe.html"
                class="btn btn-dark px-4 py-2"
                ><i class="fas fa-plus-circle me-2"></i>Chia sẻ công thức</a
              >
              <a
                href="/pages/recipes/featured.html"
                class="btn btn-outline-light px-4 py-2"
                ><i class="fas fa-star me-2"></i>Xem công thức nổi bật</a
              >
            </div>
          </div>
          <div class="col-md-6">
            <div class="row g-4 justify-content-center page-header-featured">
              <div class="col-4">
                <div
                  class="header-featured-card"
                  style="
                    background-image: url('/assets/images/list-congthuc/khampha.jpg');
                  "
                ></div>
              </div>
              <div class="col-4">
                <div
                  class="header-featured-card"
                  style="
                    background-image: url('/assets/images/list-congthuc/khampha1.jpg');
                  "
                ></div>
              </div>
              <div class="col-4">
                <div
                  class="header-featured-card"
                  style="
                    background-image: url('/assets/images/list-congthuc/khamphaCT.jpg');
                  "
                ></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="container">
      <!-- Search Box -->
      <div class="search-box position-relative">
        <input
          type="text"
          class="search-input"
          placeholder="Tìm kiếm công thức..."
          id="searchInput"
          autocomplete="off"
        />
        <button class="search-btn">
          <i class="fas fa-search me-2"></i>Tìm kiếm
        </button>
        <!-- Autocomplete dropdown -->
        <div
          id="searchAutocomplete"
          class="autocomplete-dropdown bg-white border rounded shadow-sm"
          style="
            position: absolute;
            z-index: 1000;
            top: 100%;
            left: 0;
            width: 100%;
            display: none;
          "
        ></div>
      </div>

      <!-- Sort Dropdown -->
      <div
        class="sort-section d-flex justify-content-end align-items-center my-3"
      >
        <label for="sortSelect" class="me-2 fw-semibold">Sắp xếp theo:</label>
        <select id="sortSelect" class="form-select w-auto">
          <option value="">Mặc định</option>
          <option value="newest">Mới nhất</option>
          <option value="rating">Đánh giá cao</option>
          <option value="time">Thời gian nấu ngắn</option>
        </select>
      </div>

      <!-- Filters -->
      <div class="filter-section">
        <div class="d-flex flex-wrap justify-content-center">
          <button class="filter-btn active">Tất cả</button>
          <button class="filter-btn">Món chính</button>
          <button class="filter-btn">Món tráng miệng</button>
          <button class="filter-btn">Đồ uống</button>
          <button class="filter-btn">Món chay</button>
          <button class="filter-btn">Ăn vặt</button>
          <button class="filter-btn">Món khai vị</button>
        </div>
      </div>

      <div class="container position-relative recipe-grid-wrapper">
        <!-- Prev/Next floating -->
        <button
          class="page-nav-btn page-prev-btn floating-nav-btn"
          id="floatingPrevBtn"
        >
          <i class="fas fa-chevron-left"></i>
        </button>
        <button
          class="page-nav-btn page-next-btn floating-nav-btn"
          id="floatingNextBtn"
        >
          <i class="fas fa-chevron-right"></i>
        </button>
        <!-- Recipe Grid -->
        <div class="row" id="recipeGrid">
          <!--  Công thức sẽ được chèn vào đây bằng JavaScript -->
        </div>
        <!-- Pagination -->
        <div
          class="d-flex justify-content-center align-items-center pagination-nav my-5"
        >
          <ul class="pagination mb-0 mx-4 flex-nowrap"></ul>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer
      class="footer mt-5 py-5"
      style="
        background: linear-gradient(
          45deg,
          var(--primary-color),
          var(--secondary-color)
        );
      "
    >
      <div class="container">
        <div class="row g-4">
          <div class="col-lg-4">
            <h5 class="mb-3 fw-bold text-white">Về Chúng Tôi</h5>
            <p class="mb-4 text-white">
              Món Ngon Việt Nam là cộng đồng chia sẻ công thức nấu ăn lớn nhất
              Việt Nam, nơi kết nối những người đam mê ẩm thực.
            </p>
            <div class="social-links d-flex gap-3">
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-facebook-f"></i
              ></a>
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-instagram"></i
              ></a>
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-youtube"></i
              ></a>
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-tiktok"></i
              ></a>
            </div>
          </div>
          <div class="col-lg-2">
            <h5 class="mb-3 fw-bold text-white">Khám Phá</h5>
            <ul class="list-unstyled">
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html"
                  class="text-white text-decoration-none"
                  >Công thức</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/blog.html"
                  class="text-white text-decoration-none"
                  >Blog</a
                >
              </li>
              <li class="mb-2">
                <a href="/pages/about.html" class="text-white text-decoration-none"
                  >Về chúng tôi</a
                >
              </li>
              <li class="mb-2">
                <a href="#" class="text-white text-decoration-none">Liên hệ</a>
              </li>
            </ul>
          </div>
          <div class="col-lg-3">
            <h5 class="mb-3 fw-bold text-white">Danh Mục</h5>
            <ul class="list-unstyled">
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html?category=mon-chinh"
                  class="text-white text-decoration-none"
                  >Món chính</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html?category=trang-mieng"
                  class="text-white text-decoration-none"
                  >Món tráng miệng</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html?category=do-uong"
                  class="text-white text-decoration-none"
                  >Đồ uống</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html?category=mon-chay"
                  class="text-white text-decoration-none"
                  >Món chay</a
                >
              </li>
            </ul>
          </div>
          <div class="col-lg-3">
            <h5 class="mb-3 fw-bold text-white">Liên Hệ</h5>
            <ul class="list-unstyled text-white">
              <li class="mb-2">
                <i class="fas fa-envelope me-2"></i> lienhe@monngon.vn
              </li>
              <li class="mb-2">
                <i class="fas fa-phone me-2"></i> 0123.456.789
              </li>
              <li class="mb-2">
                <i class="fas fa-map-marker-alt me-2"></i> Hà Nội, Việt Nam
              </li>
            </ul>
          </div>
        </div>
        <hr class="my-4 bg-white" />
        <div class="text-center text-white">
          <p class="mb-0">© 2024 Món Ngon Việt Nam. Đã đăng ký bản quyền.</p>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/filter-MonAn.js"></script>
    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <script src="/assets/data/recipes_MonChinh.js"></script>
    <script src="/assets/data/recipes_TrangMieng.js"></script>
    <script src="/assets/data/recipes_ThucUong.js"></script>
    <script src="/assets/data/recipes_AnChay.js"></script>
    <script src="/assets/data/recipes_AnVat.js"></script>
    <script src="/assets/data/recipes_KhaiVi.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/navbar-user.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="/assets/js/firebase-config.js"></script>
    <script>
      // --- LẤY CÔNG THỨC TỪ FIREBASE VÀ FILE TĨNH ---
      let firebaseRecipes = [];
      let staticRecipes = [
        ...(typeof recipesMonChinh !== "undefined" ? recipesMonChinh : []),
        ...(typeof recipesTrangMieng !== "undefined" ? recipesTrangMieng : []),
        ...(typeof recipesThucUong !== "undefined" ? recipesThucUong : []),
        ...(typeof recipesAnChay !== "undefined" ? recipesAnChay : []),
        ...(typeof recipesAnVat !== "undefined" ? recipesAnVat : []),
        ...(typeof recipesKhaiVi !== "undefined" ? recipesKhaiVi : []),
      ];
      let recipes = [];

      function mergeRecipes(firebaseList, staticList) {
        // Nếu firebaseList rỗng, trả về staticList (giữ nguyên thứ tự cũ)
        if (!firebaseList || firebaseList.length === 0)
          return staticList.slice();
        // Nếu có firebase, ưu tiên firebase lên đầu, loại bỏ trùng id
        const ids = new Set();
        const merged = [];
        firebaseList.forEach((r) => {
          if (r && r.id && !ids.has(r.id)) {
            merged.push(r);
            ids.add(r.id);
          }
        });
        staticList.forEach((r) => {
          if (r && r.id && !ids.has(r.id)) {
            merged.push(r);
            ids.add(r.id);
          }
        });
        return merged;
      }

      function loadAndRenderRecipes() {
        if (typeof fetchData === "function") {
          fetchData(
            "recipes",
            function (data) {
              firebaseRecipes = [];
              if (data) {
                firebaseRecipes = Object.entries(data)
                  .map(([id, r]) => ({ ...r, id }))
                  .filter(
                    (r) =>
                      r &&
                      (r.pending === false ||
                        r.pending === "false" ||
                        r.status?.toLowerCase() === "approved" ||
                        r.status?.toLowerCase() === "đã duyệt")
                  );
                // Sắp xếp mới nhất lên đầu
                firebaseRecipes.sort(
                  (a, b) => (b.createdAt || 0) - (a.createdAt || 0)
                );
              }
              recipes = mergeRecipes(firebaseRecipes, staticRecipes);
              // Sắp xếp: bài đã duyệt lên đầu, trong mỗi nhóm sort theo createdAt mới nhất
              recipes.sort((a, b) => {
                // Đã duyệt lên đầu
                const aApproved =
                  a.pending === false ||
                  a.pending === "false" ||
                  (a.status &&
                    ["approved", "đã duyệt"].includes(
                      (a.status + "").toLowerCase()
                    ));
                const bApproved =
                  b.pending === false ||
                  b.pending === "false" ||
                  (b.status &&
                    ["approved", "đã duyệt"].includes(
                      (b.status + "").toLowerCase()
                    ));
                if (aApproved !== bApproved) return bApproved - aApproved;
                // Trong mỗi nhóm, sort theo createdAt mới nhất
                return (b.createdAt || 0) - (a.createdAt || 0);
              });
              // Nếu sau khi merge mà không có công thức nào (cả firebase và tĩnh đều rỗng), fallback về staticRecipes
              if (!recipes || recipes.length === 0)
                recipes = staticRecipes.slice();
              if (typeof renderRecipes === "function") {
                filteredRecipes = recipes;
                currentPage = 1;
                renderRecipes(currentPage);
              }
            },
            function () {
              // Nếu fetchData lỗi, fallback về staticRecipes
              recipes = staticRecipes.slice();
              if (typeof renderRecipes === "function") {
                filteredRecipes = recipes;
                currentPage = 1;
                renderRecipes(currentPage);
              }
            }
          );
        } else {
          // Nếu không có fetchData, fallback về staticRecipes
          recipes = staticRecipes.slice();
          if (typeof renderRecipes === "function") {
            filteredRecipes = recipes;
            currentPage = 1;
            renderRecipes(currentPage);
          }
        }
      }
      // Gọi khi DOM ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", loadAndRenderRecipes);
      } else {
        loadAndRenderRecipes();
      }

      // Gộp tất cả công thức
      const categoryMap = {
        "Tất cả": "all",
        "Món chính": "mon-chinh",
        "Món tráng miệng": "trang-mieng",
        "Đồ uống": "do-uong",
        "Món chay": "mon-chay",
        "Ăn vặt": "an-vat",
        "Món khai vị": "khai-vi",
      };

      // Hàm chuyển tag sang slug
      function tagToSlug(tag) {
        const t = tag.trim().toLowerCase();
        if (t.includes("khai vị")) return "khai-vi";
        if (t.includes("món chính")) return "mon-chinh";
        if (t.includes("tráng miệng")) return "trang-mieng";
        if (t.includes("đồ uống")) return "do-uong";
        if (t.includes("món chay")) return "mon-chay";
        if (t.includes("ăn vặt")) return "an-vat";
        return "";
      }

      let filteredRecipes = recipes;

      function filterRecipesByCategory(category) {
        if (category === "Tất cả") {
          filteredRecipes = recipes;
        } else {
          const slug = categoryMap[category];
          filteredRecipes = recipes.filter(
            (r) =>
              Array.isArray(r.tags) &&
              r.tags.some((tag) => tagToSlug(tag) === slug)
          );
        }
        currentPage = 1;
        renderRecipes(currentPage);
      }

      // Phân trang
      const PAGE_SIZE = 6;
      let currentPage = 1;

      function renderRecipes(page = 1) {
        console.log("recipes:", recipes);
        console.log("filteredRecipes:", filteredRecipes);
        const start = (page - 1) * PAGE_SIZE;
        const end = start + PAGE_SIZE;
        const pageRecipes = filteredRecipes.slice(start, end);
        console.log("pageRecipes:", pageRecipes);
        const recipeGrid = document.getElementById("recipeGrid");
        recipeGrid.innerHTML = pageRecipes
          .map((recipe) => {
            // Xử lý ảnh: nếu là base64 hoặc url thì dùng, nếu không có hoặc là chuỗi rỗng/null/undefined thì dùng ảnh mặc định
            let imgSrc = recipe.image;
            if (
              !imgSrc ||
              imgSrc === "null" ||
              imgSrc === "undefined" ||
              imgSrc.trim() === ""
            ) {
              imgSrc = "/assets/images/recipes/default.jpg";
            }
            return `
      <div class="col-md-6 col-lg-4 d-flex align-items-stretch" data-aos="fade-up">
        <div class="recipe-card w-100" data-id="${
          recipe.id
        }" style="cursor:pointer;">
          <img src="${imgSrc}" class="recipe-image w-100" alt="${recipe.title}">
          <div class="recipe-info">
            <h3 class="recipe-title">${recipe.title}</h3>
            <p class="text-muted mb-3">${(() => {
              const words = (recipe.description || "").split(" ");
              return (
                words.slice(0, 25).join(" ") + (words.length > 25 ? "..." : "")
              );
            })()}</p>
            <div class="recipe-meta">
              <span><i class="fas fa-clock"></i> ${recipe.time} phút</span>
              <span><i class="fas fa-star"></i> ${recipe.rating}</span>
              <span><i class="fas fa-user"></i> ${
                typeof recipe.author === "object" && recipe.author !== null
                  ? recipe.author.username ||
                    recipe.author.name ||
                    recipe.author.email ||
                    "Ẩn danh"
                  : recipe.author || "Ẩn danh"
              }</span>
              <span class="recipe-comments" data-id="${
                recipe.id
              }"><i class="far fa-comment"></i> <span class="comment-count">...</span></span>
            </div>
            <div class="recipe-meta mt-2">
              <span><i class="fas fa-signal"></i> ${
                recipe.difficulty || ""
              }</span>
            </div>
            <div class="recipe-tags">
              ${(recipe.tags || [])
                .map((tag) => `<span class="recipe-tag">${tag}</span>`)
                .join("")}
            </div>
          </div>
        </div>
      </div>
    `;
          })
          .join("");
        // Lấy số bình luận cho từng công thức và cập nhật commentCount cho object
        pageRecipes.forEach((recipe) => {
          if (!recipe.id) return;
          var db = firebase.database();
          db.ref("comments/" + recipe.id)
            .once("value")
            .then(function (snap) {
              const comments = snap.val() || {};
              const count = Object.keys(comments).length;
              const el = document.querySelector(
                `.recipe-comments[data-id='${recipe.id}'] .comment-count`
              );
              if (el) el.textContent = count;
              // Cập nhật commentCount cho object để hỗ trợ sort
              recipe.commentCount = count;
            });
        });
        // Khởi tạo lại AOS sau khi render
        if (window.AOS && typeof AOS.init === "function") {
          AOS.init();
        }
        // Log số lượng card thực tế trong DOM
        setTimeout(() => {
          const cards = document.querySelectorAll(".recipe-card");
          console.log("Số lượng .recipe-card trong DOM:", cards.length);
        }, 100);
        renderPagination();
      }

      function renderPagination() {
        const totalPages = Math.ceil(filteredRecipes.length / PAGE_SIZE);
        const pagination = document.querySelector(".pagination");
        if (!pagination) return;
        let html = "";
        const maxPagesToShow = 5; // Số trang lân cận tối đa hiển thị quanh trang hiện tại
        if (totalPages <= 7) {
          // Hiển thị toàn bộ nếu ít trang
          for (let i = 1; i <= totalPages; i++) {
            html += `<li class="page-item${
              i === currentPage ? " active" : ""
            }"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
          }
        } else {
          // Trang đầu
          html += `<li class="page-item${
            currentPage === 1 ? " active" : ""
          }"><a class="page-link" href="#" data-page="1">1</a></li>`;
          // Dấu ... đầu
          if (currentPage > maxPagesToShow) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
          }
          // Các trang lân cận
          let start = Math.max(2, currentPage - 2);
          let end = Math.min(totalPages - 1, currentPage + 2);
          if (currentPage <= maxPagesToShow) {
            end = Math.max(end, maxPagesToShow);
          }
          if (currentPage >= totalPages - maxPagesToShow + 1) {
            start = Math.min(start, totalPages - maxPagesToShow);
          }
          for (let i = start; i <= end; i++) {
            html += `<li class="page-item${
              i === currentPage ? " active" : ""
            }"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
          }
          // Dấu ... cuối
          if (currentPage < totalPages - maxPagesToShow + 1) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
          }
          // Trang cuối
          html += `<li class="page-item${
            currentPage === totalPages ? " active" : ""
          }"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
        }
        pagination.innerHTML = html;
        // Sự kiện chuyển trang cho số trang
        pagination.querySelectorAll("a.page-link").forEach((link) => {
          link.onclick = function (e) {
            e.preventDefault();
            const page = this.getAttribute("data-page");
            if (!isNaN(Number(page))) {
              currentPage = Number(page);
              renderRecipes(currentPage);
            }
          };
        });
        // Sự kiện cho prev/next floating
        const prevBtn = document.getElementById("floatingPrevBtn");
        const nextBtn = document.getElementById("floatingNextBtn");
        if (prevBtn) prevBtn.disabled = currentPage === 1;
        if (nextBtn)
          nextBtn.disabled = currentPage === totalPages || totalPages === 0;
        if (prevBtn)
          prevBtn.onclick = function () {
            if (currentPage > 1) {
              currentPage--;
              renderRecipes(currentPage);
            }
          };
        if (nextBtn)
          nextBtn.onclick = function () {
            if (currentPage < totalPages) {
              currentPage++;
              renderRecipes(currentPage);
            }
          };
        // Ẩn/hiện prev/next nếu chỉ có 1 trang
        if (prevBtn) prevBtn.style.display = totalPages > 1 ? "flex" : "none";
        if (nextBtn) nextBtn.style.display = totalPages > 1 ? "flex" : "none";
      }

      renderRecipes(currentPage);

      // Filter functionality
      const filterBtns = document.querySelectorAll(".filter-btn");
      filterBtns.forEach((btn) => {
        btn.addEventListener("click", function () {
          filterBtns.forEach((b) => b.classList.remove("active"));
          this.classList.add("active");
          filterRecipesByCategory(this.textContent.trim());
        });
      });

      renderRecipes(currentPage);
    </script>
    <script>
      // --- TỰ ĐỘNG FILTER THEO QUERY CATEGORY ---
      (function () {
        const params = new URLSearchParams(window.location.search);
        const catSlug = params.get("category");
        if (catSlug) {
          // Map slug sang tên tiếng Việt đúng với filter-btn
          const slugToName = {
            "mon-chinh": "Món chính",
            "trang-mieng": "Món tráng miệng",
            "do-uong": "Đồ uống",
            "mon-chay": "Món chay",
            "an-vat": "Ăn vặt",
            "khai-vi": "Món khai vị",
            "mon-khai-vi": "Món khai vị", // Thêm dòng này để đồng bộ slug truyền từ index.html
          };
          const categoryName = slugToName[catSlug] || "Tất cả";
          // Kích hoạt filter-btn tương ứng
          const filterBtns = document.querySelectorAll(".filter-btn");
          filterBtns.forEach((btn) => {
            if (
              btn.textContent.trim().toLowerCase() ===
              categoryName.toLowerCase()
            ) {
              btn.classList.add("active");
            } else {
              btn.classList.remove("active");
            }
          });
          filterRecipesByCategory(categoryName);
        }
      })();
    </script>
    <script>
      // --- CLICK VÀO CARD ĐỂ ĐI ĐẾN TRANG CHI TIẾT ---
      document.addEventListener("DOMContentLoaded", function () {
        const grid = document.getElementById("recipeGrid");
        if (grid) {
          grid.addEventListener("click", function (e) {
            let card = e.target;
            // Tìm phần tử .recipe-card gần nhất
            while (card && !card.classList.contains("recipe-card")) {
              card = card.parentElement;
            }
            if (card && card.dataset.id) {
              window.location.href = `/pages/recipes/detail.html?id=${card.dataset.id}`;
            }
          });
        }
      });
    </script>
    <script>
      // --- AUTOCOMPLETE TÌM KIẾM CÔNG THỨC ---
      const searchInput = document.getElementById("searchInput");
      const autocompleteBox = document.getElementById("searchAutocomplete");
      let autocompleteItems = [];

      function updateAutocompleteList() {
        const val = searchInput.value.trim().toLowerCase();
        if (!val || !recipes || recipes.length === 0) {
          autocompleteBox.style.display = "none";
          return;
        }
        // Lấy gợi ý từ tên món và tag
        let suggestions = [];
        const titleSet = new Set();
        recipes.forEach((r) => {
          if (r.title && r.title.toLowerCase().includes(val)) {
            titleSet.add(r.title);
          }
          if (Array.isArray(r.tags)) {
            r.tags.forEach((tag) => {
              if (tag.toLowerCase().includes(val)) titleSet.add(tag);
            });
          }
        });
        suggestions = Array.from(titleSet).slice(0, 8); // Tối đa 8 gợi ý
        if (suggestions.length === 0) {
          autocompleteBox.style.display = "none";
          return;
        }
        autocompleteBox.innerHTML = suggestions
          .map(
            (s) =>
              `<div class='autocomplete-item px-3 py-2' style='cursor:pointer;'>${s.replace(
                new RegExp(val, "gi"),
                (m) => `<b>${m}</b>`
              )}</div>`
          )
          .join("");
        autocompleteBox.style.display = "block";
        autocompleteItems = suggestions;
      }
      searchInput.addEventListener("input", updateAutocompleteList);
      // Ẩn dropdown khi blur
      searchInput.addEventListener("blur", function () {
        setTimeout(() => (autocompleteBox.style.display = "none"), 150);
      });
      // Xử lý click chọn gợi ý
      autocompleteBox.addEventListener("mousedown", function (e) {
        if (e.target.classList.contains("autocomplete-item")) {
          const text = e.target.textContent;
          searchInput.value = text;
          autocompleteBox.style.display = "none";
          // Gọi hàm tìm kiếm nếu có
          if (typeof doFilterAndRender === "function") {
            doFilterAndRender();
          } else {
            // Nếu không có, filter thủ công
            filterByKeyword(text);
          }
        }
      });
      // Hàm filter thủ công nếu không có doFilterAndRender
      function filterByKeyword(keyword) {
        if (!keyword) {
          filteredRecipes = recipes;
        } else {
          filteredRecipes = recipes.filter(
            (r) =>
              (r.title &&
                r.title.toLowerCase().includes(keyword.toLowerCase())) ||
              (Array.isArray(r.tags) &&
                r.tags.some((tag) =>
                  tag.toLowerCase().includes(keyword.toLowerCase())
                ))
          );
        }
        currentPage = 1;
        renderRecipes(currentPage);
      }
    </script>
  </body>
</html>
