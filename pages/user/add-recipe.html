<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thêm Công Thức - Món Ngon Việt Nam</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/assets/css/pages/add-recipe.css" />
  </head>

  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top">
      <div class="container">
        <a class="navbar-brand" href="/index.html"> Món Ngon Việt Nam </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item">
              <a class="nav-link" href="../../index.html">Trang chủ</a>
            </li>
            <!-- Dropdown Công thức -->
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarRecipeDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Công thức
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarRecipeDropdown">
                <li>
                  <a class="dropdown-item" href="../recipes/list.html">
                    <i class="fas fa-list-ul"></i> Danh sách công thức
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="/pages/user/add-recipe.html">
                    <i class="fas fa-plus-circle"></i> Thêm công thức mới
                  </a>
                </li>
              </ul>
            </li>
            <!-- Dropdown Blog -->
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarBlogDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Blog
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarBlogDropdown">
                <li>
                  <a class="dropdown-item" href="../blog.html">
                    <i class="fas fa-book-open"></i> Danh sách blog
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="/pages/add-blog.html">
                    <i class="fas fa-pen-nib"></i> Thêm blog mới
                  </a>
                </li>
              </ul>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/pages/about.html">Về chúng tôi</a>
            </li>
            <li class="nav-item dropdown ms-2">
              <a
                class="nav-link dropdown-toggle d-flex align-items-center gap-2"
                href="#"
                id="navbarUserDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <img
                  src="/assets/images/users/avatar.jpg"
                  alt="Avatar"
                  class="rounded-circle"
                  width="32"
                  height="32"
                  id="navbarAvatar"
                />
                <span id="navbarUsername" class="fw-semibold"></span>
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="navbarUserDropdown"
              >
                <li>
                  <a class="dropdown-item" href="/pages/user/profile.html">
                    Trang cá nhân
                  </a>
                </li>
                <li>
                  <hr class="dropdown-divider" />
                </li>
                <li>
                  <a
                    class="dropdown-item text-danger"
                    href="#"
                    id="navbarLogout"
                  >
                    Đăng xuất
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Banner thông báo hệ thống chuyên nghiệp (import dùng chung) -->
    <div
      id="systemNotificationBar"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 9999;
        text-align: center;
        padding: 12px 0;
        background: rgba(255, 85, 85, 0.7);
        color: #fff;
        font-weight: 600;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: transform 0.5s, opacity 0.5s;
      "
    >
      <span id="systemNotificationText" style="font-size: 1.1em"></span>
      <button
        id="closeNotificationBar"
        style="
          position: absolute;
          right: 18px;
          top: 8px;
          background: none;
          border: none;
          color: #fff;
          font-size: 1.3em;
          cursor: pointer;
        "
      >
        &times;
      </button>
    </div>

    <!-- Page Header -->
    <header class="page-header">
      <div class="container">
        <h1 class="h2 fw-bold">Thêm Công Thức Mới</h1>
        <p class="text-muted mb-0">
          Chia sẻ công thức nấu ăn của bạn với cộng đồng
        </p>
      </div>
    </header>

    <!-- Main Content -->
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
          <form id="addRecipeForm">
            <!-- Basic Info Section -->
            <div class="form-section">
              <h3 class="section-title">Thông tin cơ bản</h3>
              <div class="row g-4">
                <div class="col-md-8">
                  <div class="mb-4">
                    <label class="form-label">Tên món ăn</label>
                    <input
                      type="text"
                      class="form-control"
                      name="title"
                      placeholder="Nhập tên món ăn"
                      required
                    />
                  </div>
                  <div class="mb-4">
                    <label class="form-label">Mô tả</label>
                    <textarea
                      class="form-control"
                      name="description"
                      rows="4"
                      placeholder="Mô tả ngắn về món ăn"
                      required
                    ></textarea>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-4">
                      <label class="form-label">Thời gian nấu (phút)</label>
                      <input
                        type="number"
                        class="form-control"
                        name="time"
                        placeholder="Số phút"
                        required
                      />
                    </div>
                    <div class="col-md-6 mb-4">
                      <label class="form-label">Khẩu phần</label>
                      <input
                        type="number"
                        class="form-control"
                        name="servings"
                        placeholder="Số người"
                        required
                      />
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-4">
                      <label class="form-label">Độ khó</label>
                      <select class="form-select" name="difficulty">
                        <option value="Dễ">Dễ</option>
                        <option value="Trung bình">Trung bình</option>
                        <option value="Khó">Khó</option>
                      </select>
                    </div>
                    <div class="col-md-6 mb-4 position-relative">
                      <label class="form-label"
                        >Calories
                        <i
                          class="fas fa-info-circle text-info ms-1"
                          tabindex="0"
                          data-bs-toggle="tooltip"
                          data-bs-placement="top"
                          title="Calories sẽ tự động tính sau khi bạn nhập nguyên liệu và khẩu phần. Nếu bạn nhập thủ công, hệ thống sẽ cảnh báo nếu khác biệt lớn."
                        ></i>
                      </label>
                      <input
                        type="number"
                        class="form-control"
                        name="calories"
                        id="caloriesInput"
                        placeholder="Số calories"
                        min="0"
                        step="any"
                      />
                      <div
                        id="caloriesAutoInfo"
                        class="form-text text-success"
                        style="display: none"
                      ></div>
                      <!-- Bảng calories từng nguyên liệu, tối đa 3-5 nguyên liệu đầu, có nút Xem thêm nếu nhiều -->
                      <div
                        id="ingredientCaloriesTable"
                        class="mt-2"
                        style="display: none"
                      ></div>
                      <div
                        id="caloriesWarning"
                        class="text-warning small mt-1"
                        style="display: none"
                      ></div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Hình ảnh món ăn</label>
                  <div class="image-upload" id="imageUpload">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p class="mb-2">Kéo thả hoặc click để tải ảnh lên</p>
                    <small class="text-muted"
                      >PNG, JPG hoặc JPEG (tối đa 5MB)</small
                    >
                    <input
                      type="file"
                      id="imageInput"
                      name="image"
                      hidden
                      accept="image/*"
                    />
                  </div>
                  <img
                    id="previewImage"
                    class="preview-image"
                    style="display: none; cursor: pointer"
                    alt="Preview"
                  />
                  <!-- Modal xem ảnh lớn -->
                  <div
                    class="modal fade"
                    id="imagePreviewModal"
                    tabindex="-1"
                    aria-labelledby="imagePreviewModalLabel"
                    aria-hidden="true"
                  >
                    <div class="modal-dialog modal-dialog-centered">
                      <div
                        class="modal-content bg-transparent border-0 shadow-none"
                      >
                        <button
                          type="button"
                          class="btn-close position-absolute top-0 end-0 m-3 bg-white rounded-circle p-2"
                          data-bs-dismiss="modal"
                          aria-label="Đóng"
                        ></button>
                        <img
                          id="modalLargeImage"
                          src=""
                          alt="Ảnh lớn"
                          class="img-fluid rounded shadow"
                          style="max-height: 80vh; object-fit: contain"
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Ingredients Section -->
            <div class="form-section">
              <h3 class="section-title">Nguyên liệu</h3>
              <div id="ingredientsList">
                <div class="ingredient-item">
                  <input
                    type="text"
                    class="form-control"
                    name="ingredientName[]"
                    placeholder="Tên nguyên liệu"
                    list="ingredientSuggestions"
                  />
                  <input
                    type="text"
                    class="form-control"
                    name="ingredientAmount[]"
                    placeholder="Số lượng"
                  />
                  <button type="button" class="remove-btn">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
              <button type="button" class="add-btn mt-3" id="addIngredient">
                <i class="fas fa-plus"></i>
                Thêm nguyên liệu
              </button>
              <!-- Thêm datalist cho autocomplete nguyên liệu -->
              <datalist id="ingredientSuggestions"></datalist>
            </div>

            <!-- Steps Section -->
            <div class="form-section">
              <h3 class="section-title">Các bước thực hiện</h3>
              <div id="stepsList">
                <div class="step-card">
                  <div class="step-number">1</div>
                  <textarea
                    class="form-control"
                    name="stepDesc[]"
                    rows="3"
                    placeholder="Mô tả bước thực hiện"
                  ></textarea>
                </div>
              </div>
              <button type="button" class="add-btn mt-3" id="addStep">
                <i class="fas fa-plus"></i>
                Thêm bước
              </button>
            </div>

            <!-- Tags Section (Phân loại) -->
            <div class="form-section">
              <h3 class="section-title">Phân loại</h3>
              <label class="form-label"
                >Chọn các danh mục phù hợp với món ăn</label
              >
              <div class="tag-select" id="tagSelect">
                <button type="button" class="tag-item" data-value="Món chính">
                  Món chính
                </button>
                <button
                  type="button"
                  class="tag-item"
                  data-value="Món tráng miệng"
                >
                  Món tráng miệng
                </button>
                <button type="button" class="tag-item" data-value="Đồ uống">
                  Đồ uống
                </button>
                <button type="button" class="tag-item" data-value="Món chay">
                  Món chay
                </button>
                <button type="button" class="tag-item" data-value="Ăn vặt">
                  Ăn vặt
                </button>
                <button type="button" class="tag-item" data-value="Món khai vị">
                  Món khai vị
                </button>
              </div>
              <input type="hidden" name="tags" id="tagsInput" />
            </div>

            <!-- Rating Section (Trực quan) -->
            <div class="form-section">
              <h3 class="section-title">Đánh giá của bạn (tùy chọn)</h3>
              <div class="mb-3">
                <label class="form-label">Chấm điểm món ăn này</label>
                <div
                  id="ratingStars"
                  style="font-size: 2rem; color: #fab207; cursor: pointer"
                >
                  <i class="far fa-star" data-value="1"></i>
                  <i class="far fa-star" data-value="2"></i>
                  <i class="far fa-star" data-value="3"></i>
                  <i class="far fa-star" data-value="4"></i>
                  <i class="far fa-star" data-value="5"></i>
                </div>
                <input type="hidden" name="rating" id="ratingInput" />
              </div>
            </div>

            <!-- Submit Button -->
            <div class="text-center mb-5 d-flex justify-content-center gap-3">
              <button
                type="button"
                class="btn btn-outline-primary preview-btn"
                id="previewRecipeBtn"
              >
                <i class="fas fa-eye me-2"></i>Xem trước
              </button>
              <button type="submit" class="submit-btn">
                <i class="fas fa-paper-plane me-2"></i>
                Đăng công thức
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer
      class="footer mt-5 py-5"
      style="
        background: linear-gradient(
          45deg,
          var(--primary-color),
          var(--secondary-color)
        );
      "
    >
      <div class="container">
        <div class="row g-4">
          <div class="col-lg-4">
            <h5 class="mb-3 fw-bold text-white">Về Chúng Tôi</h5>
            <p class="mb-4 text-white">
              Món Ngon Việt Nam là cộng đồng chia sẻ công thức nấu ăn lớn nhất
              Việt Nam, nơi kết nối những người đam mê ẩm thực.
            </p>
            <div class="social-links d-flex gap-3">
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-facebook-f"></i
              ></a>
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-instagram"></i
              ></a>
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-youtube"></i
              ></a>
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-tiktok"></i
              ></a>
            </div>
          </div>
          <div class="col-lg-2">
            <h5 class="mb-3 fw-bold text-white">Khám Phá</h5>
            <ul class="list-unstyled">
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html"
                  class="text-white text-decoration-none"
                  >Công thức</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/blog.html"
                  class="text-white text-decoration-none"
                  >Blog</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/about.html"
                  class="text-white text-decoration-none"
                  >Về chúng tôi</a
                >
              </li>
              <li class="mb-2">
                <a href="#" class="text-white text-decoration-none">Liên hệ</a>
              </li>
            </ul>
          </div>
          <div class="col-lg-3">
            <h5 class="mb-3 fw-bold text-white">Danh Mục</h5>
            <ul class="list-unstyled">
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html?category=mon-chinh"
                  class="text-white text-decoration-none"
                  >Món chính</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html?category=trang-mieng"
                  class="text-white text-decoration-none"
                  >Món tráng miệng</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html?category=do-uong"
                  class="text-white text-decoration-none"
                  >Đồ uống</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html?category=mon-chay"
                  class="text-white text-decoration-none"
                  >Món chay</a
                >
              </li>
            </ul>
          </div>
          <div class="col-lg-3">
            <h5 class="mb-3 fw-bold text-white">Liên Hệ</h5>
            <ul class="list-unstyled text-white">
              <li class="mb-2">
                <i class="fas fa-envelope me-2"></i> lienhe@monngon.vn
              </li>
              <li class="mb-2">
                <i class="fas fa-phone me-2"></i> 0123.456.789
              </li>
              <li class="mb-2">
                <i class="fas fa-map-marker-alt me-2"></i> Hà Nội, Việt Nam
              </li>
            </ul>
          </div>
        </div>
        <hr class="my-4 bg-white" />
        <div class="text-center text-white">
          <p class="mb-0">© 2024 Món Ngon Việt Nam. Đã đăng ký bản quyền.</p>
        </div>
      </div>
    </footer>

    <!-- Modal Preview Recipe -->
    <div
      class="modal fade"
      id="previewRecipeModal"
      tabindex="-1"
      aria-labelledby="previewRecipeModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="previewRecipeModalLabel">
              Xem trước công thức
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Đóng"
            ></button>
          </div>
          <div class="modal-body" id="previewRecipeContent">
            <!-- Nội dung xem trước sẽ được render bằng JS -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Đóng
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Xem Toàn Bộ Mô Tả -->
    <div
      class="modal fade"
      id="descFullModal"
      tabindex="-1"
      aria-labelledby="descFullModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="descFullModalLabel">Mô tả đầy đủ</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Đóng"
            ></button>
          </div>
          <div class="modal-body" id="descFullModalBody"></div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="/assets/js/firebase-config.js"></script>
    <script type="module" src="/assets/js/add-recipe.js"></script>
    <script src="/assets/js/notification-bar.js"></script>
    <script>
      // Kiểm tra user đăng nhập khi vào trang
      (function () {
        let currentUser = null;
        if (window.getCurrentUser) {
          currentUser = window.getCurrentUser();
        } else {
          try {
            currentUser =
              JSON.parse(sessionStorage.getItem("currentUser")) ||
              JSON.parse(localStorage.getItem("currentUser"));
          } catch (e) {}
        }
        if (!currentUser || !currentUser.username) {
          window.location.href =
            "/pages/auth/login.html?redirect=/pages/user/add-recipe.html";
        } else {
          // Gán username vào đúng vị trí dropdown avatar nếu có
          const navbarUsername = document.getElementById("navbarUsername");
          if (navbarUsername) {
            navbarUsername.textContent = currentUser.username;
          }
        }
      })();

      // Image upload preview & validation
      const imageUpload = document.getElementById("imageUpload");
      const imageInput = document.getElementById("imageInput");
      const previewImage = document.getElementById("previewImage");
      let imageError = null;
      if (imageUpload && !imageError) {
        imageError = document.createElement("div");
        imageError.className = "text-danger small mt-2";
        imageError.style.display = "none";
        imageUpload.parentNode.appendChild(imageError);
      }
      imageUpload.addEventListener("click", () => imageInput.click());
      imageInput.addEventListener("change", function () {
        imageError.style.display = "none";
        previewImage.style.display = "none";
        const file = this.files[0];
        if (file) {
          const validTypes = ["image/png", "image/jpeg", "image/jpg"];
          if (!validTypes.includes(file.type)) {
            imageError.textContent = "Chỉ chấp nhận ảnh PNG, JPG hoặc JPEG.";
            imageError.style.display = "block";
            this.value = "";
            return;
          }
          if (file.size > 5 * 1024 * 1024) {
            imageError.textContent = "Dung lượng ảnh tối đa 5MB.";
            imageError.style.display = "block";
            this.value = "";
            return;
          }
          const reader = new FileReader();
          reader.onload = function (e) {
            previewImage.src = e.target.result;
            previewImage.style.display = "block";
          };
          reader.readAsDataURL(file);
        }
      });

      // Add ingredient
      document
        .getElementById("addIngredient")
        .addEventListener("click", function () {
          const ingredientItem = document.createElement("div");
          ingredientItem.className = "ingredient-item";
          ingredientItem.innerHTML = `
                <input type="text" class="form-control" name="ingredientName[]" placeholder="Tên nguyên liệu" list="ingredientSuggestions">
                <input type="text" class="form-control" name="ingredientAmount[]" placeholder="Số lượng">
                <button type="button" class="remove-btn"><i class="fas fa-times"></i></button>
            `;
          document
            .getElementById("ingredientsList")
            .appendChild(ingredientItem);

          // Add remove functionality
          ingredientItem
            .querySelector(".remove-btn")
            .addEventListener("click", function () {
              ingredientItem.remove();
            });
        });

      // Add step
      document.getElementById("addStep").addEventListener("click", function () {
        const stepsCount = document.querySelectorAll(".step-card").length + 1;
        const stepCard = document.createElement("div");
        stepCard.className = "step-card";
        stepCard.innerHTML = `
                <div class="step-number">${stepsCount}</div>
                <textarea class="form-control" name="stepDesc[]" rows="3" placeholder="Mô tả bước thực hiện"></textarea>
                <button type="button" class="btn btn-outline-danger btn-sm rounded-circle shadow-sm remove-step-btn ms-2" title="Xóa bước"><i class="fas fa-trash-alt"></i></button>
            `;
        document.getElementById("stepsList").appendChild(stepCard);
        // Thêm sự kiện xóa bước
        stepCard
          .querySelector(".remove-step-btn")
          .addEventListener("click", function () {
            removeStep(stepCard);
          });
        // Kích hoạt drag & drop cho bước mới
        enableStepDragDrop();
      });

      // ===== DRAG & DROP STEP-CARD =====
      function enableStepDragDrop() {
        const stepsList = document.getElementById("stepsList");
        if (!stepsList) return;
        let dragSrc = null;
        stepsList.querySelectorAll(".step-card").forEach((card) => {
          card.setAttribute("draggable", "true");
          card.ondragstart = function (e) {
            dragSrc = card;
            card.classList.add("dragging");
            e.dataTransfer.effectAllowed = "move";
          };
          card.ondragend = function () {
            card.classList.remove("dragging");
            dragSrc = null;
            updateStepNumbers();
            rebindRemoveStepBtn();
          };
          card.ondragover = function (e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = "move";
            card.classList.add("drag-over");
          };
          card.ondragleave = function () {
            card.classList.remove("drag-over");
          };
          card.ondrop = function (e) {
            e.preventDefault();
            card.classList.remove("drag-over");
            if (dragSrc && dragSrc !== card) {
              // Nếu thả lên chính nó thì bỏ qua
              // Nếu thả lên phần tử đầu tiên, cho phép chuyển lên đầu
              const cards = Array.from(stepsList.children);
              if (card === cards[0]) {
                stepsList.insertBefore(dragSrc, card);
              } else {
                stepsList.insertBefore(dragSrc, card.nextSibling);
              }
              updateStepNumbers();
              rebindRemoveStepBtn();
            }
          };
        });
      }
      function rebindRemoveStepBtn() {
        // Gán lại sự kiện xóa cho tất cả các nút xóa
        document
          .querySelectorAll("#stepsList .remove-step-btn")
          .forEach((btn) => {
            btn.onclick = function () {
              const stepCard = btn.closest(".step-card");
              if (stepCard) removeStep(stepCard);
            };
          });
      }
      function removeStep(stepCard) {
        const stepsList = document.getElementById("stepsList");
        if (!stepsList) return;
        const allSteps = stepsList.querySelectorAll(".step-card");
        if (allSteps.length <= 1) {
          alert("Phải có ít nhất 1 bước thực hiện.");
          return;
        }
        stepCard.remove();
        updateStepNumbers();
        rebindRemoveStepBtn();
      }
      function updateStepNumbers() {
        document
          .querySelectorAll("#stepsList .step-card")
          .forEach((step, idx) => {
            const num = step.querySelector(".step-number");
            if (num) num.textContent = idx + 1;
          });
      }
      // Kích hoạt drag & drop khi load và khi thêm bước mới
      (function () {
        enableStepDragDrop();
        rebindRemoveStepBtn();
        // Khi thêm bước mới thì enable lại drag & drop và gán lại nút xóa
        const addStepBtn = document.getElementById("addStep");
        if (addStepBtn) {
          const oldHandler = addStepBtn.onclick;
          addStepBtn.addEventListener("click", function () {
            setTimeout(() => {
              enableStepDragDrop();
              rebindRemoveStepBtn();
            }, 10);
            if (typeof oldHandler === "function") oldHandler();
          });
        }
      })();

      // Tag selection logic: lưu các tag đã chọn vào input ẩn
      const tagSelect = document.getElementById("tagSelect");
      const tagsInput = document.getElementById("tagsInput");
      if (tagSelect && tagsInput) {
        tagSelect.querySelectorAll(".tag-item").forEach((tag) => {
          tag.addEventListener("click", function () {
            this.classList.toggle("active");
            const selected = Array.from(
              tagSelect.querySelectorAll(".tag-item.active")
            ).map((t) => t.dataset.value);
            tagsInput.value = selected.join(",");
          });
        });
      }

      // Rating stars logic: chọn số sao trực quan
      const ratingStars = document.getElementById("ratingStars");
      const ratingInput = document.getElementById("ratingInput");
      if (ratingStars && ratingInput) {
        ratingStars.querySelectorAll("i").forEach((star) => {
          star.addEventListener("mouseenter", function () {
            const val = +this.dataset.value;
            ratingStars.querySelectorAll("i").forEach((s, i) => {
              s.classList.toggle("fas", i < val);
              s.classList.toggle("far", i >= val);
            });
          });
          star.addEventListener("mouseleave", function () {
            const current = +ratingInput.value || 0;
            ratingStars.querySelectorAll("i").forEach((s, i) => {
              s.classList.toggle("fas", i < current);
              s.classList.toggle("far", i >= current);
            });
          });
          star.addEventListener("click", function () {
            const val = +this.dataset.value;
            ratingInput.value = val;
            ratingStars.querySelectorAll("i").forEach((s, i) => {
              s.classList.toggle("fas", i < val);
              s.classList.toggle("far", i >= val);
            });
          });
        });
        // Khởi tạo trạng thái sao
        ratingStars.dispatchEvent(new Event("mouseleave"));
      }

      // Thêm hiển thị lỗi và xác thực nâng cao cho form đăng công thức
      (function () {
        const form = document.getElementById("addRecipeForm");
        if (!form) return;

        // Tạo các phần tử báo lỗi cho các trường chính
        const titleInput = form.querySelector('input[name="title"]');
        const descInput = form.querySelector('textarea[name="description"]');
        const timeInput = form.querySelector('input[name="time"]');
        const servingsInput = form.querySelector('input[name="servings"]');

        // Thêm vùng báo lỗi
        [titleInput, descInput, timeInput, servingsInput].forEach((input) => {
          if (input) {
            const err = document.createElement("div");
            err.className = "text-danger small mt-1";
            err.style.display = "none";
            input.parentNode.appendChild(err);
            input._err = err;
          }
        });

        // Bộ đếm ký tự cho mô tả
        if (descInput) {
          const counter = document.createElement("div");
          counter.className = "text-end text-muted small";
          counter.style.fontSize = "0.9em";
          descInput.parentNode.appendChild(counter);
          const maxLen = 500;
          descInput.maxLength = maxLen;
          descInput.addEventListener("input", function () {
            counter.textContent = `${this.value.length}/${maxLen} ký tự`;
          });
          descInput.dispatchEvent(new Event("input"));
        }

        // Xác thực khi submit
        form.addEventListener("submit", function (e) {
          let valid = true;
          let firstErrorInput = null;
          let errorMessages = [];
          [titleInput, descInput, timeInput, servingsInput].forEach((input) => {
            if (input && input._err) input._err.style.display = "none";
          });
          if (titleInput && !titleInput.value.trim()) {
            titleInput._err.textContent = "Vui lòng nhập tên món ăn.";
            titleInput._err.style.display = "block";
            valid = false;
            if (!firstErrorInput) firstErrorInput = titleInput;
            errorMessages.push("Vui lòng nhập tên món ăn.");
          }
          if (descInput && !descInput.value.trim()) {
            descInput._err.textContent = "Vui lòng nhập mô tả.";
            descInput._err.style.display = "block";
            valid = false;
            if (!firstErrorInput) firstErrorInput = descInput;
            errorMessages.push("Vui lòng nhập mô tả.");
          }
          if (timeInput && (!timeInput.value || +timeInput.value <= 0)) {
            timeInput._err.textContent = "Thời gian phải lớn hơn 0.";
            timeInput._err.style.display = "block";
            valid = false;
            if (!firstErrorInput) firstErrorInput = timeInput;
            errorMessages.push("Thời gian phải lớn hơn 0.");
          }
          if (
            servingsInput &&
            (!servingsInput.value || +servingsInput.value <= 0)
          ) {
            servingsInput._err.textContent = "Khẩu phần phải lớn hơn 0.";
            servingsInput._err.style.display = "block";
            valid = false;
            if (!firstErrorInput) firstErrorInput = servingsInput;
            errorMessages.push("Khẩu phần phải lớn hơn 0.");
          }
          // Kiểm tra nguyên liệu
          const ingredientNames = form.querySelectorAll(
            'input[name="ingredientName[]"]'
          );
          let hasIngredient = false;
          ingredientNames.forEach((i) => {
            if (i.value.trim()) hasIngredient = true;
          });
          if (!hasIngredient) {
            errorMessages.push("Vui lòng nhập ít nhất 1 nguyên liệu.");
            valid = false;
          }
          // Kiểm tra bước thực hiện
          const stepDescs = form.querySelectorAll(
            'textarea[name="stepDesc[]"]'
          );
          let hasStep = false;
          stepDescs.forEach((i) => {
            if (i.value.trim()) hasStep = true;
          });
          if (!hasStep) {
            errorMessages.push("Vui lòng nhập ít nhất 1 bước thực hiện.");
            valid = false;
          }
          if (!valid) {
            e.preventDefault();
            // Hiển thị thông báo tổng hợp ở đầu form
            let alertBox = document.getElementById("formErrorAlert");
            if (!alertBox) {
              alertBox = document.createElement("div");
              alertBox.id = "formErrorAlert";
              alertBox.className = "alert alert-danger";
              form.prepend(alertBox);
            }
            alertBox.innerHTML = errorMessages
              .map((msg) => `<div>${msg}</div>`)
              .join("");
            alertBox.style.display = "block";
            if (firstErrorInput) {
              firstErrorInput.focus();
              firstErrorInput.scrollIntoView({
                behavior: "smooth",
                block: "center",
              });
            }
            return false;
          } else {
            // Ẩn alert nếu hợp lệ
            let alertBox = document.getElementById("formErrorAlert");
            if (alertBox) alertBox.style.display = "none";
          }
        });
      })();

      // Form submission
      const addRecipeForm = document.getElementById("addRecipeForm");
      if (addRecipeForm) {
        const submitBtn = addRecipeForm.querySelector(".submit-btn");
        let isSubmitting = false;
        addRecipeForm.addEventListener("submit", async function (e) {
          e.preventDefault();
          if (isSubmitting) return false;
          isSubmitting = true;
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML =
              '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Đang gửi...';
          }
          // Lấy dữ liệu form
          const form = addRecipeForm;
          const title = form.querySelector('input[name="title"]').value.trim();
          const desc = form
            .querySelector('textarea[name="description"]')
            .value.trim();
          const time = form.querySelector('input[name="time"]').value.trim();
          const servings = form
            .querySelector('input[name="servings"]')
            .value.trim();
          const difficulty = form.querySelector(
            'select[name="difficulty"]'
          ).value;
          const calories = form
            .querySelector('input[name="calories"]')
            .value.trim();
          const tags = form
            .querySelector("#tagsInput")
            .value.split(",")
            .filter(Boolean);
          const rating = form.querySelector("#ratingInput").value;
          // Ảnh (chỉ lưu tên file, hoặc base64 nếu muốn demo, thực tế nên upload lên storage)
          let imgBase64 = "";
          const file = form.querySelector("#imageInput").files[0];
          if (file) {
            imgBase64 = await new Promise((resolve) => {
              const reader = new FileReader();
              reader.onload = (e) => resolve(e.target.result);
              reader.readAsDataURL(file);
            });
          }
          // Nguyên liệu
          const ingredients = Array.from(
            form.querySelectorAll(".ingredient-item")
          )
            .map((item) => {
              return {
                name: item
                  .querySelector('input[name="ingredientName[]"]')
                  .value.trim(),
                amount: item
                  .querySelector('input[name="ingredientAmount[]"]')
                  .value.trim(),
              };
            })
            .filter((i) => i.name);
          // Bước thực hiện
          const steps = Array.from(form.querySelectorAll(".step-card"))
            .map((card, idx) => {
              return {
                number: idx + 1,
                desc: card
                  .querySelector('textarea[name="stepDesc[]"]')
                  .value.trim(),
              };
            })
            .filter((s) => s.desc);
          // Lấy user hiện tại
          let currentUser = null;
          if (window.getCurrentUser) {
            currentUser = window.getCurrentUser();
          } else {
            try {
              currentUser =
                JSON.parse(sessionStorage.getItem("currentUser")) ||
                JSON.parse(localStorage.getItem("currentUser"));
            } catch (e) {
              currentUser = null;
            }
          }
          // Chuẩn bị object recipe
          const recipe = {
            title,
            description: desc,
            time: Number(time),
            servings: Number(servings),
            difficulty,
            calories: calories ? Number(calories) : null,
            tags,
            rating: rating ? Number(rating) : null,
            image: imgBase64, // base64 demo, thực tế nên upload lên storage và lưu url
            ingredients,
            steps,
            createdAt: Date.now(),
            pending: true, // admin duyệt mới hiển thị
            author: currentUser
              ? {
                  username: currentUser.username,
                  name: currentUser.name || "",
                  email: currentUser.email || "",
                }
              : "Ẩn danh",
          };
          // Lưu lên Firebase
          try {
            const db = firebase.database();
            const newRef = db.ref("recipes").push();
            await newRef.set(recipe);
            // Thông báo thành công
            alert("Công thức đã được gửi thành công! Chờ admin duyệt.");
            // Reset form
            addRecipeForm.reset();
            // Reset preview image
            const previewImg = document.getElementById("previewImage");
            if (previewImg) previewImg.style.display = "none";
          } catch (err) {
            alert("Có lỗi xảy ra khi gửi công thức. Vui lòng thử lại!");
          }
          isSubmitting = false;
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML =
              '<i class="fas fa-paper-plane me-2"></i>Đăng công thức';
          }
        });
      }

      // --- XEM TRƯỚC CÔNG THỨC ---
      (function () {
        const previewBtn = document.getElementById("previewRecipeBtn");
        const previewModal = document.getElementById("previewRecipeModal");
        const previewContent = document.getElementById("previewRecipeContent");
        const form = document.getElementById("addRecipeForm");
        // Modal xem mô tả đầy đủ
        const descFullModal = document.getElementById("descFullModal");
        const descFullModalBody = document.getElementById("descFullModalBody");
        // Focus trap cho modal preview và modal mô tả đầy đủ
        function trapFocus(modal) {
          const focusable = modal.querySelectorAll(
            'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
          );
          if (!focusable.length) return;
          const first = focusable[0];
          const last = focusable[focusable.length - 1];
          modal.addEventListener("keydown", function (e) {
            if (e.key === "Tab") {
              if (e.shiftKey) {
                if (document.activeElement === first) {
                  e.preventDefault();
                  last.focus();
                }
              } else {
                if (document.activeElement === last) {
                  e.preventDefault();
                  first.focus();
                }
              }
            }
            if (e.key === "Escape") {
              bootstrap.Modal.getInstance(modal)?.hide();
            }
          });
        }
        if (previewModal) {
          previewModal.addEventListener("shown.bs.modal", function () {
            // Focus vào nút đóng đầu tiên
            const closeBtn = previewModal.querySelector(".btn-close");
            if (closeBtn) closeBtn.focus();
            trapFocus(previewModal);
          });
        }
        if (descFullModal) {
          descFullModal.addEventListener("shown.bs.modal", function () {
            const closeBtn = descFullModal.querySelector(".btn-close");
            if (closeBtn) closeBtn.focus();
            trapFocus(descFullModal);
          });
        }
        previewBtn.addEventListener("click", function () {
          // Lấy dữ liệu form
          const title = form.querySelector('input[name="title"]').value.trim();
          const desc = form
            .querySelector('textarea[name="description"]')
            .value.trim();
          const time = form.querySelector('input[name="time"]').value.trim();
          const servings = form
            .querySelector('input[name="servings"]')
            .value.trim();
          const difficulty = form.querySelector(
            'select[name="difficulty"]'
          ).value;
          const calories = form
            .querySelector('input[name="calories"]')
            .value.trim();
          const tags = form
            .querySelector("#tagsInput")
            .value.split(",")
            .filter(Boolean);
          const rating = form.querySelector("#ratingInput").value;
          // Ảnh
          let imgSrc = "";
          const file = form.querySelector("#imageInput").files[0];
          if (file) {
            imgSrc = URL.createObjectURL(file);
          } else {
            const previewImg = form.querySelector("#previewImage");
            if (
              previewImg &&
              previewImg.src &&
              previewImg.style.display !== "none"
            ) {
              imgSrc = previewImg.src;
            }
          }
          // Nguyên liệu
          const ingredients = Array.from(
            form.querySelectorAll(".ingredient-item")
          )
            .map((item) => {
              return {
                name: item
                  .querySelector('input[name="ingredientName[]"]')
                  .value.trim(),
                amount: item
                  .querySelector('input[name="ingredientAmount[]"]')
                  .value.trim(),
              };
            })
            .filter((i) => i.name);
          // Bước thực hiện
          const steps = Array.from(form.querySelectorAll(".step-card"))
            .map((card, idx) => {
              return {
                number: idx + 1,
                desc: card
                  .querySelector('textarea[name="stepDesc[]"]')
                  .value.trim(),
              };
            })
            .filter((s) => s.desc);
          // Render HTML preview
          // Render tag danh mục món ăn với style 'tag-item active'
          const tagHtml = tags
            .map((t) => `<span class='tag-item1 active me-1 mb-1'>${t}</span>`)
            .join("");
          // Render ảnh: chỉ hiển thị nếu có ảnh
          let imgHtml = "";
          if (imgSrc) {
            imgHtml = `<img src='${imgSrc}' class='img-fluid rounded mb-3' style='max-height:220px;object-fit:cover;'/>`;
          }
          let html = `<div class='row'><div class='col-md-4'>${imgHtml}</div><div class='col-md-8'><h3 class='fw-bold mb-1'>${
            title || "(Chưa nhập tên món)"
          }</h3><div class='mb-2 text-muted fs-5 preview-desc'>${
            desc || "(Chưa nhập mô tả)"
          }</div><div class='mb-2'><span class='badge bg-primary me-2 fs-6'><i class='fas fa-clock me-1'></i> ${time} phút</span><span class='badge bg-success me-2 fs-6'><i class='fas fa-utensils me-1'></i> ${servings} người</span>`;
          if (difficulty) {
            html += `<span class='badge bg-warning text-dark fs-6'><i class='fas fa-tasks me-1'></i> ${difficulty}</span>`;
          }
          if (calories) {
            html += `<span class='badge bg-info text-dark fs-6 ms-2'><i class='fas fa-fire me-1'></i> ${calories} cal</span>`;
          }
          html += `</div>`;
          // Render nguyên liệu
          if (ingredients.length) {
            html += `<h5 class='fw-semibold'>Nguyên liệu:</h5><ul class='list-unstyled'>`;
            ingredients.forEach((ing) => {
              if (ing.name) {
                html += `<li class='mb-2'><i class='fas fa-check-circle text-success me-2'></i>${ing.name} ${ing.amount}</li>`;
              }
            });
            html += `</ul>`;
          }
          // Render bước thực hiện
          if (steps.length) {
            html += `<h5 class='fw-semibold'>Các bước thực hiện:</h5>`;
            steps.forEach((step) => {
              html += `<div class='d-flex mb-3'><div class='step-number rounded-circle d-flex align-items-center justify-content-center me-3' style='width: 40px; height: 40px; background-color: #007bff; color: white;'>${step.number}</div><div class='flex-grow-1'>${step.desc}</div></div>`;
            });
          }
          // Render đánh giá
          if (rating) {
            html += `<div class='mb-3'><span class='fw-semibold'>Đánh giá của bạn:</span>`;
            for (let i = 1; i <= 5; i++) {
              if (i <= rating) {
                html += `<i class='fas fa-star' style='color: #fab207'></i>`;
              } else {
                html += `<i class='far fa-star'></i>`;
              }
            }
            html += `</div>`;
          }
          // Gán HTML vào modal preview
          previewContent.innerHTML = html;
          // Mở modal preview
          const modal = new bootstrap.Modal(previewModal);
          modal.show();
        });
      })();

      // Hàm chia sẻ công thức lên mạng xã hội (chưa triển khai)
      function shareRecipe(title, desc, img) {
        alert(
          "Chia sẻ công thức: " +
            decodeURIComponent(title) +
            "\nMô tả: " +
            decodeURIComponent(desc) +
            "\nHình ảnh: " +
            img
        );
      }

      // Xử lý nút Đăng xuất trong dropdown user
      const logoutBtn = document.getElementById("navbarLogout");
      if (logoutBtn) {
        logoutBtn.onclick = function (e) {
          e.preventDefault();
          sessionStorage.removeItem("currentUser");
          localStorage.removeItem("currentUser");
          window.location.href = "/pages/auth/login.html";
        };
      }
    </script>
  </body>
</html>
