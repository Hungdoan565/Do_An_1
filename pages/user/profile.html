<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trang Cá Nhân - Món Ngon Việt Nam</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/assets/css/pages/profile.css" />
    <link rel="stylesheet" href="/assets/css/pages/list.css" />
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top">
      <div class="container">
        <a class="navbar-brand" href="/index.html">
          <img
            src="/assets/images/logo.png"
            height="40"
            class="me-2"
            alt="Logo"
          />
          Món Ngon Việt Nam
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item">
              <a class="nav-link" href="../../index.html">Trang chủ</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../recipes/list.html">Công thức</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../blog.html">Blog</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../about.html">Về chúng tôi</a>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle d-flex align-items-center gap-2"
                href="#"
                id="navbarUserDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <img
                  src="/assets/images/users/avatar.jpg"
                  alt="Avatar"
                  class="rounded-circle"
                  width="32"
                  height="32"
                  id="navbarAvatar"
                />
                <span id="navbarUsername" class="fw-semibold"></span>
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="navbarUserDropdown"
              >
                <li>
                  <a class="dropdown-item" href="/pages/user/profile.html">
                    Trang cá nhân
                  </a>
                </li>
                <li>
                  <hr class="dropdown-divider" />
                </li>
                <li>
                  <a
                    class="dropdown-item text-danger"
                    href="#"
                    id="navbarLogout"
                  >
                    Đăng xuất
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- Profile Section Start -->
    <section class="profile-admin-layout">
      <div class="container-fluid">
        <div class="row">
          <!-- Sidebar -->
          <div
            class="col-lg-2 col-md-3 sidebar d-flex flex-column align-items-start pt-5"
          >
            <h4 class="fw-bold mb-4" id="sidebarUsername">
              <i class="fas fa-user-circle me-2"></i>
              <!-- Tên user sẽ được JS render vào đây -->
            </h4>
            <nav class="nav flex-column w-100">
              <a class="nav-link active" data-tab="profile-info"
                ><i class="fas fa-user me-2"></i>Thông tin</a
              >
              <a class="nav-link" data-tab="my-recipes"
                ><i class="fas fa-utensils me-2"></i>Công thức của tôi</a
              >
              <a class="nav-link" data-tab="favorite"
                ><i class="fas fa-heart me-2"></i>Yêu thích</a
              >
              <a class="nav-link" data-tab="settings"
                ><i class="fas fa-cog me-2"></i>Cài đặt</a
              >
            </nav>
          </div>
          <!-- Main Content -->
          <div class="col-lg-10 col-md-9 px-4 pt-5">
            <div class="admin-header mb-4"></div>
            <!-- Thông tin Tab -->
            <div class="tab-section active" id="tab-profile-info">
              <div class="row mb-4 align-items-center">
                <div class="col-md-4 text-center">
                  <img
                    id="infoAvatar"
                    src="/assets/images/users/avatar.jpg"
                    alt="Avatar"
                    style="
                      width: 100px;
                      height: 100px;
                      border-radius: 50%;
                      object-fit: cover;
                      border: 2px solid #e91e63;
                    "
                  />
                  <h4 class="mt-3 mb-1" id="infoName"></h4>
                  <div
                    class="text-muted mb-2"
                    id="infoEmail"
                    style="font-size: 0.98rem"
                  ></div>
                  <div
                    class="mb-2"
                    id="infoBio"
                    style="font-size: 0.97rem"
                  ></div>
                  <button
                    class="btn btn-outline-primary btn-sm mt-2"
                    id="editProfileBtn"
                  >
                    <i class="fas fa-edit me-1"></i>Chỉnh sửa hồ sơ
                  </button>
                </div>
                <div class="col-md-8">
                  <div class="row g-3">
                    <div class="col-md-3">
                      <div class="stat-card">
                        <div class="stat-title">Công thức</div>
                        <div class="stat-value" id="profileRecipeCount">25</div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="stat-card">
                        <div class="stat-title">Yêu thích</div>
                        <div class="stat-value" id="profileFavoriteCount">
                          0
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row mt-4" id="recentUserRecipesRow">
                <!-- Công thức gần đây của tôi sẽ được JS render vào đây -->
              </div>
              <!-- Thông tin cá nhân mở rộng (giới thiệu) sẽ được JS render vào đây nếu có -->
              <div id="profileBioExtended" class="mb-2"></div>
              <!-- Khu vực công thức của tôi sẽ được JS render vào đây nếu có -->
              <div id="profileRecentRecipes"></div>
              <!-- Khu vực công thức yêu thích sẽ được JS render vào đây nếu có -->
              <div id="profileRecentFavorites"></div>
              <!-- Khu vực khám phá sẽ được JS render vào đây nếu cần -->
              <div id="profileExplore"></div>
            </div>
            <!-- Công thức của tôi Tab -->
            <div class="tab-section" id="tab-my-recipes">
              <div class="admin-section">
                <h4 class="mb-4">Công thức của tôi</h4>
                <div class="row" id="myRecipeList">
                  <!-- Render recipe cards here -->
                </div>
              </div>
            </div>
            <!-- Yêu thích Tab -->
            <div class="tab-section" id="tab-favorite">
              <div class="admin-section">
                <h4 class="mb-4">Công thức yêu thích</h4>
                <div class="row" id="favoriteRecipeList">
                  <!-- Render favorite recipe cards here -->
                </div>
              </div>
            </div>
            <!-- Cài đặt Tab -->
            <div class="tab-section" id="tab-settings">
              <div class="admin-section">
                <h4 class="mb-4">Cài đặt tài khoản</h4>
                <form id="settingsForm" autocomplete="off">
                  <div class="mb-3">
                    <label class="form-label">Họ và tên</label>
                    <input
                      type="text"
                      class="form-control"
                      id="settingName"
                      value=""
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input
                      type="email"
                      class="form-control"
                      id="settingEmail"
                      value=""
                    />
                    <div
                      class="invalid-feedback"
                      id="emailError"
                      style="display: none"
                    ></div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label"
                      >Giới thiệu
                      <i
                        class="fas fa-info-circle"
                        data-bs-toggle="tooltip"
                        title="Giới thiệu ngắn gọn về bản thân (tối đa 200 ký tự)"
                      ></i
                    ></label>
                    <textarea
                      class="form-control"
                      id="settingBio"
                      rows="3"
                      maxlength="200"
                    ></textarea>
                    <div class="form-text">
                      <span id="bioCharCount">0</span>/200 ký tự
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Ảnh đại diện</label>
                    <input
                      type="file"
                      class="form-control"
                      id="settingAvatar"
                      accept="image/*"
                    />
                    <div
                      class="invalid-feedback"
                      id="avatarError"
                      style="display: none"
                    ></div>
                    <div id="avatarPreview" class="mt-2"></div>
                  </div>
                  <button type="submit" class="btn btn-primary btn-sm">
                    Lưu thay đổi
                  </button>
                </form>
                <hr />
                <h5 class="mb-3 mt-4">Đổi mật khẩu</h5>
                <form id="changePasswordForm" autocomplete="off">
                  <div class="mb-3">
                    <label class="form-label">Mật khẩu hiện tại</label>
                    <input
                      type="password"
                      class="form-control"
                      id="currentPassword"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Mật khẩu mới</label>
                    <input
                      type="password"
                      class="form-control"
                      id="newPassword"
                      required
                      minlength="6"
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Nhập lại mật khẩu mới</label>
                    <input
                      type="password"
                      class="form-control"
                      id="confirmNewPassword"
                      required
                      minlength="6"
                    />
                    <div
                      class="invalid-feedback"
                      id="passwordError"
                      style="display: none"
                    ></div>
                  </div>
                  <button type="submit" class="btn btn-primary btn-sm">
                    Đổi mật khẩu
                  </button>
                </form>
                <div
                  id="toastContainer"
                  style="position: fixed; top: 20px; right: 20px; z-index: 9999"
                ></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Footer -->
    <footer
      class="footer mt-5 py-5"
      style="
        background: linear-gradient(
          45deg,
          var(--primary-color),
          var(--secondary-color)
        );
      "
    >
      <div class="container">
        <div class="row g-4">
          <div class="col-lg-4">
            <h5 class="mb-3 fw-bold text-white">Về Chúng Tôi</h5>
            <p class="mb-4 text-white">
              Món Ngon Việt Nam là cộng đồng chia sẻ công thức nấu ăn lớn nhất
              Việt Nam, nơi kết nối những người đam mê ẩm thực.
            </p>
            <div class="social-links d-flex gap-3">
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-facebook-f"></i
              ></a>
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-instagram"></i
              ></a>
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-youtube"></i
              ></a>
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-tiktok"></i
              ></a>
            </div>
          </div>
          <div class="col-lg-2">
            <h5 class="mb-3 fw-bold text-white">Khám Phá</h5>
            <ul class="list-unstyled">
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html"
                  class="text-white text-decoration-none"
                  >Công thức</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/blog.html"
                  class="text-white text-decoration-none"
                  >Blog</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/about.html"
                  class="text-white text-decoration-none"
                  >Về chúng tôi</a
                >
              </li>
              <li class="mb-2">
                <a href="#" class="text-white text-decoration-none">Liên hệ</a>
              </li>
            </ul>
          </div>
          <div class="col-lg-3">
            <h5 class="mb-3 fw-bold text-white">Danh Mục</h5>
            <ul class="list-unstyled">
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html?category=mon-chinh"
                  class="text-white text-decoration-none"
                  >Món chính</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html?category=trang-mieng"
                  class="text-white text-decoration-none"
                  >Món tráng miệng</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html?category=do-uong"
                  class="text-white text-decoration-none"
                  >Đồ uống</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html?category=mon-chay"
                  class="text-white text-decoration-none"
                  >Món chay</a
                >
              </li>
            </ul>
          </div>
          <div class="col-lg-3">
            <h5 class="mb-3 fw-bold text-white">Liên Hệ</h5>
            <ul class="list-unstyled text-white">
              <li class="mb-2">
                <i class="fas fa-envelope me-2"></i> lienhe@monngon.vn
              </li>
              <li class="mb-2">
                <i class="fas fa-phone me-2"></i> 0123.456.789
              </li>
              <li class="mb-2">
                <i class="fas fa-map-marker-alt me-2"></i> Hà Nội, Việt Nam
              </li>
            </ul>
          </div>
        </div>
        <hr class="my-4 bg-white" />
        <div class="text-center text-white">
          <p class="mb-0">© 2024 Món Ngon Việt Nam. Đã đăng ký bản quyền.</p>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/data/recipes_MonChinh.js"></script>
    <script src="/assets/data/recipes_TrangMieng.js"></script>
    <script src="/assets/data/recipes_ThucUong.js"></script>
    <script src="/assets/data/recipes_AnChay.js"></script>
    <script src="/assets/data/recipes_AnVat.js"></script>
    <script src="/assets/data/recipes_KhaiVi.js"></script>
    <script>
      // --- Render công thức yêu thích cho tab Yêu thích ---
      function getCurrentUser() {
        try {
          return JSON.parse(sessionStorage.getItem("currentUser"));
        } catch {
          return null;
        }
      }
      function getAllRecipes() {
        return [
          ...(typeof recipesMonChinh !== "undefined" ? recipesMonChinh : []),
          ...(typeof recipesTrangMieng !== "undefined"
            ? recipesTrangMieng
            : []),
          ...(typeof recipesThucUong !== "undefined" ? recipesThucUong : []),
          ...(typeof recipesAnChay !== "undefined" ? recipesAnChay : []),
          ...(typeof recipesAnVat !== "undefined" ? recipesAnVat : []),
          ...(typeof recipesKhaiVi !== "undefined" ? recipesKhaiVi : []),
        ];
      }
      function renderFavoriteRecipes() {
        const user = getCurrentUser();
        const favKey = user ? "favoriteRecipes_" + user.email : null;
        const favIds = favKey
          ? JSON.parse(localStorage.getItem(favKey) || "[]")
          : [];
        const allRecipes = getAllRecipes();
        const favRecipes = allRecipes.filter((r) => favIds.includes(r.id));
        const container = document.getElementById("favoriteRecipeList");
        if (!container) return;
        setTimeout(() => {
          if (!favRecipes.length) {
            container.innerHTML = `<div class='empty-state'><i class='fas fa-heart-broken'></i><div>Bạn chưa yêu thích công thức nào!</div></div>`;
          } else {
            container.innerHTML = favRecipes
              .map(
                (r) => `
            <div class=\"col-md-4\">
              <div class=\"recipe-card saved-recipe\" style=\"cursor:pointer\" data-id=\"${
                r.id
              }\">
                <span class=\"saved-badge\">Yêu thích</span>
                <img src=\"${r.image}\" alt=\"${
                  r.title
                }\" class=\"recipe-image w-100\">
                <div class=\"recipe-content\">
                  <h5 class=\"recipe-title\">${r.title}</h5>
                  <div class=\"recipe-meta\">
                    <span><i class=\"fas fa-clock\"></i> ${
                      r.time || ""
                    } phút</span>
                    <span><i class=\"fas fa-star\"></i> ${r.rating || ""}</span>
                    <span><i class=\"fas fa-user\"></i> ${r.author || ""}</span>
                  </div>
                </div>
              </div>
            </div>
          `
              )
              .join("");
            // Thêm sự kiện click vào card để chuyển đến trang chi tiết
            container.querySelectorAll(".recipe-card").forEach((card) => {
              card.onclick = function () {
                const id = this.getAttribute("data-id");
                if (id)
                  window.location.href = `/pages/recipes/detail.html?id=${id}`;
              };
            });
          }
          // Thêm hiệu ứng fade-in từng card
          applyFadeInToProfileCards("#favoriteRecipeList");
        }, 400);
      }
      function renderUserInfo() {
        const user = getCurrentUser();
        // Navbar
        if (user) {
          const navbarAvatar = document.getElementById("navbarAvatar");
          const navbarUsername = document.getElementById("navbarUsername");
          if (navbarAvatar && user.avatar) navbarAvatar.src = user.avatar;
          if (navbarUsername)
            navbarUsername.textContent =
              user.name || user.username || user.email || "";
          // Sidebar username
          const sidebarUsername = document.getElementById("sidebarUsername");
          if (sidebarUsername)
            sidebarUsername.innerHTML = `<i class='fas fa-user-circle me-2'></i>${
              user.name || user.username || user.email || ""
            }`;
        }
        // Profile header
        if (user) {
          const profileAvatar = document.getElementById("profileAvatar");
          const profileName = document.getElementById("profileName");
          const profileBio = document.getElementById("profileBio");
          if (profileAvatar && user.avatar) profileAvatar.src = user.avatar;
          if (profileName)
            profileName.textContent =
              user.name || user.username || user.email || "";
          if (profileBio) profileBio.textContent = user.bio || "";
          // Tab Thông tin
          const infoAvatar = document.getElementById("infoAvatar");
          const infoName = document.getElementById("infoName");
          const infoEmail = document.getElementById("infoEmail");
          const infoBio = document.getElementById("infoBio");
          if (infoAvatar)
            infoAvatar.src = user.avatar || "/assets/images/users/avatar.jpg";
          if (infoName)
            infoName.textContent =
              user.name || user.username || user.email || "";
          if (infoEmail) infoEmail.textContent = user.email || "";
          if (infoBio) infoBio.textContent = user.bio || "";
          // Số liệu (nếu có)
          const recipeCountEl = document.getElementById("profileRecipeCount");
          if (recipeCountEl) {
            if (user.recipeCount && user.recipeCount > 0) {
              recipeCountEl.innerHTML = `<i class='fas fa-utensils me-1 text-primary'></i> <span class='stat-number'>${user.recipeCount}</span>`;
              recipeCountEl.removeAttribute("data-bs-toggle");
              recipeCountEl.removeAttribute("title");
              if (
                recipeCountEl.nextElementSibling &&
                recipeCountEl.nextElementSibling.classList.contains(
                  "stat-action"
                )
              ) {
                recipeCountEl.nextElementSibling.remove();
              }
            } else {
              recipeCountEl.innerHTML = `<i class='fas fa-utensils fa-2x text-secondary' data-bs-toggle='tooltip' title='Bạn chưa có công thức nào'></i><div class='stat-number text-muted mt-1 '>0</div><a href='/pages/user/add-recipe.html' class='btn btn-primary btn-sm mt-2'><i class='fas fa-plus me-1'></i>Đăng ngay</a>`;
              recipeCountEl.setAttribute("data-bs-toggle", "tooltip");
              recipeCountEl.setAttribute("title", "Bạn chưa có công thức nào");
              // Không thêm stat-action nữa
            }
          }
          const favoriteCountEl = document.getElementById(
            "profileFavoriteCount"
          );
          if (favoriteCountEl) {
            if (user.favoriteCount && user.favoriteCount > 0) {
              favoriteCountEl.innerHTML = `<i class='fas fa-heart me-1 text-danger'></i> <span class='stat-number'>${user.favoriteCount}</span>`;
              favoriteCountEl.removeAttribute("data-bs-toggle");
              favoriteCountEl.removeAttribute("title");
              if (
                favoriteCountEl.nextElementSibling &&
                favoriteCountEl.nextElementSibling.classList.contains(
                  "stat-action"
                )
              ) {
                favoriteCountEl.nextElementSibling.remove();
              }
            } else {
              favoriteCountEl.innerHTML = `<i class='fas fa-heart fa-2x text-secondary' data-bs-toggle='tooltip' title='Bạn chưa yêu thích công thức nào'></i><div class='stat-number text-muted mt-1'>0</div><a href='/pages/recipes/list.html' class='btn btn-primary btn-sm mt-2'><i class='fas fa-search me-1'></i>Khám phá</a>`;
              favoriteCountEl.setAttribute("data-bs-toggle", "tooltip");
              favoriteCountEl.setAttribute(
                "title",
                "Bạn chưa yêu thích công thức nào"
              );
              // Không thêm stat-action nữa
            }
          }
        }
      }
      // Hiển thị công thức gần đây nhất của user trên tab Thông tin
      function renderRecentUserRecipes() {
        const user = getCurrentUser();
        if (!user) return;
        const allRecipes = getAllRecipes();
        // Lọc các công thức do user đăng (theo email hoặc id)
        const myRecipes = allRecipes.filter(
          (r) =>
            r.authorEmail === user.email ||
            r.author === user.email ||
            r.author === user.name
        );
        // Sắp xếp theo thời gian (nếu có thuộc tính date), mặc định lấy đầu danh sách
        myRecipes.sort((a, b) => {
          if (a.date && b.date) return new Date(b.date) - new Date(a.date);
          return 0;
        });
        const recent = myRecipes.slice(0, 3);
        const container = document.getElementById("recentUserRecipesRow");
        if (!container) return;
        if (recent.length === 0) {
          // KHÔNG hiển thị lại dòng "Chưa có công thức nào" và nút "Đăng công thức mới" ở đây nữa
          container.innerHTML = "";
          return;
        }
        setTimeout(() => {
          container.innerHTML = recent
            .map(
              (r) => `
            <div class=\"col-md-4\">
              <div class=\"recipe-card recent-recipe\" style=\"cursor:pointer\" data-id=\"${
                r.id
              }\">
                <img src=\"${r.image}\" alt=\"${
                r.title
              }\" class=\"recipe-image w-100\" style=\"height:160px;object-fit:cover;border-radius:10px;\">
                <div class=\"recipe-content\">
                  <h6 class=\"recipe-title mb-1\">${r.title}</h6>
                  <div class=\"recipe-meta small text-muted\">
                    <span><i class=\"fas fa-clock\"></i> ${
                      r.time || ""
                    } phút</span>
                    <span><i class=\"fas fa-star\"></i> ${r.rating || ""}</span>
                  </div>
                </div>
              </div>
            </div>
          `
            )
            .join("");
          // Thêm sự kiện click để chuyển đến trang chi tiết
          container.querySelectorAll(".recipe-card").forEach((card) => {
            card.onclick = function () {
              const id = this.getAttribute("data-id");
              if (id)
                window.location.href = `/pages/recipes/detail.html?id=${id}`;
            };
          });
          // Thêm hiệu ứng fade-in từng card
          applyFadeInToProfileCards("#recentUserRecipesRow");
        }, 400);
      }

      // Card công thức đồng bộ với trang list.html
      function renderProfileRecipeCard(recipe) {
        return `
    <div class="recipe-card w-100" data-id="${
      recipe.id
    }" style="cursor:pointer">
      <img src="${recipe.image}" class="recipe-image w-100" alt="${
          recipe.title
        }">
      <div class="recipe-info">
        <h3 class="recipe-title">${recipe.title}</h3>
        <p class="text-muted mb-2" style="min-height:38px;font-size:0.97rem;">${(() => {
          const words = (recipe.description || "").split(" ");
          return (
            words.slice(0, 20).join(" ") + (words.length > 20 ? "..." : "")
          );
        })()}</p>
        <div class="recipe-meta">
          <span><i class="fas fa-clock"></i> ${recipe.time || ""} phút</span>
          <span><i class="fas fa-star"></i> ${recipe.rating || 0}</span>
          <span><i class="fas fa-user"></i> ${recipe.author || ""}</span>
        </div>
        <div class="recipe-meta mt-2">
          <span><i class="fas fa-signal"></i> ${recipe.difficulty || ""}</span>
        </div>
        <div class="recipe-tags mt-1">
          ${(recipe.tags || [])
            .map((tag) => `<span class='recipe-tag'>${tag}</span>`)
            .join(" ")}
        </div>
      </div>
    </div>
  `;
      }

      // Hiển thị thông tin nổi bật và nội dung động trên profile
      function renderProfileHighlights() {
        const user = getCurrentUser();
        const allRecipes = getAllRecipes();
        // Lấy danh sách công thức của tôi
        const myRecipes = allRecipes.filter(
          (r) =>
            r.authorEmail === user?.email ||
            r.author === user?.email ||
            r.author === user?.name
        );
        // Lấy danh sách công thức yêu thích
        const favKey = user ? "favoriteRecipes_" + user.email : null;
        const favIds = favKey
          ? JSON.parse(localStorage.getItem(favKey) || "[]")
          : [];
        const favRecipes = allRecipes.filter((r) => favIds.includes(r.id));
        // Vùng giới thiệu mở rộng
        const bioExt = document.getElementById("profileBioExtended");
        if (bioExt) {
          bioExt.style.display = user?.bio ? "block" : "none";
          bioExt.innerHTML = user?.bio
            ? `<div class='bg-light rounded p-2 mb-2'><i class='fas fa-quote-left me-2 text-secondary'></i>${user.bio}</div>`
            : "";
        }
        // Công thức của tôi (nếu có)
        const recentRecipes = document.getElementById("profileRecentRecipes");
        if (recentRecipes) {
          setTimeout(() => {
            if (myRecipes.length > 0) {
              const show = myRecipes.slice(0, 3);
              recentRecipes.innerHTML =
                `<div class='mb-2'><strong>Công thức gần đây của bạn</strong></div><div class='row g-2'>` +
                show
                  .map(
                    (r) => `
                  <div class='col-md-4 d-flex align-items-stretch'>${renderProfileRecipeCard(
                    r
                  )}</div>
                `
                  )
                  .join("") +
                `</div><div class='mt-2'><a href='/pages/user/profile.html#tab-my-recipes' class='btn btn-link btn-sm p-0'>Xem tất cả công thức của tôi</a></div>`;
              // Sự kiện click
              recentRecipes.querySelectorAll(".recipe-card").forEach((card) => {
                card.onclick = function () {
                  const id = this.getAttribute("data-id");
                  if (id)
                    window.location.href = `/pages/recipes/detail.html?id=${id}`;
                };
              });
              // Thêm hiệu ứng fade-in từng card
              applyFadeInToProfileCards("#profileRecentRecipes .row");
            } else {
              recentRecipes.innerHTML = "";
            }
          }, 400);
        }
        // Công thức yêu thích (nếu có)
        const recentFav = document.getElementById("profileRecentFavorites");
        if (recentFav) {
          setTimeout(() => {
            if (favRecipes.length > 0) {
              const show = favRecipes.slice(0, 3);
              recentFav.innerHTML =
                `<div class='mb-2'><strong>Các công thức bạn đã yêu thích gần đây</strong></div><div class='row g-2'>` +
                show
                  .map(
                    (r) => `
                  <div class='col-md-4 d-flex align-items-stretch'>${renderProfileRecipeCard(
                    r
                  )}</div>
                `
                  )
                  .join("") +
                `</div><div class='mt-2'><a href='/pages/user/profile.html#tab-favorite' class='btn btn-link btn-sm p-0'>Xem tất cả công thức yêu thích</a></div>`;
              // Sự kiện click
              recentFav.querySelectorAll(".recipe-card").forEach((card) => {
                card.onclick = function () {
                  const id = this.getAttribute("data-id");
                  if (id)
                    window.location.href = `/pages/recipes/detail.html?id=${id}`;
                };
              });
              // Thêm hiệu ứng fade-in từng card
              applyFadeInToProfileCards("#profileRecentFavorites .row");
            } else {
              recentFav.innerHTML = "";
            }
          }, 400);
        }
        // Khám phá món ngon hôm nay
        const explore = document.getElementById("profileExplore");
        let exploreInterval;
        if (explore) {
          function renderExploreRandomRecipes() {
            if (!explore) return;
            const random = allRecipes
              .sort(() => 0.5 - Math.random())
              .slice(0, 4);
            explore.innerHTML =
              `<div class='mt-3 fs-2 pb-5 text-center' style='color: #D61C4E;'><strong>Khám phá các món ngon hôm nay</strong></div><div class='row g-2'>` +
              random
                .map(
                  (r) => `
              <div class='col-md-3 d-flex align-items-stretch ps-5'>${renderProfileRecipeCard(
                r
              )}</div>
            `
                )
                .join("") +
              `</div><div class='mt-2 text-center'><a href='/pages/recipes/list.html' class='btn btn-primary btn-sm '>Xem thêm</a></div>`;
            // Sự kiện click
            explore.querySelectorAll(".recipe-card").forEach((card) => {
              card.onclick = function () {
                const id = this.getAttribute("data-id");
                if (id)
                  window.location.href = `/pages/recipes/detail.html?id=${id}`;
              };
            });
            // Thêm hiệu ứng fade-in từng card
            applyFadeInToProfileCards("#profileExplore .row");
          }
          setTimeout(() => {
            if (myRecipes.length === 0 && favRecipes.length === 0) {
              renderExploreRandomRecipes();
              // Xóa interval cũ nếu có
              if (window._exploreInterval)
                clearInterval(window._exploreInterval);
              // Tự động chuyển món mỗi 2s
              window._exploreInterval = setInterval(
                renderExploreRandomRecipes,
                3000
              );
            } else {
              explore.innerHTML = "";
              if (window._exploreInterval)
                clearInterval(window._exploreInterval);
            }
          }, 400);
        }
      }

      // Chuyển tab sang Cài đặt khi bấm 'Chỉnh sửa hồ sơ'
      const editProfileBtn = document.getElementById("editProfileBtn");
      if (editProfileBtn) {
        editProfileBtn.addEventListener("click", function () {
          // Kích hoạt tab Cài đặt
          document
            .querySelectorAll(".sidebar .nav-link")
            .forEach((l) => l.classList.remove("active"));
          const settingsTab = document.querySelector(
            '.sidebar .nav-link[data-tab="settings"]'
          );
          if (settingsTab) settingsTab.classList.add("active");
          document
            .querySelectorAll(".tab-section")
            .forEach((sec) => sec.classList.remove("active"));
          const settingsSection = document.getElementById("tab-settings");
          if (settingsSection) {
            settingsSection.classList.add("active");
            // Cuộn tới phần cài đặt nếu cần
            settingsSection.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
          }
        });
      }

      // Hiệu ứng chuyển động mượt cho các card công thức profile
      function animateProfileCardTransition(containerId, renderFn) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.classList.add("profile-card-fade-out");
        setTimeout(() => {
          renderFn();
          container.classList.remove("profile-card-fade-out");
          container.classList.add("profile-card-fade-in");
          setTimeout(() => {
            container.classList.remove("profile-card-fade-in");
          }, 400);
        }, 400);
      }

      // Đăng xuất từ dropdown
      const navbarLogout = document.getElementById("navbarLogout");
      if (navbarLogout) {
        navbarLogout.addEventListener("click", function (e) {
          e.preventDefault();
          sessionStorage.removeItem("currentUser");
          window.location.href = "/pages/auth/login.html";
        });
      }
      function addProfileCardTransitionOnTab(tabId, renderFn) {
        const tabBtn = document.querySelector(
          '.sidebar .nav-link[data-tab="' + tabId + '"]'
        );
        if (tabBtn) {
          tabBtn.addEventListener("click", function () {
            animateProfileCardTransition(
              tabId === "my-recipes"
                ? "myRecipeList"
                : tabId === "favorite"
                ? "favoriteRecipeList"
                : "",
              renderFn
            );
          });
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        renderUserInfo();
        renderProfileHighlights();
        renderRecentUserRecipes();
        renderMyRecipes();
        // Đảm bảo hiệu ứng luôn chạy khi chuyển tab
        addProfileCardTransitionOnTab("my-recipes", renderMyRecipes);
        addProfileCardTransitionOnTab("favorite", renderFavoriteRecipes);
        // Render khi chuyển tab hoặc load trang
        document
          .querySelector('button[data-bs-target="#saved"]')
          .addEventListener("click", renderFavoriteRecipes);
        // Nếu tab Yêu thích đang active khi load trang thì render luôn
        if (document.querySelector("#saved").classList.contains("show"))
          renderFavoriteRecipes();
        document
          .querySelectorAll('.sidebar .nav-link[data-tab="my-recipes"]')
          .forEach(function (link) {
            link.addEventListener("click", renderMyRecipes);
          });
        // Xử lý chuyển tab khi bấm "Chỉnh sửa hồ sơ"
        var editBtn = document.getElementById("editProfileBtn");
        if (editBtn) {
          editBtn.addEventListener("click", function () {
            // Kích hoạt tab sidebar
            document
              .querySelectorAll(".sidebar .nav-link")
              .forEach(function (l) {
                l.classList.remove("active");
              });
            var settingsTab = document.querySelector(
              '.sidebar .nav-link[data-tab="settings"]'
            );
            if (settingsTab) settingsTab.classList.add("active");
            // Hiện tab nội dung
            document.querySelectorAll(".tab-section").forEach(function (sec) {
              sec.classList.remove("active");
            });
            var settingsSection = document.getElementById("tab-settings");
            if (settingsSection) {
              settingsSection.classList.add("active");
              settingsSection.scrollIntoView({
                behavior: "smooth",
                block: "start",
              });
            }
          });
        }
      });
      // Delete recipe confirmation
      document.querySelectorAll(".delete-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          if (confirm("Bạn có chắc chắn muốn xóa công thức này?")) {
            // Add delete logic here
          }
        });
      });

      // Sidebar tab switching
      document.querySelectorAll(".sidebar .nav-link").forEach(function (link) {
        link.addEventListener("click", function () {
          document
            .querySelectorAll(".sidebar .nav-link")
            .forEach((l) => l.classList.remove("active"));
          this.classList.add("active");
          const tab = this.getAttribute("data-tab");
          document
            .querySelectorAll(".tab-section")
            .forEach((sec) => sec.classList.remove("active"));
          document.getElementById("tab-" + tab).classList.add("active");
        });
      });

      // Toast message
      function showToast(message, type = "success") {
        const toast = document.createElement("div");
        toast.className = `toast align-items-center text-bg-${
          type === "success" ? "success" : "danger"
        } border-0 show`;
        toast.role = "alert";
        toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
        document.getElementById("toastContainer").appendChild(toast);
        setTimeout(() => toast.remove(), 3500);
      }
      // Email validation
      function validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      }
      // Avatar preview & validation
      const avatarInput = document.getElementById("settingAvatar");
      const avatarPreview = document.getElementById("avatarPreview");
      if (avatarInput) {
        avatarInput.addEventListener("change", function () {
          avatarPreview.innerHTML = "";
          document.getElementById("avatarError").style.display = "none";
          const file = this.files[0];
          if (file) {
            if (!file.type.startsWith("image/")) {
              document.getElementById("avatarError").textContent =
                "Chỉ hỗ trợ file ảnh.";
              document.getElementById("avatarError").style.display = "block";
              this.value = "";
              return;
            }
            if (file.size > 2 * 1024 * 1024) {
              document.getElementById("avatarError").textContent =
                "Ảnh quá lớn (tối đa 2MB).";
              document.getElementById("avatarError").style.display = "block";
              this.value = "";
              return;
            }
            const reader = new FileReader();
            reader.onload = function (e) {
              avatarPreview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width:100px;max-height:100px;border-radius:50%">`;
            };
            reader.readAsDataURL(file);
          }
        });
      }
      // Bio char count
      const bioInput = document.getElementById("settingBio");
      const bioCharCount = document.getElementById("bioCharCount");
      if (bioInput && bioCharCount) {
        bioInput.addEventListener("input", function () {
          bioCharCount.textContent = this.value.length;
        });
      }
      // Tooltip
      var tooltipTriggerList = [].slice.call(
        document.querySelectorAll('[data-bs-toggle="tooltip"]')
      );
      tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
      });
      // Settings form submit
      const settingsForm = document.getElementById("settingsForm");
      if (settingsForm) {
        settingsForm.addEventListener("submit", function (e) {
          e.preventDefault();
          const email = document.getElementById("settingEmail").value.trim();
          const emailError = document.getElementById("emailError");
          emailError.style.display = "none";
          if (!validateEmail(email)) {
            emailError.textContent = "Email không hợp lệ.";
            emailError.style.display = "block";
            return;
          }
          // Giả lập lưu thành công
          showToast("Lưu thông tin thành công!", "success");
          // Nếu có lỗi server, dùng: showToast('Có lỗi xảy ra, vui lòng thử lại.', 'danger');
        });
      }
      // Đổi mật khẩu
      const changePasswordForm = document.getElementById("changePasswordForm");
      if (changePasswordForm) {
        changePasswordForm.addEventListener("submit", function (e) {
          e.preventDefault();
          const newPassword = document.getElementById("newPassword").value;
          const confirmNewPassword =
            document.getElementById("confirmNewPassword").value;
          const passwordError = document.getElementById("passwordError");
          passwordError.style.display = "none";
          if (newPassword !== confirmNewPassword) {
            passwordError.textContent = "Mật khẩu mới không khớp.";
            passwordError.style.display = "block";
            return;
          }
          if (newPassword.length < 6) {
            passwordError.textContent = "Mật khẩu mới phải từ 6 ký tự.";
            passwordError.style.display = "block";
            return;
          }
          // Giả lập đổi mật khẩu thành công
          showToast("Đổi mật khẩu thành công!", "success");
          // Nếu có lỗi: showToast('Đổi mật khẩu thất bại.', 'danger');
        });
      }
      function renderMyRecipes() {
        const user = getCurrentUser();
        if (!user) return;
        const allRecipes = getAllRecipes();
        const myRecipes = allRecipes.filter(
          (r) =>
            r.authorEmail === user.email ||
            r.author === user.email ||
            r.author === user.name
        );
        const container = document.getElementById("myRecipeList");
        if (!container) return;
        setTimeout(() => {
          if (!myRecipes.length) {
            container.innerHTML = `<div class='empty-state'><i class='fas fa-utensils'></i><div>Bạn chưa đăng công thức nào!</div></div>`;
          } else {
            container.innerHTML = myRecipes
              .map(
                (r) => `
    <div class=\"col-md-4\">
      <div class=\"recipe-card\" style=\"cursor:pointer\" data-id=\"${
        r.id
      }\">\n        <img src=\"${r.image}\" alt=\"${
                  r.title
                }\" class=\"recipe-image w-100\">\n        <div class=\"recipe-content\">\n          <h5 class=\"recipe-title\">${
                  r.title
                }</h5>\n          <div class=\"recipe-meta\">\n            <span><i class=\"fas fa-clock\"></i> ${
                  r.time || ""
                } phút</span>\n            <span><i class=\"fas fa-star\"></i> ${
                  r.rating || ""
                }</span>\n            <span><i class=\"fas fa-user\"></i> ${
                  r.author || ""
                }</span>\n          </div>\n        </div>\n      </div>\n    </div>\n  `
              )
              .join("");
            container.querySelectorAll(".recipe-card").forEach((card) => {
              card.onclick = function () {
                const id = this.getAttribute("data-id");
                if (id)
                  window.location.href = `/pages/recipes/detail.html?id=${id}`;
              };
            });
            // Thêm hiệu ứng fade-in từng card
            applyFadeInToProfileCards("#myRecipeList");
          }
        }, 400);
      }

      /**
       * Thêm hiệu ứng fade-in từng card với delay (staggered)
       * @param {string} containerSelector - selector của container chứa các card
       * @param {string} cardSelector - selector của card, mặc định là .recipe-card
       */
      function applyFadeInToProfileCards(
        containerSelector,
        cardSelector = ".recipe-card"
      ) {
        const container = document.querySelector(containerSelector);
        if (!container) return;
        const cards = container.querySelectorAll(cardSelector);
        cards.forEach((card, idx) => {
          card.classList.remove(
            "profile-card-fade-in",
            "profile-card-fade-out"
          );
          card.style.opacity = 0;
          card.style.transform = "translateY(30px) scale(0.98)";
          setTimeout(() => {
            card.classList.add("profile-card-fade-in");
            card.style.transitionDelay = idx * 80 + "ms";
            card.style.opacity = 1;
            card.style.transform = "translateY(0) scale(1)";
            // Xóa delay sau khi xong để tránh ảnh hưởng hover
            setTimeout(() => {
              card.style.transitionDelay = "";
            }, 500 + idx * 80);
          }, idx * 80);
        });
      }
    </script>
  </body>
</html>
