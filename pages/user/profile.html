<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trang Cá Nhân - Món Ngon Việt Nam</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/assets/css/pages/profile.css" />
    <link rel="stylesheet" href="/assets/css/pages/list.css" />
    <link rel="stylesheet" href="/assets/css/pages/blog.css" />
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top">
      <div class="container">
        <a class="navbar-brand" href="/index.html">
          
          Món Ngon Việt Nam
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item">
              <a class="nav-link" href="../../index.html">Trang chủ</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../recipes/list.html">Công thức</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../blog.html">Blog</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="../about.html">Về chúng tôi</a>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle d-flex align-items-center gap-2"
                href="#"
                id="navbarUserDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <img
                  src="/assets/images/users/avatar.jpg"
                  alt="Avatar"
                  class="rounded-circle"
                  width="32"
                  height="32"
                  id="navbarAvatar"
                />
                <span id="navbarUsername" class="fw-semibold"></span>
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="navbarUserDropdown"
              >
                <li>
                  <a class="dropdown-item" href="/pages/user/profile.html">
                    Trang cá nhân
                  </a>
                </li>
                <li>
                  <hr class="dropdown-divider" />
                </li>
                <li>
                  <a
                    class="dropdown-item text-danger"
                    href="#"
                    id="navbarLogout"
                  >
                    Đăng xuất
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- Profile Section Start -->
    <section class="profile-admin-layout">
      <div class="container-fluid">
        <div class="row">
          <!-- Sidebar -->
          <div
            class="col-lg-2 col-md-3 sidebar d-flex flex-column align-items-start pt-5"
          >
            <h4 class="fw-bold mb-4" id="sidebarUsername">
              <i class="fas fa-user-circle me-2"></i>
              <!-- Tên user sẽ được JS render vào đây -->
            </h4>
            <nav class="nav flex-column w-100">
              <a class="nav-link active" data-tab="profile-info"
                ><i class="fas fa-user me-2"></i>Thông tin</a
              >
              <a class="nav-link" data-tab="my-recipes"
                ><i class="fas fa-utensils me-2"></i>Công thức của tôi</a
              >
              <a class="nav-link" data-tab="favorite"
                ><i class="fas fa-heart me-2"></i>Yêu thích</a
              >
              <a class="nav-link" data-tab="my-blogs"
                ><i class="fas fa-blog me-2"></i>Blog của tôi</a
              >
              <a class="nav-link" data-tab="settings"
                ><i class="fas fa-cog me-2"></i>Cài đặt</a
              >
            </nav>
          </div>
          <!-- Main Content -->
          <div class="col-lg-10 col-md-9 px-4 pt-5">
            <div class="admin-header mb-4"></div>
            <!-- Thông tin Tab -->
            <div class="tab-section active" id="tab-profile-info">
              <div class="row mb-4 align-items-center">
                <div class="col-md-4 text-center">
                  <img
                    id="infoAvatar"
                    src="/assets/images/users/avatar.jpg"
                    alt="Avatar"
                    style="
                      width: 100px;
                      height: 100px;
                      border-radius: 50%;
                      object-fit: cover;
                      border: 2px solid #e91e63;
                    "
                  />
                  <h4 class="mt-3 mb-1" id="infoName"></h4>
                  <div
                    class="text-muted mb-2"
                    id="infoEmail"
                    style="font-size: 0.98rem"
                  ></div>
                  <div
                    class="mb-2"
                    id="infoBio"
                    style="font-size: 0.97rem"
                  ></div>
                  <button
                    class="btn btn-outline-primary btn-sm mt-2"
                    id="editProfileBtn"
                  >
                    <i class="fas fa-edit me-1"></i>Chỉnh sửa hồ sơ
                  </button>
                </div>
                <div class="col-md-8">
                  <div class="row g-3">
                    <div class="col-md-3">
                      <div class="stat-card">
                        <div class="stat-title">Công thức</div>
                        <div class="stat-value" id="profileRecipeCount">25</div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="stat-card">
                        <div class="stat-title">Yêu thích</div>
                        <div class="stat-value" id="profileFavoriteCount">
                          0
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="stat-card">
                        <div class="stat-title">Blog</div>
                        <div class="stat-value" id="profileBlogCount">0</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row mt-4" id="recentUserRecipesRow">
                <!-- Công thức gần đây của tôi sẽ được JS render vào đây -->
              </div>
              <!-- Thông tin cá nhân mở rộng (giới thiệu) sẽ được JS render vào đây nếu có -->
              <div id="profileBioExtended" class="mb-2"></div>
              <!-- Khu vực công thức của tôi sẽ được JS render vào đây nếu có -->
              <div id="profileRecentRecipes"></div>
              <!-- ĐÃ XÓA Khu vực công thức yêu thích theo yêu cầu -->
              <!-- Khu vực khám phá sẽ được JS render vào đây nếu cần -->
              <div id="profileExplore"></div>
            </div>
            <!-- Công thức của tôi Tab -->
            <div class="tab-section" id="tab-my-recipes">
              <div class="admin-section">
                <h4 class="mb-4">Công thức của tôi</h4>
                <div class="row" id="myRecipeList">
                  <!-- Render recipe cards here -->
                </div>
              </div>
            </div>
            <!-- Yêu thích Tab -->
            <div class="tab-section" id="tab-favorite">
              <div class="admin-section">
                <h4 class="mb-4">Công thức yêu thích</h4>
                <div class="row" id="favoriteRecipeList">
                  <!-- Render favorite recipe cards here -->
                </div>
              </div>
            </div>
            <!-- Blog của tôi Tab -->
            <div class="tab-section" id="tab-my-blogs">
              <div class="admin-section">
                <h4 class="mb-4">Blog của tôi</h4>
                <div class="row" id="myBlogList">
                  <!-- Render blog cards here -->
                </div>
              </div>
            </div>
            <!-- Cài đặt Tab -->
            <div class="tab-section" id="tab-settings">
              <div class="admin-section">
                <h4 class="mb-4">Cài đặt tài khoản</h4>
                <form id="settingsForm" autocomplete="off">
                  <div class="mb-3">
                    <label class="form-label">Họ và tên</label>
                    <input
                      type="text"
                      class="form-control"
                      id="settingName"
                      value=""
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input
                      type="email"
                      class="form-control"
                      id="settingEmail"
                      value=""
                    />
                    <div
                      class="invalid-feedback"
                      id="emailError"
                      style="display: none"
                    ></div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label"
                      >Giới thiệu
                      <i
                        class="fas fa-info-circle"
                        data-bs-toggle="tooltip"
                        title="Giới thiệu ngắn gọn về bản thân (tối đa 200 ký tự)"
                      ></i
                    ></label>
                    <textarea
                      class="form-control"
                      id="settingBio"
                      rows="3"
                      maxlength="200"
                    ></textarea>
                    <div class="form-text">
                      <span id="bioCharCount">0</span>/200 ký tự
                    </div>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Ảnh đại diện</label>
                    <input
                      type="file"
                      class="form-control"
                      id="settingAvatar"
                      accept="image/*"
                    />
                    <div
                      class="invalid-feedback"
                      id="avatarError"
                      style="display: none"
                    ></div>
                    <div id="avatarPreview" class="mt-2"></div>
                  </div>
                  <button type="submit" class="btn btn-primary btn-sm">
                    Lưu thay đổi
                  </button>
                </form>
                <hr />
                <h5 class="mb-3 mt-4">Đổi mật khẩu</h5>
                <form id="changePasswordForm" autocomplete="off">
                  <div class="mb-3">
                    <label class="form-label">Mật khẩu hiện tại</label>
                    <input
                      type="password"
                      class="form-control"
                      id="currentPassword"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Mật khẩu mới</label>
                    <input
                      type="password"
                      class="form-control"
                      id="newPassword"
                      required
                      minlength="6"
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Nhập lại mật khẩu mới</label>
                    <input
                      type="password"
                      class="form-control"
                      id="confirmNewPassword"
                      required
                      minlength="6"
                    />
                    <div
                      class="invalid-feedback"
                      id="passwordError"
                      style="display: none"
                    ></div>
                  </div>
                  <button type="submit" class="btn btn-primary btn-sm">
                    Đổi mật khẩu
                  </button>
                </form>
                <div
                  id="toastContainer"
                  style="position: fixed; top: 20px; right: 20px; z-index: 9999"
                ></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Footer -->
    <footer
      class="footer mt-5 py-5"
      style="
        background: linear-gradient(
          45deg,
          var(--primary-color),
          var(--secondary-color)
        );
      "
    >
      <div class="container">
        <div class="row g-4">
          <div class="col-lg-4">
            <h5 class="mb-3 fw-bold text-white">Về Chúng Tôi</h5>
            <p class="mb-4 text-white">
              Món Ngon Việt Nam là cộng đồng chia sẻ công thức nấu ăn lớn nhất
              Việt Nam, nơi kết nối những người đam mê ẩm thực.
            </p>
            <div class="social-links d-flex gap-3">
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-facebook-f"></i
              ></a>
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-instagram"></i
              ></a>
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-youtube"></i
              ></a>
              <a
                href="#"
                class="d-flex align-items-center justify-content-center rounded-circle bg-white bg-opacity-10 text-white fs-5"
                style="width: 44px; height: 44px"
                ><i class="fab fa-tiktok"></i
              ></a>
            </div>
          </div>
          <div class="col-lg-2">
            <h5 class="mb-3 fw-bold text-white">Khám Phá</h5>
            <ul class="list-unstyled">
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html"
                  class="text-white text-decoration-none"
                  >Công thức</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/blog.html"
                  class="text-white text-decoration-none"
                  >Blog</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/about.html"
                  class="text-white text-decoration-none"
                  >Về chúng tôi</a
                >
              </li>
              <li class="mb-2">
                <a href="#" class="text-white text-decoration-none">Liên hệ</a>
              </li>
            </ul>
          </div>
          <div class="col-lg-3">
            <h5 class="mb-3 fw-bold text-white">Danh Mục</h5>
            <ul class="list-unstyled">
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html?category=mon-chinh"
                  class="text-white text-decoration-none"
                  >Món chính</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html?category=trang-mieng"
                  class="text-white text-decoration-none"
                  >Món tráng miệng</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html?category=do-uong"
                  class="text-white text-decoration-none"
                  >Đồ uống</a
                >
              </li>
              <li class="mb-2">
                <a
                  href="/pages/recipes/list.html?category=mon-chay"
                  class="text-white text-decoration-none"
                  >Món chay</a
                >
              </li>
            </ul>
          </div>
          <div class="col-lg-3">
            <h5 class="mb-3 fw-bold text-white">Liên Hệ</h5>
            <ul class="list-unstyled text-white">
              <li class="mb-2">
                <i class="fas fa-envelope me-2"></i> lienhe@monngon.vn
              </li>
              <li class="mb-2">
                <i class="fas fa-phone me-2"></i> 0123.456.789
              </li>
              <li class="mb-2">
                <i class="fas fa-map-marker-alt me-2"></i> Hà Nội, Việt Nam
              </li>
            </ul>
          </div>
        </div>
        <hr class="my-4 bg-white" />
        <div class="text-center text-white">
          <p class="mb-0">© 2024 Món Ngon Việt Nam. Đã đăng ký bản quyền.</p>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/data/recipes_MonChinh.js"></script>
    <script src="/assets/data/recipes_TrangMieng.js"></script>
    <script src="/assets/data/recipes_ThucUong.js"></script>
    <script src="/assets/data/recipes_AnChay.js"></script>
    <script src="/assets/data/recipes_AnVat.js"></script>
    <script src="/assets/data/recipes_KhaiVi.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="/assets/js/firebase-config.js"></script>
    <script>
      // --- Render công thức yêu thích cho tab Yêu thích ---
      function getCurrentUser() {
        try {
          return JSON.parse(sessionStorage.getItem("currentUser"));
        } catch {
          return null;
        }
      }
      function getAllRecipes() {
        return [
          ...(typeof recipesMonChinh !== "undefined" ? recipesMonChinh : []),
          ...(typeof recipesTrangMieng !== "undefined"
            ? recipesTrangMieng
            : []),
          ...(typeof recipesThucUong !== "undefined" ? recipesThucUong : []),
          ...(typeof recipesAnChay !== "undefined" ? recipesAnChay : []),
          ...(typeof recipesAnVat !== "undefined" ? recipesAnVat : []),
          ...(typeof recipesKhaiVi !== "undefined" ? recipesKhaiVi : []),
        ];
      }
      function renderFavoriteRecipes() {
        const user = getCurrentUser();
        const favKey = user ? "favoriteRecipes_" + user.email : null;
        const favIds = favKey
          ? JSON.parse(localStorage.getItem(favKey) || "[]")
          : [];
        const allRecipes = getAllRecipes();
        const favRecipes = allRecipes.filter((r) => favIds.includes(r.id));
        const container = document.getElementById("favoriteRecipeList");
        if (!container) return;
        setTimeout(() => {
          if (!favRecipes.length) {
            container.innerHTML = `<div class='empty-state'><i class='fas fa-heart-broken'></i><div>Bạn chưa yêu thích công thức nào!</div></div>`;
          } else {
            container.innerHTML = favRecipes
              .map(
                (recipe) => `
      <div class="col-md-3 mb-4 d-flex align-items-stretch" data-aos="fade-up">
        <div class="recipe-card w-100 position-relative" data-id="${
          recipe.id
        }" style="cursor:pointer">
          <img src="${recipe.image}" class="recipe-image w-100" alt="${
                  recipe.title
                }">
          <div class="recipe-info">
            <h3 class="recipe-title">${recipe.title}</h3>
            <p class="text-muted mb-3">${(() => {
              const words = (recipe.description || "").split(" ");
              return (
                words.slice(0, 25).join(" ") + (words.length > 25 ? "..." : "")
              );
            })()}</p>
            <div class="recipe-meta">
              <span><i class="fas fa-clock"></i> ${recipe.time} phút</span>
              <span><i class="fas fa-star"></i> ${recipe.rating}</span>
              <span><i class="fas fa-user"></i> ${recipe.author || ""}</span>
            </div>
            <div class="recipe-meta mt-2">
              <span><i class="fas fa-signal"></i> ${
                recipe.difficulty || ""
              }</span>
            </div>
            <div class="recipe-tags">
              ${(recipe.tags || [])
                .map((tag) => `<span class="recipe-tag">${tag}</span>`)
                .join("")}
            </div>
            <button class="btn btn-primary btn-sm btn-remove-favorite position-absolute top-0 end-0 m-2" title="Xóa khỏi yêu thích"><i class="fas fa-times"></i></button>
          </div>
        </div>
      </div>
    `
              )
              .join("");
            // Sự kiện click vào card để chuyển đến trang chi tiết
            container.querySelectorAll(".recipe-card").forEach((card) => {
              card.onclick = function (e) {
                // Nếu click vào nút xóa thì không chuyển trang
                if (e.target.closest(".btn-remove-favorite")) return;
                const id = this.getAttribute("data-id");
                if (id)
                  window.location.href = `/pages/recipes/detail.html?id=${id}`;
              };
            });
            // Sự kiện xóa khỏi yêu thích
            container
              .querySelectorAll(".btn-remove-favorite")
              .forEach((btn) => {
                btn.onclick = function (e) {
                  e.stopPropagation();
                  const card = this.closest(".recipe-card");
                  const id = card.getAttribute("data-id");
                  if (!id) return;
                  // Xóa khỏi localStorage
                  const idx = favIds.indexOf(id);
                  if (idx !== -1) {
                    favIds.splice(idx, 1);
                    localStorage.setItem(favKey, JSON.stringify(favIds));
                    showToast("Đã xóa khỏi yêu thích!", "success");
                    renderFavoriteRecipes();
                  }
                };
              });
          }
          // Sau khi lấy favIds, cập nhật số lượng công thức yêu thích lên profileFavoriteCount nếu có
          const favoriteCountEl = document.getElementById(
            "profileFavoriteCount"
          );
          if (favoriteCountEl) {
            const statNumber = favoriteCountEl.querySelector(".stat-number");
            if (statNumber) {
              statNumber.textContent = favIds.length;
            }
          }
          // Thêm hiệu ứng fade-in từng card
          applyFadeInToProfileCards &&
            applyFadeInToProfileCards("#favoriteRecipeList", ".recipe-card");
        }, 400);
      }
      function renderUserInfo() {
        const user = getCurrentUser();
        // Navbar
        if (user) {
          const navbarAvatar = document.getElementById("navbarAvatar");
          const navbarUsername = document.getElementById("navbarUsername");
          if (navbarAvatar && user.avatar) navbarAvatar.src = user.avatar;
          if (navbarUsername)
            navbarUsername.textContent =
              user.name || user.username || user.email || "";
          // Sidebar username
          const sidebarUsername = document.getElementById("sidebarUsername");
          if (sidebarUsername)
            sidebarUsername.innerHTML = `<i class='fas fa-user-circle me-2'></i>${
              user.name || user.username || user.email || ""
            }`;
        }
        // Profile header
        if (user) {
          const profileAvatar = document.getElementById("profileAvatar");
          const profileName = document.getElementById("profileName");
          const profileBio = document.getElementById("profileBio");
          if (profileAvatar && user.avatar) profileAvatar.src = user.avatar;
          if (profileName)
            profileName.textContent =
              user.name || user.username || user.email || "";
          if (profileBio) profileBio.textContent = user.bio || "";
          // Tab Thông tin
          const infoAvatar = document.getElementById("infoAvatar");
          const infoName = document.getElementById("infoName");
          const infoEmail = document.getElementById("infoEmail");
          const infoBio = document.getElementById("infoBio");
          if (infoAvatar)
            infoAvatar.src = user.avatar || "/assets/images/users/avatar.jpg";
          if (infoName)
            infoName.textContent =
              user.name || user.username || user.email || "";
          if (infoEmail) infoEmail.textContent = user.email || "";
          if (infoBio) infoBio.textContent = user.bio || "";
          // Số liệu (nếu có)
          const recipeCountEl = document.getElementById("profileRecipeCount");
          if (recipeCountEl) {
            if (user.recipeCount && user.recipeCount > 0) {
              recipeCountEl.innerHTML = `<i class='fas fa-utensils me-1 text-primary'></i> <span class='stat-number'>${user.recipeCount}</span>`;
              recipeCountEl.removeAttribute("data-bs-toggle");
              recipeCountEl.removeAttribute("title");
              if (
                recipeCountEl.nextElementSibling &&
                recipeCountEl.nextElementSibling.classList.contains(
                  "stat-action"
                )
              ) {
                recipeCountEl.nextElementSibling.remove();
              }
            } else {
              recipeCountEl.innerHTML = `<i class='fas fa-utensils fa-2x text-danger' data-bs-toggle='tooltip' title='Bạn chưa có công thức nào'></i><div class='stat-number text-muted mt-1 '>0</div><a href='/pages/user/add-recipe.html' class='btn btn-primary btn-sm mt-2'><i class='fas fa-plus me-1'></i>Đăng ngay</a>`;
              recipeCountEl.setAttribute("data-bs-toggle", "tooltip");
              recipeCountEl.setAttribute("title", "Bạn chưa có công thức nào");
              // Không thêm stat-action nữa
            }
          }
          const favoriteCountEl = document.getElementById(
            "profileFavoriteCount"
          );
          if (favoriteCountEl) {
            if (user.favoriteCount && user.favoriteCount > 0) {
              favoriteCountEl.innerHTML = `<i class='fas fa-heart me-1 text-danger'></i> <span class='stat-number'>${user.favoriteCount}</span>`;
              favoriteCountEl.removeAttribute("data-bs-toggle");
              favoriteCountEl.removeAttribute("title");
              if (
                favoriteCountEl.nextElementSibling &&
                favoriteCountEl.nextElementSibling.classList.contains(
                  "stat-action"
                )
              ) {
                favoriteCountEl.nextElementSibling.remove();
              }
            } else {
              favoriteCountEl.innerHTML = `<i class='fas fa-heart fa-2x text-danger' data-bs-toggle='tooltip' title='Bạn chưa yêu thích công thức nào'></i><div class='stat-number text-muted mt-1'>0</div><a href='/pages/recipes/list.html' class='btn btn-primary btn-sm mt-2'><i class='fas fa-search me-1'></i>Khám phá</a>`;
              favoriteCountEl.setAttribute("data-bs-toggle", "tooltip");
              favoriteCountEl.setAttribute(
                "title",
                "Bạn chưa yêu thích công thức nào"
              );
              // Không thêm stat-action nữa
            }
          }
          // --- BLOG: Thêm mục Blog vào thống kê ---
          const blogCountEl = document.getElementById("profileBlogCount");
          if (blogCountEl) {
            if (user.blogCount && user.blogCount > 0) {
              blogCountEl.innerHTML = `<i class='fas fa-blog fa-2x text-danger'></i> <span class='stat-number text-muted'>${user.blogCount}</span><a href='/pages/add-blog.html' class='btn btn-primary btn-sm mt-2 d-block'><i class='fas fa-plus me-1'></i>Đăng blog</a>`;
              blogCountEl.removeAttribute("data-bs-toggle");
              blogCountEl.removeAttribute("title");
            } else {
              blogCountEl.innerHTML = `<i class='fas fa-blog fa-2x text-danger' data-bs-toggle='tooltip' title='Bạn chưa đăng blog nào'></i><div class='stat-number text-muted mt-1'>0</div><a href='/pages/add-blog.html' class='btn btn-primary btn-sm mt-2 '><i class='fas fa-plus me-1'></i>Đăng blog</a>`;
              blogCountEl.setAttribute("data-bs-toggle", "tooltip");
              blogCountEl.setAttribute("title", "Bạn chưa đăng blog nào");
            }
          }
        }
      }
      // Hiển thị công thức gần đây nhất của user trên tab Thông tin
      function renderRecentUserRecipes() {
        const user = getCurrentUser();
        if (!user) return;
        const allRecipes = getAllRecipes();
        // Lọc các công thức do user đăng (theo email hoặc id)
        const myRecipes = allRecipes.filter(
          (r) =>
            r.authorEmail === user.email ||
            r.author === user.email ||
            r.author === user.name
        );
        // Sắp xếp theo thời gian (nếu có thuộc tính date), mặc định lấy đầu danh sách
        myRecipes.sort((a, b) => {
          if (a.date && b.date) return new Date(b.date) - new Date(a.date);
          return 0;
        });
        const recent = myRecipes.slice(0, 3);
        const container = document.getElementById("recentUserRecipesRow");
        if (!container) return;
        if (recent.length === 0) {
          // KHÔNG hiển thị lại dòng "Chưa có công thức nào" và nút "Đăng công thức mới" ở đây nữa
          container.innerHTML = "";
          return;
        }
        setTimeout(() => {
          container.innerHTML = recent
            .map(
              (r) => `
            <div class=\"col-md-4\">
              <div class=\"recipe-card recent-recipe\" style=\"cursor:pointer\" data-id=\"${
                r.id
              }\">
                <img src=\"${r.image}\" alt=\"${
                r.title
              }\" class=\"recipe-image w-100\" style=\"height:160px;object-fit:cover;border-radius:10px;\">
                <div class=\"recipe-content\">
                  <h6 class=\"recipe-title mb-1\">${r.title}</h6>
                  <div class=\"recipe-meta small text-muted\">
                    <span><i class=\"fas fa-clock\"></i> ${
                      r.time || ""
                    } phút</span>
                    <span><i class=\"fas fa-star\"></i> ${r.rating || ""}</span>
                  </div>
                </div>
              </div>
            </div>
          `
            )
            .join("");
          // Thêm sự kiện click để chuyển đến trang chi tiết
          container.querySelectorAll(".recipe-card").forEach((card) => {
            card.onclick = function () {
              const id = this.getAttribute("data-id");
              if (id)
                window.location.href = `/pages/recipes/detail.html?id=${id}`;
            };
          });
          // Thêm hiệu ứng fade-in từng card
          applyFadeInToProfileCards("#recentUserRecipesRow");
        }, 400);
      }

      // Card công thức đồng bộ với trang list.html
      function renderProfileRecipeCard(recipe) {
        return `
    <div class="recipe-card w-100" data-id="${
      recipe.id
    }" style="cursor:pointer">
      <img src="${recipe.image}" class="recipe-image w-100" alt="${
          recipe.title
        }">
      <div class="recipe-info">
        <h3 class="recipe-title">${recipe.title}</h3>
        <p class="text-muted mb-2" style="min-height:38px;font-size:0.97rem;">${(() => {
          const words = (recipe.description || "").split(" ");
          return (
            words.slice(0, 20).join(" ") + (words.length > 20 ? "..." : "")
          );
        })()}</p>
        <div class="recipe-meta">
          <span><i class="fas fa-clock"></i> ${recipe.time || ""} phút</span>
          <span><i class="fas fa-star"></i> ${recipe.rating || 0}</span>
          <span><i class="fas fa-user"></i> ${recipe.author || ""}</span>
        </div>
        <div class="recipe-meta mt-2">
          <span><i class="fas fa-signal"></i> ${recipe.difficulty || ""}</span>
        </div>
        <div class="recipe-tags mt-1">
          ${(recipe.tags || [])
            .map((tag) => `<span class='recipe-tag'>${tag}</span>`)
            .join(" ")}
        </div>
      </div>
    </div>
  `;
      }

      // Hiển thị thông tin nổi bật và nội dung động trên profile
      function renderProfileHighlights() {
        const user = getCurrentUser();
        const allRecipes = getAllRecipes();
        // Lấy danh sách công thức của tôi
        const myRecipes = allRecipes.filter(
          (r) =>
            r.authorEmail === user?.email ||
            r.author === user?.email ||
            r.author === user?.name
        );
        // Lấy danh sách công thức yêu thích
        const favKey = user ? "favoriteRecipes_" + user.email : null;
        const favIds = favKey
          ? JSON.parse(localStorage.getItem(favKey) || "[]")
          : [];
        const favRecipes = allRecipes.filter((r) => favIds.includes(r.id));
        // Vùng giới thiệu mở rộng
        const bioExt = document.getElementById("profileBioExtended");
        if (bioExt) {
          bioExt.style.display = user?.bio ? "block" : "none";
          bioExt.innerHTML = user?.bio
            ? `<div class='bg-light rounded p-2 mb-2'><i class='fas fa-quote-left me-2 text-secondary'></i>${user.bio}</div>`
            : "";
        }
        // Công thức của tôi (nếu có)
        const recentRecipes = document.getElementById("profileRecentRecipes");
        if (recentRecipes) {
          setTimeout(() => {
            if (myRecipes.length > 0) {
              const show = myRecipes.slice(0, 3);
              recentRecipes.innerHTML =
                `<div class='mb-2'><strong>Công thức gần đây của bạn</strong></div><div class='row g-2'>` +
                show
                  .map(
                    (r) => `
                  <div class='col-md-4 d-flex align-items-stretch'>${renderProfileRecipeCard(
                    r
                  )}</div>
                `
                  )
                  .join("") +
                `</div><div class='mt-2'><a href='/pages/user/profile.html#tab-my-recipes' class='btn btn-link btn-sm p-0'>Xem tất cả công thức của tôi</a></div>`;
              // Sự kiện click
              recentRecipes.querySelectorAll(".recipe-card").forEach((card) => {
                card.onclick = function () {
                  const id = this.getAttribute("data-id");
                  if (id)
                    window.location.href = `/pages/recipes/detail.html?id=${id}`;
                };
              });
              // Thêm hiệu ứng fade-in từng card
              applyFadeInToProfileCards("#profileRecentRecipes .row");
            } else {
              recentRecipes.innerHTML = "";
            }
          }, 400);
        } // ...existing code...
        // Khám phá món ngon hôm nay
        const explore = document.getElementById("profileExplore");
        let exploreInterval;
        if (explore) {
          // Hiệu ứng chuyển động mượt khi đổi 4 card
          function fadeOutInExploreCards(callback) {
            const row = explore.querySelector(".row");
            if (!row) {
              callback && callback();
              return;
            }
            row.style.transition = "opacity 0.5s";
            row.style.opacity = 0;
            setTimeout(() => {
              callback && callback();
              row.style.opacity = 1;
            }, 500);
          }
          function renderExploreRandomRecipes() {
            if (!explore) return;
            const random = allRecipes
              .sort(() => 0.5 - Math.random())
              .slice(0, 4);
            // Nếu đã có row, fade out trước khi render mới
            const oldRow = explore.querySelector(".row");
            if (oldRow) {
              fadeOutInExploreCards(() => {
                explore.innerHTML =
                  `<div class='mt-3 fs-2 pb-5 text-center' style='color: #D61C4E;'><strong>Khám phá các món ngon hôm nay</strong></div><div class='row g-2'>` +
                  random
                    .map(
                      (r) => `
                  <div class='col-md-3 d-flex align-items-stretch ps-5'>${renderProfileRecipeCard(
                    r
                  )}</div>
                `
                    )
                    .join("") +
                  `</div><div class='mt-2 text-center'><a href='/pages/recipes/list.html' class='btn btn-primary btn-sm '>Xem thêm</a></div>`;
                // Sự kiện click
                explore.querySelectorAll(".recipe-card").forEach((card) => {
                  card.onclick = function () {
                    const id = this.getAttribute("data-id");
                    if (id)
                      window.location.href = `/pages/recipes/detail.html?id=${id}`;
                  };
                });
                // Hiệu ứng fade-in từng card
                applyFadeInToProfileCards("#profileExplore .row");
              });
            } else {
              // Lần đầu không cần fade
              explore.innerHTML =
                `<div class='mt-3 fs-2 pb-5 text-center' style='color: #D61C4E;'><strong>Khám phá các món ngon hôm nay</strong></div><div class='row g-2'>` +
                random
                  .map(
                    (r) => `
                <div class='col-md-3 d-flex align-items-stretch ps-5'>${renderProfileRecipeCard(
                  r
                )}</div>
              `
                  )
                  .join("") +
                `</div><div class='mt-2 text-center'><a href='/pages/recipes/list.html' class='btn btn-primary btn-sm '>Xem thêm</a></div>`;
              explore.querySelectorAll(".recipe-card").forEach((card) => {
                card.onclick = function () {
                  const id = this.getAttribute("data-id");
                  if (id)
                    window.location.href = `/pages/recipes/detail.html?id=${id}`;
                };
              });
              applyFadeInToProfileCards("#profileExplore .row");
            }
          }
          // Đảm bảo chỉ có 1 interval chạy
          if (window._exploreInterval) clearInterval(window._exploreInterval);
          renderExploreRandomRecipes();
          window._exploreInterval = setInterval(() => {
            renderExploreRandomRecipes();
          }, 3000); // 3 giây
        }
      }

      // Chuyển tab sang Cài đặt khi bấm 'Chỉnh sửa hồ sơ'
      const editProfileBtn = document.getElementById("editProfileBtn");
      if (editProfileBtn) {
        editProfileBtn.addEventListener("click", function () {
          // Kích hoạt tab Cài đặt
          document
            .querySelectorAll(".sidebar .nav-link")
            .forEach((l) => l.classList.remove("active"));
          const settingsTab = document.querySelector(
            '.sidebar .nav-link[data-tab="settings"]'
          );
          if (settingsTab) settingsTab.classList.add("active");
          document
            .querySelectorAll(".tab-section")
            .forEach((sec) => sec.classList.remove("active"));
          const settingsSection = document.getElementById("tab-settings");
          if (settingsSection) {
            settingsSection.classList.add("active");
            // Cuộn tới phần cài đặt nếu cần
            settingsSection.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
          }
        });
      }

      // Hiệu ứng chuyển động mượt cho các card công thức profile
      function animateProfileCardTransition(containerId, renderFn) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.classList.add("profile-card-fade-out");
        setTimeout(() => {
          renderFn();
          container.classList.remove("profile-card-fade-out");
          container.classList.add("profile-card-fade-in");
          setTimeout(() => {
            container.classList.remove("profile-card-fade-in");
          }, 400);
        }, 400);
      }

      // Đăng xuất từ dropdown
      const navbarLogout = document.getElementById("navbarLogout");
      if (navbarLogout) {
        navbarLogout.addEventListener("click", function (e) {
          e.preventDefault();
          sessionStorage.removeItem("currentUser");
          window.location.href = "/pages/auth/login.html";
        });
      }
      function addProfileCardTransitionOnTab(tabId, renderFn) {
        const tabBtn = document.querySelector(
          '.sidebar .nav-link[data-tab="' + tabId + '"]'
        );
        if (tabBtn) {
          tabBtn.addEventListener("click", function () {
            animateProfileCardTransition(
              tabId === "my-recipes"
                ? "myRecipeList"
                : tabId === "favorite"
                ? "favoriteRecipeList"
                : "",
              renderFn
            );
          });
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        if (typeof firebase !== "undefined" && firebase.database) {
          syncUserBlogsFromFirebase();
        } else {
          if (typeof syncUserBlogsFromStorage === "function")
            syncUserBlogsFromStorage();
        }
        renderUserInfo();
        renderProfileHighlights();
        renderRecentUserRecipes();
        renderMyRecipes();
        renderMyBlogs();
        // Đảm bảo hiệu ứng luôn chạy khi chuyển tab
        addProfileCardTransitionOnTab("my-recipes", renderMyRecipes);
        addProfileCardTransitionOnTab("favorite", renderFavoriteRecipes);
        addProfileCardTransitionOnTab("my-blogs", renderMyBlogs);
        // Render khi chuyển tab hoặc load trang
        var savedBtn = document.querySelector(
          'button[data-bs-target="#saved"]'
        );
        if (savedBtn) {
          savedBtn.addEventListener("click", renderFavoriteRecipes);
        }
        if (
          document.querySelector("#saved") &&
          document.querySelector("#saved").classList.contains("show")
        )
          renderFavoriteRecipes();
        document
          .querySelectorAll('.sidebar .nav-link[data-tab="my-recipes"]')
          .forEach(function (link) {
            link.addEventListener("click", renderMyRecipes);
          });
        document
          .querySelectorAll('.sidebar .nav-link[data-tab="my-blogs"]')
          .forEach(function (link) {
            link.addEventListener("click", renderMyBlogs);
          });
        // Xử lý chuyển tab khi bấm "Chỉnh sửa hồ sơ"
        var editBtn = document.getElementById("editProfileBtn");
        if (editBtn) {
          editBtn.addEventListener("click", function () {
            document
              .querySelectorAll(".sidebar .nav-link")
              .forEach(function (l) {
                l.classList.remove("active");
              });
            var settingsTab = document.querySelector(
              '.sidebar .nav-link[data-tab="settings"]'
            );
            if (settingsTab) settingsTab.classList.add("active");
            document.querySelectorAll(".tab-section").forEach(function (sec) {
              sec.classList.remove("active");
            });
            var settingsSection = document.getElementById("tab-settings");
            if (settingsSection) {
              settingsSection.classList.add("active");
              settingsSection.scrollIntoView({
                behavior: "smooth",
                block: "start",
              });
            }
          });
        }
      });
      // Delete recipe confirmation
      document.querySelectorAll(".delete-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          if (confirm("Bạn có chắc chắn muốn xóa công thức này?")) {
            // Add delete logic here
          }
        });
      });

      // Sidebar tab switching
      document.querySelectorAll(".sidebar .nav-link").forEach(function (link) {
        link.addEventListener("click", function () {
          document
            .querySelectorAll(".sidebar .nav-link")
            .forEach((l) => l.classList.remove("active"));
          this.classList.add("active");
          const tab = this.getAttribute("data-tab");
          document
            .querySelectorAll(".tab-section")
            .forEach((sec) => sec.classList.remove("active"));
          document.getElementById("tab-" + tab).classList.add("active");
        });
      });

      // Toast message
      function showToast(message, type = "success") {
        const toast = document.createElement("div");
        toast.className = `toast align-items-center text-bg-${
          type === "success" ? "success" : "danger"
        } border-0 show`;
        toast.role = "alert";
        toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
        document.getElementById("toastContainer").appendChild(toast);
        setTimeout(() => toast.remove(), 3500);
      }
      // Email validation
      function validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      }
      // Avatar preview & validation
      const avatarInput = document.getElementById("settingAvatar");
      const avatarPreview = document.getElementById("avatarPreview");
      if (avatarInput) {
        avatarInput.addEventListener("change", function () {
          avatarPreview.innerHTML = "";
          document.getElementById("avatarError").style.display = "none";
          const file = this.files[0];
          if (file) {
            if (!file.type.startsWith("image/")) {
              document.getElementById("avatarError").textContent =
                "Chỉ hỗ trợ file ảnh.";
              document.getElementById("avatarError").style.display = "block";
              this.value = "";
              return;
            }
            if (file.size > 2 * 1024 * 1024) {
              document.getElementById("avatarError").textContent =
                "Ảnh quá lớn (tối đa 2MB).";
              document.getElementById("avatarError").style.display = "block";
              this.value = "";
              return;
            }
            const reader = new FileReader();
            reader.onload = function (e) {
              avatarPreview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width:100px;max-height:100px;border-radius:50%">`;
            };
            reader.readAsDataURL(file);
          }
        });
      }
      // Bio char count
      const bioInput = document.getElementById("settingBio");
      const bioCharCount = document.getElementById("bioCharCount");
      if (bioInput && bioCharCount) {
        bioInput.addEventListener("input", function () {
          bioCharCount.textContent = this.value.length;
        });
      }
      // Tooltip
      var tooltipTriggerList = [].slice.call(
        document.querySelectorAll('[data-bs-toggle="tooltip"]')
      );
      tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
      });
      // Settings form submit
      const settingsForm = document.getElementById("settingsForm");
      if (settingsForm) {
        settingsForm.addEventListener("submit", function (e) {
          e.preventDefault();
          let user = getCurrentUser();
          if (!user) {
            showToast("Không tìm thấy thông tin người dùng.", "danger");
            return;
          }
          // Lấy giá trị các trường, nếu rỗng thì giữ lại giá trị cũ
          const emailInput = document.getElementById("settingEmail");
          const nameInput = document.getElementById("settingName");
          const bioInput = document.getElementById("settingBio");
          const email =
            emailInput && emailInput.value.trim()
              ? emailInput.value.trim()
              : user.email;
          const name =
            nameInput && nameInput.value.trim()
              ? nameInput.value.trim()
              : user.name;
          const bio =
            bioInput && bioInput.value.trim()
              ? bioInput.value.trim()
              : user.bio;
          const emailError = document.getElementById("emailError");
          emailError.style.display = "none";
          // Nếu user đổi email, validate, còn nếu không đổi thì bỏ qua
          if (email !== user.email && !validateEmail(email)) {
            emailError.textContent = "Email không hợp lệ.";
            emailError.style.display = "block";
            return;
          }
          // Chỉ cập nhật trường nào có thay đổi và không rỗng
          if (name && name !== user.name) user.name = name;
          if (email && email !== user.email) user.email = email;
          if (bio !== undefined && bio !== user.bio) user.bio = bio;
          // Xử lý avatar nếu có file mới
          const avatarInput = document.getElementById("settingAvatar");
          if (avatarInput && avatarInput.files && avatarInput.files[0]) {
            const file = avatarInput.files[0];
            const reader = new FileReader();
            reader.onload = function (e) {
              user.avatar = e.target.result;
              sessionStorage.setItem("currentUser", JSON.stringify(user));
              showToast("Lưu thông tin thành công!", "success");
              renderUserInfo();
            };
            reader.readAsDataURL(file);
            return; // Đợi FileReader xong mới lưu
          }
          // Nếu không đổi avatar
          sessionStorage.setItem("currentUser", JSON.stringify(user));
          showToast("Lưu thông tin thành công!", "success");
          renderUserInfo();
        });
      }
      // Đổi mật khẩu
      const changePasswordForm = document.getElementById("changePasswordForm");
      if (changePasswordForm) {
        changePasswordForm.addEventListener("submit", function (e) {
          e.preventDefault();
          const currentPassword =
            document.getElementById("currentPassword").value;
          const newPassword = document.getElementById("newPassword").value;
          const confirmNewPassword =
            document.getElementById("confirmNewPassword").value;
          const passwordError = document.getElementById("passwordError");
          passwordError.style.display = "none";
          let user = getCurrentUser();
          if (!user) {
            showToast("Không tìm thấy thông tin người dùng.", "danger");
            return;
          }
          // Nếu user chưa có password thì cho phép đổi luôn, còn có thì phải kiểm tra
          if (user.password && currentPassword !== user.password) {
            passwordError.textContent = "Mật khẩu hiện tại không đúng.";
            passwordError.style.display = "block";
            return;
          }
          if (newPassword !== confirmNewPassword) {
            passwordError.textContent = "Mật khẩu mới không khớp.";
            passwordError.style.display = "block";
            return;
          }
          if (newPassword.length < 6) {
            passwordError.textContent = "Mật khẩu mới phải từ 6 ký tự.";
            passwordError.style.display = "block";
            return;
          }
          user.password = newPassword;
          sessionStorage.setItem("currentUser", JSON.stringify(user));
          // --- Đồng bộ đổi mật khẩu vào localStorage và sessionStorage (danh sách users) ---
          let users = [];
          try {
            users = JSON.parse(localStorage.getItem("users")) || [];
          } catch {
            users = [];
          }
          // Tìm user theo email hoặc username
          const idx = users.findIndex(
            (u) =>
              (u.email && u.email === user.email) ||
              (u.username && u.username === user.username)
          );
          if (idx !== -1) {
            users[idx].password = newPassword;
            localStorage.setItem("users", JSON.stringify(users));
            sessionStorage.setItem("users", JSON.stringify(users));
          }
          showToast("Đổi mật khẩu thành công!", "success");
          // Xóa input sau khi đổi
          document.getElementById("currentPassword").value = "";
          document.getElementById("newPassword").value = "";
          document.getElementById("confirmNewPassword").value = "";
        });
      }
      function renderMyRecipes() {
        const user = getCurrentUser();
        if (!user) return;
        const allRecipes = getAllRecipes();
        const myRecipes = allRecipes.filter(
          (r) =>
            r.authorEmail === user.email ||
            r.author === user.email ||
            r.author === user.name
        );
        const container = document.getElementById("myRecipeList");
        if (!container) return;
        setTimeout(() => {
          if (!myRecipes.length) {
            container.innerHTML = `<div class='empty-state'><i class='fas fa-utensils'></i><div>Bạn chưa đăng công thức nào!</div></div>`;
          } else {
            container.innerHTML = myRecipes
              .map(
                (r) => `
    <div class=\"col-md-4\">
      <div class=\"recipe-card\" style=\"cursor:pointer\" data-id=\"${
        r.id
      }\">\n        <img src=\"${r.image}\" alt=\"${
                  r.title
                }\" class=\"recipe-image w-100\">\n        <div class=\"recipe-content\">\n          <h5 class=\"recipe-title\">${
                  r.title
                }</h5>\n          <div class=\"recipe-meta\">\n            <span><i class=\"fas fa-clock\"></i> ${
                  r.time || ""
                } phút</span>\n            <span><i class=\"fas fa-star\"></i> ${
                  r.rating || ""
                }</span>\n            <span><i class=\"fas fa-user\"></i> ${
                  r.author || ""
                }</span>\n          </div>\n        </div>\n      </div>\n    </div>\n  `
              )
              .join("");
            container.querySelectorAll(".recipe-card").forEach((card) => {
              card.onclick = function () {
                const id = this.getAttribute("data-id");
                if (id)
                  window.location.href = `/pages/recipes/detail.html?id=${id}`;
              };
            });
            // Thêm hiệu ứng fade-in từng card
            applyFadeInToProfileCards("#myRecipeList");
          }
        }, 400);
      }
      function renderMyBlogs() {
        const user = getCurrentUser();
        const container = document.getElementById("myBlogList");
        if (!container) return;
        // Giả sử user.blogs là mảng các blog đã đăng, nếu chưa có thì để []
        const blogs = user && user.blogs ? user.blogs : [];
        setTimeout(() => {
          if (!blogs.length) {
            container.innerHTML = `<div class='empty-state'><i class='fas fa-blog'></i><div>Bạn chưa đăng blog nào!</div><a href='/pages/add-blog.html'`;
          } else {
            container.innerHTML = blogs
              .map(
                (post) => `
      <div class="col-md-3 mb-4" data-aos="fade-up">
        <a href="/pages/blog-detail.html?id=${
          post.id
        }" class="blog-card d-block" data-id="${post.id}">
          <img src="${post.image}" class="blog-image w-100" alt="${post.title}">
          <div class="blog-content">
            <h3 class="blog-title">${post.title}</h3>
            <div class="blog-meta">
              <span><i class="fas fa-user"></i> ${post.author}</span>
              <span><i class="far fa-calendar"></i> ${post.date}</span>
              <span><i class="far fa-clock"></i> ${post.readTime}</span>
            </div>
            <p class="blog-excerpt">${post.excerpt}</p>
            <div class="blog-tags">
              ${(post.tags || [])
                .map((tag) => `<span class="blog-tag">${tag}</span>`)
                .join("")}
            </div>
          </div>
        </a>
      </div>
    `
              )
              .join("");
            // Sự kiện click vào card để chuyển đến trang chi tiết blog (nếu cần fallback cho mobile)
            container.querySelectorAll(".blog-card").forEach((card) => {
              card.onclick = function (e) {
                // Nếu click vào thẻ a thì không cần xử lý
                if (e.target.tagName === "A") return;
                const id = this.getAttribute("data-id");
                if (id)
                  window.location.href = `/pages/blog-detail.html?id=${id}`;
              };
            });
          }
          // Thêm hiệu ứng fade-in từng card nếu muốn
          applyFadeInToProfileCards &&
            applyFadeInToProfileCards("#myBlogList", ".blog-card");
        }, 400);
      }

      /**
       * Thêm hiệu ứng fade-in từng card với delay (staggered)
       * @param {string} containerSelector - selector của container chứa các card
       * @param {string} cardSelector - selector của card, mặc định là .recipe-card
       */
      function applyFadeInToProfileCards(
        containerSelector,
        cardSelector = ".recipe-card"
      ) {
        const container = document.querySelector(containerSelector);
        if (!container) return;
        const cards = container.querySelectorAll(cardSelector);
        cards.forEach((card, idx) => {
          card.classList.remove(
            "profile-card-fade-in",
            "profile-card-fade-out"
          );
          card.style.opacity = 0;
          card.style.transform = "translateY(30px) scale(0.98)";
          setTimeout(() => {
            card.classList.add("profile-card-fade-in");
            card.style.transitionDelay = idx * 80 + "ms";
            card.style.opacity = 1;
            card.style.transform = "translateY(0) scale(1)";
            // Xóa delay sau khi xong để tránh ảnh hưởng hover
            setTimeout(() => {
              card.style.transitionDelay = "";
            }, 500 + idx * 80);
          }, idx * 80);
        });
      }

      // Thêm CSS hiệu ứng fade cho .row trong #profileExplore và đảm bảo gọi lại renderProfileHighlights khi chuyển tab Thông tin để hiệu ứng auto-slide hoạt động.
      const style = document.createElement("style");
      style.innerHTML = `
  #profileExplore .row {
    transition: opacity 0.5s;
  }
`;
      document.head.appendChild(style);

      // Đảm bảo gọi lại renderProfileHighlights khi chuyển tab Thông tin
      const tabProfileInfoBtn = document.querySelector(
        '.sidebar .nav-link[data-tab="profile-info"]'
      );
      if (tabProfileInfoBtn) {
        tabProfileInfoBtn.addEventListener("click", function () {
          renderProfileHighlights();
        });
      }

      function syncUserBlogsFromStorage() {
        const user = getCurrentUser();
        if (!user) return;
        let allBlogs = [];
        try {
          allBlogs = JSON.parse(localStorage.getItem("blogPosts")) || [];
        } catch {
          allBlogs = [];
        }
        // Lọc blog của user hiện tại (theo email hoặc tên)
        const myBlogs = allBlogs.filter(
          (b) =>
            b.authorEmail === user.email ||
            b.author === user.email ||
            b.author === user.name
        );
        user.blogs = myBlogs;
        sessionStorage.setItem("currentUser", JSON.stringify(user));
      }

      function normalizeString(str) {
        return (str || "").toLowerCase().replace(/\s+/g, "").replace(/-/g, "");
      }
      function syncUserBlogsFromFirebase() {
        console.log("[DEBUG] syncUserBlogsFromFirebase called");
        const user = getCurrentUser();
        console.log("[DEBUG] user:", user);
        console.log("[DEBUG] typeof firebase:", typeof firebase);
        console.log(
          "[DEBUG] firebase.database:",
          firebase && firebase.database
        );
        if (!user || typeof firebase === "undefined" || !firebase.database) {
          console.log(
            "[DEBUG] Điều kiện return sớm trong syncUserBlogsFromFirebase"
          );
          return;
        }
        // Đảm bảo user luôn có trường name
        if (!user.name) user.name = user.username;
        // Tạo mảng so sánh, loại bỏ undefined/null
        const userNames = [user.username, user.name, user.email]
          .filter(Boolean)
          .map(normalizeString);
        const userNamesRaw = [user.username, user.name, user.email].filter(
          Boolean
        );
        firebase
          .database()
          .ref("blogs")
          .once("value")
          .then((snapshot) => {
            const blogsObj = snapshot.val() || {};
            const allBlogs = Object.values(blogsObj);
            // Debug: log thông tin user và author các blog
            console.log("User:", user);
            allBlogs.forEach((b) => {
              console.log(
                "Blog:",
                b.title,
                "| author:",
                b.author,
                "| authorEmail:",
                b.authorEmail,
                "| So sánh normalize:",
                normalizeString(b.author),
                normalizeString(b.authorEmail),
                userNames,
                "| So sánh gốc:",
                b.author,
                b.authorEmail,
                userNamesRaw
              );
            });
            // Lọc blog của user hiện tại (theo author hoặc authorEmail, chỉ lấy blog đã duyệt)
            const myBlogs = allBlogs.filter(
              (b) =>
                b &&
                (!b.status || b.status === "đã duyệt") &&
                ((b.author && userNames.includes(normalizeString(b.author))) ||
                  (b.authorEmail &&
                    userNames.includes(normalizeString(b.authorEmail))) ||
                  (b.author && userNamesRaw.includes(b.author)) ||
                  (b.authorEmail && userNamesRaw.includes(b.authorEmail)))
            );
            user.blogs = myBlogs;
            user.blogCount = myBlogs.length;
            sessionStorage.setItem("currentUser", JSON.stringify(user));
            renderUserInfo();
            renderMyBlogs();
          });
      }
    </script>
  </body>
</html>
